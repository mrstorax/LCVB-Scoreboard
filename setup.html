<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Initialisation du Match - LCVB Scoreboard</title>
    <link rel="stylesheet" href="shared-style.css">
    <style>
        /* Styles sp√©cifiques setup */
        .setup-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--app-spacing-xl);
            padding: var(--app-spacing-lg);
            background: var(--app-bg-secondary);
            border-radius: var(--app-radius-lg);
            border: 1px solid var(--app-border);
        }
        
        .progress-step {
            flex: 1;
            text-align: center;
            padding: var(--app-spacing-md);
            position: relative;
        }
        
        .progress-step::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            width: 100%;
            height: 2px;
            background: var(--app-border);
            z-index: -1;
        }
        
        .progress-step:last-child::after {
            display: none;
        }
        
        .progress-step.active .step-number {
            background: var(--app-accent);
            color: white;
        }
        
        .progress-step.completed .step-number {
            background: var(--app-success);
            color: white;
        }
        
        .step-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            border-radius: 50%;
            background: var(--app-bg-tertiary);
            color: var(--app-text-muted);
            font-weight: 600;
            margin-bottom: var(--app-spacing-xs);
        }
        
        .step-label {
            font-size: 0.875rem;
            color: var(--app-text-secondary);
        }
        
        .setup-section {
            display: none;
        }
        
        .setup-section.active {
            display: block;
        }
        
        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--app-spacing-md);
            margin-top: var(--app-spacing-md);
        }
        
        .player-card {
            background: var(--app-bg-tertiary);
            border-radius: var(--app-radius);
            padding: var(--app-spacing-md);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .player-card:hover {
            border-color: var(--app-border-hover);
        }
        
        .player-card.selected {
            border-color: var(--app-accent);
            background: var(--app-accent-light);
        }
        
        .player-card.captain {
            border-color: var(--app-warning);
        }
        
        .player-number {
            display: inline-block;
            width: 32px;
            height: 32px;
            line-height: 32px;
            text-align: center;
            border-radius: 50%;
            background: var(--app-accent);
            color: white;
            font-weight: 600;
            margin-bottom: var(--app-spacing-xs);
        }
        
        .player-name {
            font-weight: 500;
            color: var(--app-text-primary);
            margin-bottom: 0.25rem;
        }
        
        .player-position {
            font-size: 0.75rem;
            color: var(--app-text-secondary);
        }
        
        .badge {
            display: inline-block;
            padding: 0.35em 0.65em;
            font-size: 0.875rem;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            border-radius: var(--app-radius);
        }
        
        .badge-primary {
            background: var(--app-primary);
            color: white;
        }
        
        .opponent-player-input {
            display: flex;
            gap: var(--app-spacing-sm);
            margin-bottom: var(--app-spacing-sm);
        }
        
        .opponent-player-input input {
            flex: 1;
        }
        
        .opponent-player-input button {
            padding: var(--app-spacing-sm);
        }
        
        .setup-actions {
            display: flex;
            justify-content: space-between;
            margin-top: var(--app-spacing-xl);
            padding-top: var(--app-spacing-lg);
            border-top: 1px solid var(--app-border);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--app-spacing-md);
        }
        
        .selected-players {
            margin-top: var(--app-spacing-md);
            padding: var(--app-spacing-md);
            background: var(--app-success-light);
            border-radius: var(--app-radius);
            border: 1px solid var(--app-success);
        }
        
        .selected-count {
            font-weight: 600;
            color: var(--app-success);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Navigation -->
        <nav class="app-nav">
            <a href="home.html" class="app-nav-brand">
                üèê LCVB Scoreboard Pro
            </a>
            <ul class="app-nav-links">
                <li><a href="setup.html" class="app-nav-link active">Initialisation</a></li>
                <li><a href="control.html" class="app-nav-link">Suivi Live</a></li>
                <li><a href="stats.html" class="app-nav-link">Statistiques</a></li>
                <li><a href="dashboard.html" class="app-nav-link">Dashboard</a></li>
            </ul>
        </nav>
        
        <!-- En-t√™te -->
        <div class="app-header">
            <h1 class="app-title">‚öôÔ∏è Initialisation du Match</h1>
            <p class="app-subtitle">Configuration compl√®te avant le d√©but de la rencontre</p>
        </div>
        
        <!-- Progression -->
        <div class="setup-progress">
            <div class="progress-step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">Informations</div>
            </div>
            <div class="progress-step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">Joueurs pr√©sents</div>
            </div>
            <div class="progress-step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">√âquipe adverse</div>
            </div>
            <div class="progress-step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-label">Options</div>
            </div>
        </div>
        
        <!-- Section 1: Informations g√©n√©rales -->
        <div class="setup-section active" id="section-1">
            <div class="card">
                <h2 class="card-title">üìã Informations g√©n√©rales du match</h2>
                
                <div class="form-group">
                    <label class="form-label">üèê √âquipe du club qui joue</label>
                    <select id="team-selector" class="form-select" onchange="loadTeamPlayers()" required>
                        <option value="">-- S√©lectionner l'√©quipe --</option>
                        <optgroup label="üë® Seniors Masculins">
                            <option value="pma">PMA - Pr√©national Masculine (5√®me)</option>
                            <option value="rm2">RM2 - R√©gionale 2 Masculine (2√®me)</option>
                        </optgroup>
                        <optgroup label="üë© Seniors F√©minins">
                            <option value="pfa">PFA - Pr√©national F√©minine (6√®me)</option>
                            <option value="n3f">N3F - Nationale 3 F√©minine</option>
                            <option value="rf2">RF2 - R√©gionale 2 F√©minine (9√®me)</option>
                        </optgroup>
                        <optgroup label="üë¶ Jeunes Masculins">
                            <option value="cma">CMA - Cadets M18 (2√®me)</option>
                            <option value="mmb">MMB - Minimes Masculins (6√®me)</option>
                            <option value="bmb">BMB - Benjamins (3√®me)</option>
                        </optgroup>
                        <optgroup label="üëß Jeunes F√©minines">
                            <option value="cfd">CFD - Cadettes (3√®me)</option>
                            <option value="mfd">MFD - Minimes F√©minines (2√®me)</option>
                            <option value="bfc">BFC - Benjamines (3√®me)</option>
                        </optgroup>
                        <optgroup label="üéØ Loisirs">
                            <option value="l6a">L6A - Loisir 6x6 (4√®me)</option>
                        </optgroup>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Type de rencontre</label>
                        <select id="match-type" class="form-select">
                            <option value="championnat">Championnat</option>
                            <option value="coupe">Coupe</option>
                            <option value="amical">Match amical</option>
                            <option value="tournoi">Tournoi</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Division affich√©e</label>
                        <input type="text" id="division" class="form-input" placeholder="Auto-rempli selon l'√©quipe" readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date du match</label>
                        <input type="date" id="match-date" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Heure du match</label>
                        <input type="time" id="match-time" class="form-input" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Lieu</label>
                        <select id="match-location-type" class="form-select">
                            <option value="domicile">Domicile</option>
                            <option value="exterieur">Ext√©rieur</option>
                            <option value="neutre">Terrain neutre</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nom du gymnase / Salle</label>
                        <input type="text" id="venue-name" class="form-input" placeholder="Ex: Salle Le Cr√®s" value="Salle Le Cr√®s">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Arbitre principal</label>
                        <input type="text" id="referee-1" class="form-input" placeholder="Nom de l'arbitre">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Arbitre adjoint</label>
                        <input type="text" id="referee-2" class="form-input" placeholder="Nom de l'arbitre adjoint">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Observateur / D√©l√©gu√© (optionnel)</label>
                    <input type="text" id="observer" class="form-input" placeholder="Nom de l'observateur">
                </div>
            </div>
        </div>
        
        <!-- Section 2: Joueurs pr√©sents -->
        <div class="setup-section" id="section-2">
            <div class="card">
                <h2 class="card-title" id="team-title-step2">üè† Joueurs pr√©sents</h2>
                
                <div class="alert alert-success mb-lg">
                    <strong>‚úÖ Tous les joueurs sont s√©lectionn√©s par d√©faut</strong><br>
                    D√©cochez uniquement les joueurs ABSENTS pour ce match.
                </div>
                
                <div class="selected-players" id="home-selected-info">
                    <span class="selected-count">12 joueurs pr√©sents</span>
                </div>
                
                <div class="players-grid" id="home-players-grid">
                    <!-- G√©n√©r√© dynamiquement -->
                </div>
                
                <div class="form-group mt-lg">
                    <label class="form-label">Coach / Entra√Æneur</label>
                    <input type="text" id="home-coach" class="form-input" placeholder="Nom de l'entra√Æneur">
                </div>
            </div>
        </div>
        
        <!-- Section 3: √âquipe adverse -->
        <div class="setup-section" id="section-3">
            <div class="card">
                <h2 class="card-title">üë• √âquipe adverse</h2>
                
                <div class="form-group mb-lg">
                    <label class="form-label">Nom du club</label>
                    <input type="text" id="away-team-name" class="form-input" placeholder="Ex: Montpellier VUC" required>
                </div>
                
                <div class="form-group mb-lg">
                    <label class="form-label">Logo de l'√©quipe (optionnel)</label>
                    <input type="file" id="away-team-logo" class="form-input" accept="image/*">
                    <small style="color: var(--app-text-muted); display: block; margin-top: 0.25rem;">
                        Formats accept√©s : PNG, JPG, SVG
                    </small>
                </div>
                
                <h3 style="margin: var(--app-spacing-lg) 0 var(--app-spacing-md) 0; color: var(--app-text-primary);">Num√©ros des joueurs adverses</h3>
                
                <div class="alert alert-info mb-lg">
                    <strong>‚ö° Saisie rapide</strong><br>
                    Saisissez les num√©ros de maillot s√©par√©s par des espaces ou des virgules.<br>
                    Exemple : <code>4 7 9 11 12 15 18 21 23 25</code>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Num√©ros de maillot</label>
                    <textarea id="away-players-numbers" class="form-input" rows="3" placeholder="4, 7, 9, 11, 12, 15, 18, 21, 23, 25, 27, 30" style="font-family: 'Monaco', monospace; font-size: 1.1em;" oninput="parseAwayNumbers()"></textarea>
                    <small style="color: var(--app-text-muted); display: block; margin-top: 0.5rem;">
                        S√©parez les num√©ros par des espaces, virgules ou retours √† la ligne
                    </small>
                </div>
                
                <div id="away-numbers-preview" style="padding: var(--app-spacing-md); background: var(--app-success-light); border-radius: var(--app-radius); border: 1px solid var(--app-success); margin-top: var(--app-spacing-md); display: none;">
                    <strong style="color: var(--app-success);">‚úì <span id="away-count">0</span> joueurs d√©tect√©s</strong>
                    <div id="away-badges" style="display: flex; flex-wrap: wrap; gap: var(--app-spacing-xs); margin-top: var(--app-spacing-sm);"></div>
                </div>
                
                <div class="form-group mt-lg">
                    <label class="form-label">Coach / Entra√Æneur</label>
                    <input type="text" id="away-coach" class="form-input" placeholder="Nom de l'entra√Æneur">
                </div>
            </div>
        </div>
        
        <!-- Section 4: Options techniques -->
        <div class="setup-section" id="section-4">
            <div class="card">
                <h2 class="card-title">‚öôÔ∏è Options techniques</h2>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: var(--app-spacing-sm); cursor: pointer;">
                        <input type="checkbox" id="enable-streaming" class="form-checkbox">
                        <strong>Activer la diffusion en direct (OBS/Streaming)</strong>
                    </label>
                    <small style="color: var(--app-text-muted); display: block; margin-top: 0.25rem; margin-left: 26px;">
                        Affichage optimis√© pour OBS, Twitch, YouTube
                    </small>
                </div>
                
                <div class="form-group mt-lg">
                    <label class="form-label">URL du stream (optionnel)</label>
                    <input type="url" id="stream-url" class="form-input" placeholder="https://...">
                </div>
                
                <h3 style="margin: var(--app-spacing-lg) 0 var(--app-spacing-md) 0; color: var(--app-text-primary);">Sponsors √† afficher</h3>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: var(--app-spacing-sm); cursor: pointer;">
                        <input type="checkbox" class="form-checkbox" checked>
                        <span>Sponsor principal</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: var(--app-spacing-sm); cursor: pointer;">
                        <input type="checkbox" class="form-checkbox" checked>
                        <span>Sponsors secondaires</span>
                    </label>
                </div>
                
                <h3 style="margin: var(--app-spacing-lg) 0 var(--app-spacing-md) 0; color: var(--app-text-primary);">Mode de saisie des statistiques</h3>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: var(--app-spacing-sm); cursor: pointer;">
                        <input type="radio" name="stats-mode" value="complete" checked>
                        <strong>Statistiques compl√®tes</strong>
                    </label>
                    <small style="color: var(--app-text-muted); display: block; margin-top: 0.25rem; margin-left: 26px;">
                        Enregistrement d√©taill√© de toutes les actions (attaques, services, blocs, etc.)
                    </small>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: var(--app-spacing-sm); cursor: pointer;">
                        <input type="radio" name="stats-mode" value="simplified">
                        <strong>Statistiques simplifi√©es</strong>
                    </label>
                    <small style="color: var(--app-text-muted); display: block; margin-top: 0.25rem; margin-left: 26px;">
                        Saisie rapide des actions principales uniquement
                    </small>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: var(--app-spacing-sm); cursor: pointer;">
                        <input type="radio" name="stats-mode" value="none">
                        <strong>Scores uniquement</strong>
                    </label>
                    <small style="color: var(--app-text-muted); display: block; margin-top: 0.25rem; margin-left: 26px;">
                        Pas de statistiques d√©taill√©es, juste le scoreboard
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Actions de navigation -->
        <div class="setup-actions">
            <button class="btn btn-secondary" id="btn-previous" onclick="previousStep()" style="display: none;">
                ‚Üê Pr√©c√©dent
            </button>
            <div style="flex: 1;"></div>
            <button class="btn btn-secondary" onclick="saveAsDraft()">
                üíæ Enregistrer brouillon
            </button>
            <button class="btn btn-primary" id="btn-next" onclick="nextStep()">
                Suivant ‚Üí
            </button>
            <button class="btn btn-success" id="btn-launch" onclick="launchMatch()" style="display: none;">
                üöÄ Lancer le match
            </button>
        </div>
    </div>
    
    <script>
        // √âtat global
        let currentStep = 1;
        let allTeamsData = null; // Toutes les √©quipes du club
        let selectedTeamData = null; // √âquipe s√©lectionn√©e
        let selectedPlayers = []; // IDs des joueurs PR√âSENTS (tous par d√©faut)
        let awayNumbers = []; // Num√©ros adverses
        
        // Charger toutes les √©quipes
        async function loadTeamsData() {
            try {
                const response = await fetch('data/teams.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allTeamsData = await response.json();
                console.log('‚úÖ √âquipes charg√©es:', allTeamsData.teams.length, '√©quipes');
            } catch (error) {
                console.error('‚ùå Erreur chargement √©quipes:', error);
                alert('Erreur lors du chargement des √©quipes du club: ' + error.message);
            }
        }
        
        // Charger les joueurs de l'√©quipe s√©lectionn√©e
        function loadTeamPlayers() {
            console.log('üîÑ loadTeamPlayers appel√©');
            const teamId = document.getElementById('team-selector').value;
            console.log('Team ID s√©lectionn√©:', teamId);
            
            if (!teamId) {
                console.log('‚ö†Ô∏è Aucune √©quipe s√©lectionn√©e');
                return;
            }
            
            if (!allTeamsData) {
                console.log('‚ùå allTeamsData n\'est pas charg√© !');
                alert('Les donn√©es des √©quipes ne sont pas encore charg√©es. Veuillez rafra√Æchir la page.');
                return;
            }
            
            // Trouver l'√©quipe
            selectedTeamData = allTeamsData.teams.find(t => t.id === teamId);
            console.log('√âquipe trouv√©e:', selectedTeamData ? selectedTeamData.name : 'NON TROUV√âE');
            
            if (!selectedTeamData) {
                console.log('‚ùå √âquipe non trouv√©e dans les donn√©es');
                return;
            }
            
            // Mettre √† jour la division
            document.getElementById('division').value = selectedTeamData.division;
            
            // Tous les joueurs sont s√©lectionn√©s PAR D√âFAUT (sauf si d√©j√† d√©fini = brouillon)
            if (selectedPlayers.length === 0) {
                selectedPlayers = selectedTeamData.players.map(p => p.id);
                console.log('‚úÖ Joueurs charg√©s:', selectedPlayers.length, 'joueurs (tous pr√©sents par d√©faut)');
            } else {
                console.log('‚úÖ Joueurs d√©j√† d√©finis:', selectedPlayers.length, 'joueurs (brouillon ou pr√©c√©dent)');
            }
            
            // Afficher les joueurs
            renderHomePlayers();
            
            // Mettre √† jour le coach si d√©fini
            if (selectedTeamData.staff && selectedTeamData.staff.length > 0) {
                document.getElementById('home-coach').value = selectedTeamData.staff[0].name;
            }
            
            // Mettre √† jour le titre
            document.getElementById('team-title-step2').textContent = `üè† ${selectedTeamData.name}`;
        }
        
        // Afficher les joueurs du club - TOUS S√âLECTIONN√âS PAR D√âFAUT
        function renderHomePlayers() {
            console.log('üé® renderHomePlayers appel√©');
            if (!selectedTeamData) {
                console.log('‚ùå selectedTeamData est null');
                return;
            }
            
            const grid = document.getElementById('home-players-grid');
            if (!grid) {
                console.log('‚ùå √âl√©ment home-players-grid non trouv√© dans le DOM');
                return;
            }
            
            console.log('Rendu de', selectedTeamData.players.length, 'joueurs');
            grid.innerHTML = selectedTeamData.players.map(player => `
                <div class="player-card selected ${player.captain ? 'captain' : ''}" onclick="togglePlayer(${player.id})" data-player-id="${player.id}">
                    <div class="player-number">${player.number}</div>
                    <div class="player-name">${player.firstName} ${player.lastName}</div>
                    <div class="player-position">${player.position}${player.captain ? ' (C)' : ''}${player.libero ? ' (L)' : ''}</div>
                </div>
            `).join('');
            console.log('‚úÖ HTML g√©n√©r√© et ins√©r√© dans la grille');
            updateSelectedCount();
        }
        
        // LOGIQUE INVERS√âE : Cliquer RETIRE le joueur
        function togglePlayer(playerId) {
            const card = document.querySelector(`[data-player-id="${playerId}"]`);
            const index = selectedPlayers.indexOf(playerId);
            
            if (index > -1) {
                // Le joueur est pr√©sent ‚Üí le retirer (absent)
                selectedPlayers.splice(index, 1);
                card.classList.remove('selected');
            } else {
                // Le joueur est absent ‚Üí le remettre (pr√©sent)
                selectedPlayers.push(playerId);
                card.classList.add('selected');
            }
            
            updateSelectedCount();
        }
        
        // Mettre √† jour le compteur
        function updateSelectedCount() {
            const info = document.getElementById('home-selected-info');
            const count = selectedPlayers.length;
            info.innerHTML = `<span class="selected-count">${count} joueur${count > 1 ? 's' : ''} pr√©sent${count > 1 ? 's' : ''}</span>`;
        }
        
        // Charger les dropdowns de positionnement (√âtape 4)
        // Fonction supprim√©e : loadPositioningDropdowns (positionnement fait dans control.html)
        
        // Parser les num√©ros adverses depuis le textarea
        function parseAwayNumbers() {
            const textarea = document.getElementById('away-players-numbers');
            const input = textarea.value;
            
            // Extraire tous les nombres (s√©par√©s par espaces, virgules, retours √† la ligne, etc.)
            const numbers = input.match(/\d+/g);
            
            if (numbers && numbers.length > 0) {
                // Convertir en entiers et enlever doublons
                awayNumbers = [...new Set(numbers.map(n => parseInt(n)))].sort((a, b) => a - b);
                
                // Afficher l'aper√ßu
                const preview = document.getElementById('away-numbers-preview');
                const count = document.getElementById('away-count');
                const badges = document.getElementById('away-badges');
                
                count.textContent = awayNumbers.length;
                badges.innerHTML = awayNumbers.map(n => 
                    `<span class="badge badge-primary">#${n}</span>`
                ).join('');
                
                preview.style.display = 'block';
            } else {
                // Cacher l'aper√ßu si vide
                document.getElementById('away-numbers-preview').style.display = 'none';
                awayNumbers = [];
            }
        }
        
        // Navigation entre √©tapes
        function nextStep() {
            if (!validateCurrentStep()) return;
            
            currentStep++;
            updateStepDisplay();
        }
        
        function previousStep() {
            currentStep--;
            updateStepDisplay();
        }
        
        function updateStepDisplay() {
            // Masquer toutes les sections
            document.querySelectorAll('.setup-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Afficher la section active
            document.getElementById(`section-${currentStep}`).classList.add('active');
            
            // Mettre √† jour la progression
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < currentStep) {
                    step.classList.add('completed');
                } else if (index + 1 === currentStep) {
                    step.classList.add('active');
                }
            });
            
            // G√©rer les boutons - 4 √©tapes maintenant
            document.getElementById('btn-previous').style.display = currentStep > 1 ? 'block' : 'none';
            document.getElementById('btn-next').style.display = currentStep < 4 ? 'block' : 'none';
            document.getElementById('btn-launch').style.display = currentStep === 4 ? 'block' : 'none';
            
            // Scroll vers le haut
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Validation
        function validateCurrentStep() {
            switch(currentStep) {
                case 1:
                    const teamId = document.getElementById('team-selector').value;
                    if (!teamId) {
                        alert('Veuillez s√©lectionner l\'√©quipe qui joue');
                        return false;
                    }
                    const date = document.getElementById('match-date').value;
                    const time = document.getElementById('match-time').value;
                    if (!date || !time) {
                        alert('Veuillez renseigner la date et l\'heure du match');
                        return false;
                    }
                    return true;
                    
                case 2:
                    if (selectedPlayers.length < 6) {
                        alert('Il doit y avoir au moins 6 joueurs pr√©sents');
                        return false;
                    }
                    return true;
                    
                case 3:
                    const awayName = document.getElementById('away-team-name').value;
                    if (!awayName) {
                        alert('Veuillez saisir le nom de l\'√©quipe adverse');
                        return false;
                    }
                    if (awayNumbers.length < 6) {
                        alert('Veuillez saisir au moins 6 num√©ros de joueurs adverses');
                        return false;
                    }
                    return true;
                    
                case 4:
                    // √âtape 4 : Options (pas de validation requise)
                    return true;
            }
        }
        
        // Sauvegarder en brouillon
        function saveAsDraft() {
            const matchData = collectMatchData();
            localStorage.setItem('lcvb_match_draft', JSON.stringify(matchData));
            alert('Brouillon sauvegard√© avec succ√®s !');
        }
        
        // Collecter toutes les donn√©es
        function collectMatchData() {
            if (!selectedTeamData) return null;
            
            return {
                general: {
                    teamId: selectedTeamData.id,
                    teamName: selectedTeamData.name,
                    type: document.getElementById('match-type').value,
                    division: document.getElementById('division').value,
                    date: document.getElementById('match-date').value,
                    time: document.getElementById('match-time').value,
                    locationType: document.getElementById('match-location-type').value,
                    venue: document.getElementById('venue-name').value,
                    referee1: document.getElementById('referee-1').value,
                    referee2: document.getElementById('referee-2').value,
                    observer: document.getElementById('observer').value
                },
                homeTeam: {
                    id: selectedTeamData.id,
                    name: selectedTeamData.name,
                    shortName: selectedTeamData.shortName,
                    clubName: allTeamsData.clubName || 'Le Cr√®s Volley-Ball', // Nom du club
                    allPlayers: selectedTeamData.players, // TOUS les joueurs de l'√©quipe
                    presentPlayers: selectedTeamData.players.filter(p => selectedPlayers.includes(p.id)), // Joueurs pr√©sents
                    coach: document.getElementById('home-coach').value
                },
                // Sauvegarder les s√©lections pour la restauration
                selections: {
                    selectedPlayers: [...selectedPlayers], // IDs des joueurs s√©lectionn√©s
                    awayNumbers: [...awayNumbers] // Num√©ros adverses
                },
                awayTeam: {
                    name: document.getElementById('away-team-name').value,
                    numbers: awayNumbers, // Garder les num√©ros
                    players: awayNumbers.map(num => ({ number: num, name: `Joueur #${num}` })),
                    coach: document.getElementById('away-coach').value
                },
                options: {
                    streaming: document.getElementById('enable-streaming').checked,
                    streamUrl: document.getElementById('stream-url').value,
                    statsMode: document.querySelector('input[name="stats-mode"]:checked')?.value || 'complete'
                },
                timestamp: new Date().toISOString()
            };
        }
        
        // Lancer le match
        function launchMatch() {
            if (!validateCurrentStep()) return;
            
            const matchData = collectMatchData();
            
            // Sauvegarder dans localStorage (temporaire avant IndexedDB)
            localStorage.setItem('lcvb_current_match', JSON.stringify(matchData));
            
            // Mettre √† jour les donn√©es du scoreboard existant
            const scoreData = {
                team1: {
                    name: matchData.homeTeam.name,
                    score: 0,
                    sets: [0, 0, 0, 0, 0],
                    niveau: matchData.general.division
                },
                team2: {
                    name: matchData.awayTeam.name,
                    score: 0,
                    sets: [0, 0, 0, 0, 0],
                    niveau: matchData.general.division
                },
                currentSet: 1,
                maxSets: 5,
                matchInfo: {
                    date: matchData.general.date,
                    time: matchData.general.time,
                    location: matchData.general.venue,
                    competition: matchData.general.type,
                    referee: matchData.general.referee1
                }
            };
            
            localStorage.setItem('lcvb_score', JSON.stringify(scoreData));
            
            // Rediriger vers le contr√¥le
            if (confirm('Match initialis√© avec succ√®s ! Ouvrir l\'interface de contr√¥le ?')) {
                window.location.href = 'control.html';
            }
        }
        
        // Initialisation
        window.addEventListener('DOMContentLoaded', async () => {
            await loadTeamsData();
            
            // D√©finir la date/heure par d√©faut
            const now = new Date();
            document.getElementById('match-date').valueAsDate = now;
            document.getElementById('match-time').value = now.toTimeString().substring(0, 5);
            
            // Charger le brouillon si existant
            const draft = localStorage.getItem('lcvb_match_draft');
            if (draft) {
                try {
                    const draftData = JSON.parse(draft);
                    const draftDate = new Date(draftData.timestamp);
                    const message = `Un brouillon existe (${draftDate.toLocaleDateString()} ${draftDate.toLocaleTimeString()})\n\nVoulez-vous le charger ?`;
                    
                    if (confirm(message)) {
                        loadDraft(draftData);
                    }
                } catch (e) {
                    console.error('Erreur chargement brouillon:', e);
                }
            }
        });
        
        // Charger un brouillon complet
        async function loadDraft(draftData) {
            console.log('üì• Chargement du brouillon...', draftData);
            
            // 1. Charger l'√©quipe correspondante
            if (draftData.homeTeam && draftData.homeTeam.id) {
                // S'assurer que les √©quipes sont charg√©es
                if (!allTeamsData) {
                    await loadTeamsData();
                }
                
                // Trouver l'√©quipe dans allTeamsData.teams
                const teamToLoad = allTeamsData.teams.find(t => t.id === draftData.homeTeam.id);
                if (teamToLoad) {
                    selectedTeamData = teamToLoad;
                    document.getElementById('team-selector').value = teamToLoad.id;
                    console.log('  ‚úÖ √âquipe charg√©e:', teamToLoad.name);
                } else {
                    console.error('  ‚ùå √âquipe non trouv√©e:', draftData.homeTeam.id);
                }
            }
            
            // 2. Restaurer les informations g√©n√©rales (√âtape 1)
            if (draftData.general) {
                document.getElementById('match-type').value = draftData.general.type || '';
                document.getElementById('division').value = draftData.general.division || '';
                document.getElementById('match-date').value = draftData.general.date || '';
                document.getElementById('match-time').value = draftData.general.time || '';
                document.getElementById('match-location-type').value = draftData.general.locationType || 'home';
                document.getElementById('venue-name').value = draftData.general.venue || '';
                document.getElementById('referee-1').value = draftData.general.referee1 || '';
                document.getElementById('referee-2').value = draftData.general.referee2 || '';
                document.getElementById('observer').value = draftData.general.observer || '';
                console.log('  ‚úÖ Infos g√©n√©rales restaur√©es');
            }
            
            // 3. Restaurer la s√©lection des joueurs (√âtape 2)
            if (draftData.selections && draftData.selections.selectedPlayers) {
                // IMPORTANT : Restaurer selectedPlayers AVANT loadTeamPlayers()
                selectedPlayers = [...draftData.selections.selectedPlayers];
                console.log('  üìå selectedPlayers restaur√©:', selectedPlayers.length);
                
                // Recharger l'affichage des joueurs (ne va PAS √©craser selectedPlayers)
                loadTeamPlayers();
                console.log('  ‚úÖ Joueurs s√©lectionn√©s affich√©s');
            }
            
            // 4. Restaurer l'√©quipe adverse (√âtape 3)
            if (draftData.awayTeam) {
                document.getElementById('away-team-name').value = draftData.awayTeam.name || '';
                document.getElementById('away-coach').value = draftData.awayTeam.coach || '';
                
                if (draftData.selections && draftData.selections.awayNumbers) {
                    awayNumbers = [...draftData.selections.awayNumbers];
                    // Afficher les num√©ros dans le textarea
                    document.getElementById('away-players-numbers').value = awayNumbers.join(', ');
                    parseAwayNumbers();
                    console.log('  ‚úÖ √âquipe adverse:', awayNumbers.length, 'joueurs');
                }
            }
            
            // 5. Restaurer les options (√âtape 4)
            if (draftData.options) {
                document.getElementById('enable-streaming').checked = draftData.options.streaming || false;
                document.getElementById('stream-url').value = draftData.options.streamUrl || '';
                const statsModeRadio = document.querySelector(`input[name="stats-mode"][value="${draftData.options.statsMode}"]`);
                if (statsModeRadio) {
                    statsModeRadio.checked = true;
                }
                console.log('  ‚úÖ Options restaur√©es');
            }
            
            // 6. Rester √† l'√©tape 1 pour que l'utilisateur puisse naviguer
            goToStep(1);
            
            alert('‚úÖ Brouillon charg√© avec succ√®s !\n\nVous pouvez maintenant naviguer entre les √©tapes.');
            console.log('‚úÖ Brouillon enti√®rement charg√© !');
        }
    </script>
</body>
</html>

