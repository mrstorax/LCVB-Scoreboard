<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LCVB Scoreboard - Contr√¥le</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="control-style.css">
    <link rel="stylesheet" href="control-compact.css">
</head>
<body class="control-page">
    
    <!-- Modal supprim√©e - positionnement par clic sur le terrain -->
    <div id="positioning-modal" style="display: none;">
        <div class="positioning-modal-content">
            <h2 class="positioning-title">üèê Positionnement - Set <span id="positioning-set-number">1</span></h2>
            <p class="positioning-subtitle">Placez vos joueurs sur le terrain</p>
            
            <div class="positioning-grid">
                <!-- NOTRE √âQUIPE -->
                <div class="positioning-team-section">
                    <h3 class="positioning-team-title" id="positioning-home-title">üè† Notre √âquipe</h3>
                    
                    <div class="positioning-court">
                        <div class="positioning-net">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ FILET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                        
                        <!-- Ligne avant -->
                        <div class="positioning-row">
                            <div class="positioning-position">
                                <label>P4 (Avant gauche)</label>
                                <select id="pos-home-p4" class="positioning-select">
                                    <option value="">-- Joueur --</option>
                                </select>
                            </div>
                            <div class="positioning-position">
                                <label>P3 (Centre avant)</label>
                                <select id="pos-home-p3" class="positioning-select">
                                    <option value="">-- Joueur --</option>
                                </select>
                            </div>
                            <div class="positioning-position">
                                <label>P2 (Avant droit)</label>
                                <select id="pos-home-p2" class="positioning-select">
                                    <option value="">-- Joueur --</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Ligne arri√®re -->
                        <div class="positioning-row">
                            <div class="positioning-position">
                                <label>P5 (Arri√®re gauche)</label>
                                <select id="pos-home-p5" class="positioning-select">
                                    <option value="">-- Joueur --</option>
                                </select>
                            </div>
                            <div class="positioning-position">
                                <label>P6 (Centre arri√®re)</label>
                                <select id="pos-home-p6" class="positioning-select">
                                    <option value="">-- Joueur --</option>
                                </select>
                            </div>
                            <div class="positioning-position">
                                <label>P1 (Service) ‚ö°</label>
                                <select id="pos-home-p1" class="positioning-select">
                                    <option value="">-- Joueur --</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Lib√©ro -->
                        <div class="positioning-libero">
                            <label><strong>Lib√©ro (optionnel)</strong></label>
                            <select id="pos-home-libero" class="positioning-select">
                                <option value="">-- Aucun --</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- √âQUIPE ADVERSE (CACH√â POUR LE MOMENT) -->
                <div class="positioning-team-section" style="display: none;">
                    <h3 class="positioning-team-title" id="positioning-away-title">üë• √âquipe Adverse</h3>
                    
                    <div class="positioning-court">
                        <div class="positioning-net">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ FILET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                        
                        <!-- Ligne avant -->
                        <div class="positioning-row">
                            <div class="positioning-position">
                                <label>P4</label>
                                <select id="pos-away-p4" class="positioning-select">
                                    <option value="">-- Num√©ro --</option>
                                </select>
                            </div>
                            <div class="positioning-position">
                                <label>P3</label>
                                <select id="pos-away-p3" class="positioning-select">
                                    <option value="">-- Num√©ro --</option>
                                </select>
                            </div>
                            <div class="positioning-position">
                                <label>P2</label>
                                <select id="pos-away-p2" class="positioning-select">
                                    <option value="">-- Num√©ro --</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Ligne arri√®re -->
                        <div class="positioning-row">
                            <div class="positioning-position">
                                <label>P5</label>
                                <select id="pos-away-p5" class="positioning-select">
                                    <option value="">-- Num√©ro --</option>
                                </select>
                            </div>
                            <div class="positioning-position">
                                <label>P6</label>
                                <select id="pos-away-p6" class="positioning-select">
                                    <option value="">-- Num√©ro --</option>
                                </select>
                            </div>
                            <div class="positioning-position">
                                <label>P1 (Service) ‚ö°</label>
                                <select id="pos-away-p1" class="positioning-select">
                                    <option value="">-- Num√©ro --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Choix de l'√©quipe au service -->
            <div class="positioning-service-choice">
                <h3>‚ö° Qui sert en premier ?</h3>
                <div class="service-choice-buttons">
                    <button id="service-choice-home" class="btn btn-primary" onclick="selectFirstServer('team1')">
                        <span id="service-choice-home-label">Notre √©quipe</span>
                    </button>
                    <button id="service-choice-away" class="btn btn-primary" onclick="selectFirstServer('team2')">
                        <span id="service-choice-away-label">√âquipe adverse</span>
                    </button>
                </div>
                <div id="service-choice-indicator" style="margin-top: 1rem; text-align: center; font-weight: bold; color: #10b981;"></div>
            </div>
            
            <!-- Boutons d'action -->
            <div class="positioning-actions">
                <button class="btn btn-success btn-lg" onclick="validatePositioning()">‚úÖ Valider et D√©marrer le Set</button>
                <button class="btn btn-secondary" onclick="closePositioningModal()">‚ùå Annuler</button>
            </div>
        </div>
    </div>
    
    <div class="control-container">
        <!-- En-t√™te compact avec infos du match -->
        <div class="control-header compact-header">
            <div class="match-info-header">
                <span class="match-teams" id="header-teams">üèê Match en cours</span>
                <span class="match-details" id="header-details">Pr√©parez votre match dans Setup</span>
            </div>
            <div class="header-actions">
                <button onclick="window.location.href='home.html'" class="btn btn-secondary btn-sm">üè† Accueil</button>
                <button onclick="window.location.href='setup.html'" class="btn btn-secondary btn-sm">‚öôÔ∏è Setup</button>
            </div>
        </div>

        <!-- Zone principale compacte -->
        <div class="compact-main-area">
            
            <!-- Section Score + Chronos -->
            <div class="score-chrono-section">
                <div class="score-panel">
                    <h3>üìä Score du Set <span id="current-set-display">1</span> / 5</h3>
                    <div class="score-display-compact">
                        <div class="team-score-compact">
                            <div class="team-name-compact" id="compact-team1-name">√âquipe 1</div>
                            <div class="score-compact" id="compact-team1-score">0</div>
                            <div class="score-buttons-compact">
                                <button class="btn-score-compact btn-plus" onclick="changeScore('team1', 1)">+1</button>
                                <button class="btn-score-compact btn-minus" onclick="changeScore('team1', -1)">-1</button>
                            </div>
                        </div>
                        
                        <div class="score-separator">-</div>
                        
                        <div class="team-score-compact">
                            <div class="team-name-compact" id="compact-team2-name">√âquipe 2</div>
                            <div class="score-compact" id="compact-team2-score">0</div>
                            <div class="score-buttons-compact">
                                <button class="btn-score-compact btn-plus" onclick="changeScore('team2', 1)">+1</button>
                                <button class="btn-score-compact btn-minus" onclick="changeScore('team2', -1)">-1</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sets-display-compact">
                        <div><strong>Sets gagn√©s :</strong></div>
                        <div id="sets-won-display">√âquipe 1: 0 | √âquipe 2: 0</div>
                    </div>
                    
                    <!-- Historique des sets pr√©c√©dents -->
                    <div class="sets-history-compact" id="sets-history-display" style="display: none;">
                        <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;"><strong>üìã Historique des sets :</strong></div>
                        <div id="sets-history-list" style="font-size: 0.7rem; color: #475569;"></div>
                    </div>
                    
                    <!-- Compteur de timeouts -->
                    <div class="timeouts-display-compact">
                        <div style="font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem;"><strong>‚è∏Ô∏è Timeouts (ce set) :</strong></div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem;">
                            <span id="timeout-team1-display">√âquipe 1: 0/2</span>
                            <span id="timeout-team2-display">√âquipe 2: 0/2</span>
                        </div>
                    </div>
                    
                    <div class="match-controls-compact">
                        <button class="btn btn-primary" onclick="nextSet()">üîÑ Set Suivant</button>
                        <button class="btn btn-secondary" onclick="resetCurrentSet()">‚Üª Reset Set</button>
                        <button class="btn btn-danger" onclick="resetEverything()">üóëÔ∏è Reset Match</button>
                    </div>
                </div>
                
                <div class="chrono-panel">
                    <h3>‚è±Ô∏è Chronom√®tres</h3>
                    <div class="timer-compact">
                        <div class="timer-label">Match :</div>
                        <div class="timer-value" id="match-timer-display">00:00:00</div>
                        <button class="btn btn-sm" onclick="resetMatchTimer()">Reset</button>
                    </div>
                    <div class="timer-compact">
                        <div class="timer-label">Set :</div>
                        <div class="timer-value" id="set-timer-display">00:00:00</div>
                        <button class="btn btn-sm" onclick="resetSetTimer()">Reset</button>
                    </div>
                    <div class="timer-info">
                        ‚ÑπÔ∏è D√©marrage automatique au 1er point
                    </div>
                </div>
            </div>
            
            <!-- Section Terrain + Workflow PRO -->
            <div class="pro-stats-section">
                <h3>üèê Saisie Professionnelle</h3>
                
                <!-- Banni√®re d'instruction pour le positionnement -->
                <div id="positioning-instruction-banner" style="display: none; background: linear-gradient(135deg, #EC4899 0%, #8B5CF6 100%); color: white; padding: 1rem; border-radius: 12px; margin-bottom: 1rem; text-align: center; font-weight: 700; font-size: 1.1rem; box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);">
                    üéØ √âTAPE 1 : Placez d'abord le PASSEUR
                </div>
                
                <!-- Sch√©ma de placement sugg√©r√© -->
                <div id="placement-schema" style="display: none; background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                    <h4 style="margin: 0 0 0.75rem 0; color: #1e40af; font-size: 0.95rem; text-align: center;">
                        üìã Sch√©ma de placement sugg√©r√©
                    </h4>
                    <div id="placement-schema-content" style="display: flex; flex-direction: column; gap: 0.75rem; align-items: center;">
                        <!-- Sera rempli dynamiquement -->
                    </div>
                </div>
                
                <!-- Affichage du terrain -->
                <div class="court-display">
                    <div class="court-header">
                        <h4 id="team-court-name">Notre √âquipe</h4>
                        <div class="service-indicator" id="service-indicator">
                            ‚ö° Au service
                        </div>
                    </div>
                    
                    <div class="court-container">
                        <div class="court-net">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ FILET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>
                        
                        <!-- Ligne avant (4-3-2) -->
                        <div class="court-line court-line-front">
                            <div class="court-position" data-pos="4" onclick="if(window.isPositioningMode) clickToAssignPlayer(4); else selectPlayerForAction(4);">
                                <div class="position-label">P4</div>
                                <div class="player-card-court" id="court-pos-4">
                                    <div class="player-number-court">-</div>
                                    <div class="player-name-court">-</div>
                                </div>
                            </div>
                            
                            <div class="court-position" data-pos="3" onclick="if(window.isPositioningMode) clickToAssignPlayer(3); else selectPlayerForAction(3);">
                                <div class="position-label">P3</div>
                                <div class="player-card-court" id="court-pos-3">
                                    <div class="player-number-court">-</div>
                                    <div class="player-name-court">-</div>
                                </div>
                            </div>
                            
                            <div class="court-position" data-pos="2" onclick="if(window.isPositioningMode) clickToAssignPlayer(2); else selectPlayerForAction(2);">
                                <div class="position-label">P2</div>
                                <div class="player-card-court" id="court-pos-2">
                                    <div class="player-number-court">-</div>
                                    <div class="player-name-court">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ligne arri√®re (5-6-1) -->
                        <div class="court-line court-line-back">
                            <div class="court-position" data-pos="5" onclick="if(window.isPositioningMode) clickToAssignPlayer(5); else selectPlayerForAction(5);">
                                <div class="position-label">P5</div>
                                <div class="player-card-court" id="court-pos-5">
                                    <div class="player-number-court">-</div>
                                    <div class="player-name-court">-</div>
                                </div>
                            </div>
                            
                            <div class="court-position" data-pos="6" onclick="if(window.isPositioningMode) clickToAssignPlayer(6); else selectPlayerForAction(6);">
                                <div class="position-label">P6</div>
                                <div class="player-card-court" id="court-pos-6">
                                    <div class="player-number-court">-</div>
                                    <div class="player-name-court">-</div>
                                </div>
                            </div>
                            
                            <div class="court-position service-pos" data-pos="1" onclick="if(window.isPositioningMode) clickToAssignPlayer(1); else selectPlayerForAction(1);">
                                <div class="position-label">P1 ‚ö°</div>
                                <div class="player-card-court" id="court-pos-1">
                                    <div class="player-number-court">-</div>
                                    <div class="player-name-court">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Lib√©ro -->
                        <div class="libero-display" id="libero-display">
                            <span class="libero-label">Lib√©ro:</span>
                            <span class="libero-info" id="libero-info">-</span>
                        </div>
                        
                        <!-- Boutons pour validation du 7 de d√©part -->
                        <div style="text-align: center; margin-top: 1rem;">
                            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1rem;">
                                <button id="clear-lineup-btn" onclick="clearStartingLineup()" 
                                        style="padding: 1rem 2rem; font-size: 1.1rem; font-weight: bold; background: #f97316; color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
                                    üßπ Vider le terrain
                                </button>
                                <button id="choose-libero-btn" onclick="chooseStartingLibero()" 
                                        style="padding: 1rem 2rem; font-size: 1.1rem; font-weight: bold; background: #a855f7; color: white; border: none; border-radius: 8px; cursor: not-allowed; opacity: 0.5; transition: all 0.3s; display: none;">
                                    üõ°Ô∏è Choisir le Lib√©ro titulaire
                                </button>
                            <button id="validate-lineup-btn" onclick="validateStartingLineup()" 
                                    style="padding: 1rem 2rem; font-size: 1.1rem; font-weight: bold; background: #10b981; color: white; border: none; border-radius: 8px; cursor: not-allowed; opacity: 0.5; transition: all 0.3s;">
                                    ‚úÖ Valider le 7 de d√©part
                            </button>
                            </div>
                            
                            <!-- Affichage du lib√©ro titulaire s√©lectionn√© -->
                            <div id="selected-libero-display" style="display: none; padding: 1rem; background: #f3e8ff; border: 2px solid #a855f7; border-radius: 8px; margin-bottom: 1rem;">
                                <div style="font-weight: 700; color: #6b21a8; margin-bottom: 0.5rem;">üõ°Ô∏è LIB√âRO TITULAIRE</div>
                                <div id="selected-libero-info" style="font-size: 1.1rem; color: #1f2937;"></div>
                            </div>
                            
                            <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #64748b;">
                                Cliquez sur les 6 positions pour assigner vos joueurs, puis choisissez le lib√©ro titulaire
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Choix du service initial (affich√© seulement au d√©but du set) -->
                <div id="service-choice-buttons" style="display: none; margin-bottom: 1.5rem; padding: 1.5rem; background: #fef3c7; border: 3px solid #fbbf24; border-radius: 12px;">
                    <div style="text-align: center; margin-bottom: 1rem; font-weight: 700; color: #92400e; font-size: 1.1rem;">
                        üèê Qui sert en premier ?
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-success" style="flex: 1; font-size: 1rem; padding: 1rem;" onclick="setInitialService('team1')" id="service-btn-team1">
                            Service NOUS
                        </button>
                        <button class="btn btn-warning" style="flex: 1; font-size: 1rem; padding: 1rem;" onclick="setInitialService('team2')" id="service-btn-team2">
                            Service EUX
                        </button>
                    </div>
                </div>
                
                <!-- Workflow de saisie s√©quentiel -->
                <div class="workflow-container">
                    <div class="workflow-status" id="workflow-status">
                        <span class="workflow-step-indicator">√âtape 1/4</span>
                        <span class="workflow-instruction">Qui sert ? (ou qui re√ßoit le service adverse)</span>
                    </div>
                    
                    <div class="workflow-steps">
                        <!-- √âtape 1: Type d'action -->
                        <div class="workflow-step active" id="step-1">
                            <h4>1Ô∏è‚É£ D√©marrer le point</h4>
                            <div class="workflow-info" id="step-1-info" style="padding: 1rem; background: #fef3c7; border-radius: 8px; margin-bottom: 1rem; font-weight: 600; color: #92400e; text-align: center;">
                                Cliquez sur "D√©marrer" pour enregistrer le point
                            </div>
                            <div class="workflow-buttons">
                                <button id="start-rally-btn" class="btn-workflow btn-primary" onclick="startRallyWorkflow()" style="font-size: 1.2rem; padding: 1rem 2rem;">
                                    ‚ñ∂Ô∏è D√©marrer le point
                                </button>
                            </div>
                        </div>
                        
                        <!-- √âtape 2: S√©lection joueur (dynamique selon type) -->
                        <div class="workflow-step" id="step-2" style="display:none;">
                            <h4 id="step-2-title">2Ô∏è‚É£ S√©lectionner le joueur</h4>
                            <div class="workflow-info">
                                ‚òùÔ∏è Cliquez sur un joueur sur le terrain ci-dessus
                            </div>
                            <div id="selected-player-info"></div>
                        </div>
                        
                        <!-- √âtape 3: Qualit√©/R√©sultat -->
                        <div class="workflow-step" id="step-3" style="display:none;">
                            <h4 id="step-3-title">3Ô∏è‚É£ R√©sultat</h4>
                            <div class="workflow-buttons" id="step-3-buttons"></div>
                        </div>
                        
                        <!-- √âtape 4: Suite de l'action (attaque, etc.) -->
                        <div class="workflow-step" id="step-4" style="display:none;">
                            <h4 id="step-4-title">4Ô∏è‚É£ Suite de l'action</h4>
                            <div class="workflow-buttons" id="step-4-buttons"></div>
                        </div>
                    </div>
                    
                    <!-- R√©sum√© de l'action en cours -->
                    <div class="action-summary" id="action-summary">
                        <strong>Action en cours:</strong>
                        <div id="action-summary-text">Aucune action en cours</div>
                    </div>
                    
                    <!-- Boutons de contr√¥le -->
                    <div class="workflow-controls">
                        <button class="btn btn-secondary" onclick="cancelAction()">‚Ü©Ô∏è Annuler</button>
                        <button class="btn btn-danger" id="btn-end-rally" onclick="endRally()" style="display:none;">‚úÖ Valider Point</button>
                    </div>
                </div>
                
                <!-- Actions directes (toujours accessibles) -->
                <div class="direct-actions">
                    <h4>‚ö° Actions Directes (hors workflow)</h4>
                    <div class="direct-actions-buttons">
                        <button class="btn-direct btn-danger" onclick="directPoint('them')">‚ùå Point pour EUX - Faute directe</button>
                        <button class="btn-direct btn-success" onclick="directPoint('us')">‚úÖ Point pour NOUS - Faute directe</button>
                        <button class="btn-direct btn-warning" onclick="directCard()">üü®üü• Carton</button>
                        <button class="btn-direct btn-info" onclick="directTimeout()">‚è∏Ô∏è Timeout</button>
                        <button class="btn-direct" onclick="directSubstitution()">üîÑ Changement</button>
                    </div>
                </div>
                
                <!-- Historique et Undo -->
                <div class="history-controls">
                    <button class="btn btn-secondary" onclick="undoLastRally()" id="undo-btn">‚Ü©Ô∏è Annuler dernier point</button>
                    <button class="btn btn-secondary" onclick="showRallyHistory()">üìã Historique</button>
                    <button class="btn btn-primary" onclick="showStatsSummary()">üìä Statistiques</button>
                </div>
            </div>
            
            <!-- Section Statistiques des sets pr√©c√©dents -->
            <div id="previous-sets-stats-section" style="display: none; background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #e5e7eb; cursor: pointer;" onclick="togglePreviousSetsStats()">
                    <h3 style="margin: 0; color: #1f2937; font-size: 1.2rem; font-weight: 700;">üìä Statistiques des sets pr√©c√©dents</h3>
                    <button class="btn btn-sm btn-secondary" id="toggle-previous-sets-btn">
                        üëÅÔ∏è Afficher
                    </button>
                </div>
                <div id="previous-sets-stats-list" style="display: none; max-height: 400px; overflow-y: auto; font-size: 0.9rem; line-height: 1.8; padding-right: 0.5rem;">
                    <div style="text-align: center; color: #9ca3af; padding: 2rem;">
                        Aucun set pr√©c√©dent.
                    </div>
                </div>
            </div>
            
            <!-- Section Historique des points du set en cours -->
            <div class="history-current-set-section" style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid #e5e7eb;">
                    <h3 style="margin: 0; color: #1f2937; font-size: 1.2rem; font-weight: 700;">üìã Historique du Set en cours</h3>
                    <button class="btn btn-sm btn-secondary" onclick="toggleSetHistory()" id="toggle-set-history-btn">
                        üëÅÔ∏è Masquer
                    </button>
                </div>
                <div id="current-set-history-list" style="display: block; max-height: 500px; overflow-y: auto; font-size: 0.9rem; line-height: 1.8; padding-right: 0.5rem;">
                    <div style="text-align: center; color: #9ca3af; padding: 2rem;">
                        Aucun point enregistr√© pour ce set.
                    </div>
                </div>
            </div>
            
            <!-- Statistiques d'√©quipe et par joueur -->
            <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 3px solid #EC4899;">
                    <h3 style="margin: 0; color: #1f2937; font-size: 1.2rem; font-weight: 700;">üìä Statistiques du Match</h3>
                    <button class="btn btn-sm btn-secondary" onclick="toggleMatchStats()" id="toggle-match-stats-btn">
                        üëÅÔ∏è Masquer
                    </button>
                </div>
                
                <!-- Statistiques d'√©quipe globales -->
                <div id="team-stats-summary" style="display: block; margin-bottom: 1.5rem; padding: 1rem; background: #f3f4f6; border-radius: 8px;">
                    <h4 style="margin: 0 0 0.75rem 0; color: #4b5563; font-size: 1rem; font-weight: 600;">üèê Totaux d'√©quipe</h4>
                    <div id="team-stats-content" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; font-size: 0.85rem;">
                        <!-- Sera rempli dynamiquement -->
                    </div>
                </div>
                
                <!-- Statistiques par joueur -->
                <div id="player-stats-section" style="display: block;">
                    <h4 style="margin: 0 0 0.75rem 0; color: #4b5563; font-size: 1rem; font-weight: 600;">üë• Statistiques par joueur</h4>
                    <div id="player-stats-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
                        <!-- Sera rempli dynamiquement -->
                    </div>
                </div>
            </div>
            
            <!-- Section Pr√©visualisation -->
            <div class="preview-section">
                <div class="preview-header">
                    <h3>üì∫ Pr√©visualisation Affichage</h3>
                    <button class="btn btn-sm btn-secondary" onclick="refreshPreview()">üîÑ Actualiser</button>
                    <button class="btn btn-sm btn-primary" onclick="openDisplayFullscreen()">üñ•Ô∏è Plein √©cran</button>
                </div>
                <div class="preview-container">
                    <iframe id="preview-iframe" src="display.html" frameborder="0"></iframe>
                </div>
            </div>
            
            <!-- Panneau lat√©ral Options (masqu√© par d√©faut) -->
            <div class="options-panel" id="options-panel" style="display: none;">
                <h3>‚öôÔ∏è Options Avanc√©es</h3>
            <div class="control-panel">
                <h2>√âquipe 1</h2>
                
                <!-- Informations de l'√©quipe -->
                <div class="team-info">
                    <div class="input-group">
                        <label for="team1-name">Nom de l'√©quipe :</label>
                        <input type="text" id="team1-name" placeholder="Nom √©quipe 1">
                    </div>
                    <div class="input-group">
                        <label for="team1-niveau">Niveau de l'√©quipe :</label>
                        <select id="team1-niveau" class="niveau-select">
                            <option value="">-- Aucun niveau --</option>
                            <option value="Loisirs">Loisirs</option>
                            <option value="D√©partemental 1">D√©partemental 1</option>
                            <option value="D√©partemental 2">D√©partemental 2</option>
                            <option value="D√©partemental 3">D√©partemental 3</option>
                            <option value="R√©gional 1">R√©gional 1</option>
                            <option value="R√©gional 2">R√©gional 2</option>
                            <option value="R√©gional 3">R√©gional 3</option>
                            <option value="Pr√©national">Pr√©national</option>
                            <option value="National 1">National 1</option>
                            <option value="National 2">National 2</option>
                            <option value="National 3">National 3</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="team1-logo">Chemin du logo :</label>
                        <div class="logo-selector">
                            <input type="file" 
                                   id="team1-logo-file" 
                                   accept="image/*" 
                                   class="logo-file-input"
                                   onchange="handleLogoFileSelect('team1', this)">
                            <input type="text" 
                                   id="team1-logo" 
                                   placeholder="logos/logo-lcvb.png"
                                   class="logo-path-input">
                            <button type="button" 
                                    class="btn btn-logo-browse" 
                                    onclick="document.getElementById('team1-logo-file').click()">
                                üìÅ Parcourir
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Contr√¥les de score -->
                <div class="score-controls">
                    <div class="score-row">
                        <span class="score-label">Score :</span>
                        <input type="number" 
                               id="team1-score-input" 
                               class="score-input" 
                               min="0" 
                               max="999" 
                               value="0"
                               onchange="setScoreDirect('team1', this.value)"
                               oninput="validateScoreInput(this)">
                        <button class="btn btn-plus" onclick="changeScore('team1', 1)">+</button>
                        <button class="btn btn-minus" onclick="changeScore('team1', -1)">‚àí</button>
                    </div>
                    <button class="btn btn-reset" onclick="resetScore('team1')">R√©initialiser Score</button>
                </div>

                <!-- Contr√¥les des sets -->
                <div class="sets-controls">
                    <h3 style="color: var(--lcvb-rose); margin-top: 20px; margin-bottom: 10px;">Sets :</h3>
                    <div id="team1-sets-controls">
                        <!-- G√©n√©r√©s dynamiquement -->
                    </div>
                </div>
            </div>

            <!-- √âquipe 2 -->
            <div class="control-panel">
                <h2>√âquipe 2</h2>
                
                <!-- Informations de l'√©quipe -->
                <div class="team-info">
                    <div class="input-group">
                        <label for="team2-name">Nom de l'√©quipe :</label>
                        <input type="text" id="team2-name" placeholder="Nom √©quipe 2">
                    </div>
                    <div class="input-group">
                        <label for="team2-niveau">Niveau de l'√©quipe :</label>
                        <select id="team2-niveau" class="niveau-select">
                            <option value="">-- Aucun niveau --</option>
                            <option value="Loisirs">Loisirs</option>
                            <option value="D√©partemental 1">D√©partemental 1</option>
                            <option value="D√©partemental 2">D√©partemental 2</option>
                            <option value="D√©partemental 3">D√©partemental 3</option>
                            <option value="R√©gional 1">R√©gional 1</option>
                            <option value="R√©gional 2">R√©gional 2</option>
                            <option value="R√©gional 3">R√©gional 3</option>
                            <option value="Pr√©national">Pr√©national</option>
                            <option value="National 1">National 1</option>
                            <option value="National 2">National 2</option>
                            <option value="National 3">National 3</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="team2-logo">Chemin du logo :</label>
                        <div class="logo-selector">
                            <input type="file" 
                                   id="team2-logo-file" 
                                   accept="image/*" 
                                   class="logo-file-input"
                                   onchange="handleLogoFileSelect('team2', this)">
                            <input type="text" 
                                   id="team2-logo" 
                                   placeholder="logos/logo-equipe2.png"
                                   class="logo-path-input">
                            <button type="button" 
                                    class="btn btn-logo-browse" 
                                    onclick="document.getElementById('team2-logo-file').click()">
                                üìÅ Parcourir
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Contr√¥les de score -->
                <div class="score-controls">
                    <div class="score-row">
                        <span class="score-label">Score :</span>
                        <input type="number" 
                               id="team2-score-input" 
                               class="score-input" 
                               min="0" 
                               max="999" 
                               value="0"
                               onchange="setScoreDirect('team2', this.value)"
                               oninput="validateScoreInput(this)">
                        <button class="btn btn-plus" onclick="changeScore('team2', 1)">+</button>
                        <button class="btn btn-minus" onclick="changeScore('team2', -1)">‚àí</button>
                    </div>
                    <button class="btn btn-reset" onclick="resetScore('team2')">R√©initialiser Score</button>
                </div>

                <!-- Contr√¥les des sets -->
                <div class="sets-controls">
                    <h3 style="color: var(--lcvb-rose); margin-top: 20px; margin-bottom: 10px;">Sets :</h3>
                    <div id="team2-sets-controls">
                        <!-- G√©n√©r√©s dynamiquement -->
                    </div>
                </div>
            </div>

            <!-- Contr√¥les globaux -->
            <div class="global-controls">
                <!-- Affichage des chronom√®tres -->
                <div class="timer-display-panel">
                    <div>
                        <label>‚è±Ô∏è Chronom√®tre Match</label>
                        <div id="match-timer-display">00:00:00</div>
                        <button class="btn" onclick="LCVBScoreboard.resetMatchTimer()">‚èπÔ∏è R√©initialiser</button>
                        <div>D√©marre automatiquement au premier point</div>
                    </div>
                    <div>
                        <label>‚è±Ô∏è Chronom√®tre Set <span id="current-set-number">1</span></label>
                        <div id="set-timer-display">00:00</div>
                        <button class="btn" onclick="resetCurrentSetTimer()">‚èπÔ∏è R√©initialiser</button>
                        <div>D√©marre automatiquement au premier point</div>
                    </div>
                </div>
                <div class="match-type-selector">
                    <label for="match-amical">
                        <input type="checkbox" 
                               id="match-amical" 
                               onchange="updateMatchAmicalCommon(this.checked)">
                        <strong>Match amical</strong>
                    </label>
                </div>
                <div class="set-selector">
                    <label for="set-selector">Set actuel :</label>
                    <select id="set-selector" onchange="changeCurrentSet()">
                        <option value="1">Set 1</option>
                        <option value="2">Set 2</option>
                        <option value="3">Set 3</option>
                        <option value="4">Set 4</option>
                        <option value="5">Set 5</option>
                    </select>
                </div>
                <div class="template-selector">
                    <label for="template-selector">Style :</label>
                    <select id="template-selector" onchange="changeTemplateMode(this.value)" title="Choisir le style d'affichage">
                        <option value="actuel">Actuel (Club - Rose/Noir)</option>
                        <option value="neutre">Neutre (Minimaliste)</option>
                        <option value="sobre">Sobre (Couleurs adoucies)</option>
                        <option value="pro">Pro (Style professionnel)</option>
                        <option value="custom">Couleurs personnalis√©es</option>
                    </select>
                </div>
                <div id="custom-colors-panel" class="custom-colors-panel">
                    <div class="colors-grid">
                        <div class="color-item">
                            <label for="color-primary">Couleur principale :</label>
                            <input type="color" id="color-primary" value="#E91E63" onchange="updateCustomColor('primary', this.value)">
                            <span class="color-desc">(Scores, bordures, accents)</span>
                        </div>
                        <div class="color-item">
                            <label for="color-secondary">Couleur secondaire :</label>
                            <input type="color" id="color-secondary" value="#FF69B4" onchange="updateCustomColor('secondary', this.value)">
                            <span class="color-desc">(Niveaux, accents clairs)</span>
                        </div>
                        <div class="color-item">
                            <label for="color-background">Fond principal :</label>
                            <input type="color" id="color-background" value="#000000" onchange="updateCustomColor('background', this.value)">
                            <span class="color-desc">(Background du bandeau)</span>
                        </div>
                        <div class="color-item">
                            <label for="color-background-secondary">Fond secondaire :</label>
                            <input type="color" id="color-background-secondary" value="#0f0f0f" onchange="updateCustomColor('backgroundSecondary', this.value)">
                            <span class="color-desc">(Gradient de fond)</span>
                        </div>
                        <div class="color-item">
                            <label for="color-text">Couleur du texte :</label>
                            <input type="color" id="color-text" value="#FFFFFF" onchange="updateCustomColor('text', this.value)">
                            <span class="color-desc">(Noms, textes)</span>
                        </div>
                        <div class="color-item">
                            <label for="color-set-active">Sets actifs :</label>
                            <input type="color" id="color-set-active" value="#E91E63" onchange="updateCustomColor('setActive', this.value)">
                            <span class="color-desc">(Sets gagn√©s/actifs)</span>
                        </div>
                    </div>
                    <div class="save-config-section">
                        <input type="text" id="config-name-input" placeholder="Nom de la configuration..." maxlength="30">
                        <button class="btn btn-save-config" onclick="saveConfig()">üíæ Sauvegarder</button>
                        <select id="load-config-select" onchange="loadConfig(this.value)">
                            <option value="">Charger une configuration...</option>
                        </select>
                        <button class="btn btn-delete-config" onclick="deleteCurrentConfig()">üóëÔ∏è Supprimer</button>
                    </div>
                </div>
                <div class="match-info-panel">
                    <h3>üìã Informations du Match</h3>
                    <div>
                        <div class="input-group">
                            <label for="match-date">Date du match :</label>
                            <input type="date" id="match-date" onchange="updateMatchInfo('date', this.value)">
                        </div>
                        <div class="input-group">
                            <label for="match-time">Heure du match :</label>
                            <input type="time" id="match-time" onchange="updateMatchInfo('time', this.value)">
                        </div>
                        <div class="input-group">
                            <label for="match-location">Lieu :</label>
                            <input type="text" id="match-location" placeholder="Ex: Salle des sports" onchange="updateMatchInfo('location', this.value)">
                        </div>
                        <div class="input-group">
                            <label for="match-competition">Comp√©tition :</label>
                            <input type="text" id="match-competition" placeholder="Ex: Championnat, Coupe..." onchange="updateMatchInfo('competition', this.value)">
                        </div>
                        <div class="input-group">
                            <label for="match-referee">Arbitre :</label>
                            <input type="text" id="match-referee" placeholder="Nom de l'arbitre" onchange="updateMatchInfo('referee', this.value)">
                        </div>
                        <div class="input-group">
                            <label for="match-notes">Notes :</label>
                            <input type="text" id="match-notes" placeholder="Notes suppl√©mentaires" onchange="updateMatchInfo('notes', this.value)">
                        </div>
                    </div>
                </div>
                <button class="btn btn-next-set" onclick="nextSet()">Set Suivant</button>
                <button class="btn btn-undo" id="btn-undo" onclick="undoAction()" title="Annuler la derni√®re action (Ctrl+Z)">‚Ü∂ Annuler</button>
                <button class="btn btn-toggle-logos" id="toggle-logos-btn" onclick="toggleLogos()" title="Afficher/Masquer les logos">üñºÔ∏è Logos</button>
                <button class="btn btn-social" onclick="showSocialShare()" title="Publier sur les r√©seaux sociaux">üì± Publier</button>
                <button class="btn btn-full-reset" onclick="resetEverything()">R√©initialiser Tout</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Initialisation
        LCVBScoreboard.initScoreData();

        // Charger les donn√©es du match depuis le setup
        function loadMatchSetupData() {
            const matchData = localStorage.getItem('lcvb_current_match');
            if (matchData) {
                try {
                    const setup = JSON.parse(matchData);
                    console.log('‚úÖ Donn√©es du setup charg√©es:', setup);
                    
                    // Mettre √† jour le header
                    const teamsText = `üèê ${setup.homeTeam.name} vs ${setup.awayTeam.name}`;
                    const detailsText = `${setup.general.date} ‚Ä¢ ${setup.general.type} ‚Ä¢ ${setup.general.division}`;
                    
                    document.getElementById('header-teams').textContent = teamsText;
                    document.getElementById('header-details').textContent = detailsText;
                    
                    return setup;
                } catch (error) {
                    console.error('‚ùå Erreur lors du chargement du setup:', error);
                }
            } else {
                console.log('‚ö†Ô∏è Aucune donn√©e de setup trouv√©e');
            }
            return null;
        }
        
        // Charger au d√©marrage
        const matchSetup = loadMatchSetupData();
        
        // Plus besoin de modal - on utilise le clic direct sur le terrain !
        // Le mode positionnement est activ√© par d√©faut (isPositioningMode = true)
        console.log('‚úÖ Mode positionnement activ√© : cliquez sur les positions pour assigner les joueurs');
        
        // Compteurs de timeouts par set (d√©clar√© ici pour √™tre accessible par updateCompactDisplay)
        let timeoutsCount = {
            team1: 0,
            team2: 0
        };
        
        // ===== NOUVELLES FONCTIONS POUR L'INTERFACE COMPACTE =====
        
        // Charger les joueurs dans le s√©lecteur
        function loadPlayerSelector() {
            const select = document.getElementById('active-player-select');
            if (!select || !matchSetup) return;
            
            const homeTeam = matchSetup.homeTeam;
            const awayTeam = matchSetup.awayTeam;
            
            let options = '<option value="">-- S√©lectionner un joueur --</option>';
            options += '<optgroup label="' + homeTeam.name + '">';
            homeTeam.players.forEach(p => {
                options += `<option value="home-${p.id}">#${p.number} ${p.firstName} ${p.lastName}</option>`;
            });
            options += '</optgroup>';
            
            options += '<optgroup label="' + awayTeam.name + '">';
            awayTeam.players.forEach(p => {
                options += `<option value="away-${p.number}">#${p.number}</option>`;
            });
            options += '</optgroup>';
            
            select.innerHTML = options;
        }
        
        // Mettre √† jour l'affichage compact
        function updateCompactDisplay() {
            const data = LCVBScoreboard.getScoreData();
            
            // Noms des √©quipes
            document.getElementById('compact-team1-name').textContent = data.team1.name || '√âquipe 1';
            document.getElementById('compact-team2-name').textContent = data.team2.name || '√âquipe 2';
            
            // Mettre √† jour le bouton "D√©marrer"
            updateStartRallyButton();
            
            // Scores
            document.getElementById('compact-team1-score').textContent = data.team1.score;
            document.getElementById('compact-team2-score').textContent = data.team2.score;
            
            // Set actuel
            document.getElementById('current-set-display').textContent = data.currentSet;
            
            // Sets gagn√©s
            const team1Sets = data.team1.sets.filter(s => s > 0).length;
            const team2Sets = data.team2.sets.filter(s => s > 0).length;
            document.getElementById('sets-won-display').textContent = 
                `${data.team1.name}: ${team1Sets} | ${data.team2.name}: ${team2Sets}`;
            
            // Historique des sets pr√©c√©dents
            const setsHistoryDisplay = document.getElementById('sets-history-display');
            const setsHistoryList = document.getElementById('sets-history-list');
            const completedSets = [];
            for (let i = 0; i < data.currentSet - 1; i++) {
                if (data.team1.sets[i] !== undefined || data.team2.sets[i] !== undefined) {
                    completedSets.push(`Set ${i + 1}: ${data.team1.sets[i] || 0}-${data.team2.sets[i] || 0}`);
                }
            }
            if (completedSets.length > 0) {
                setsHistoryDisplay.style.display = 'block';
                setsHistoryList.textContent = completedSets.join(' | ');
            } else {
                setsHistoryDisplay.style.display = 'none';
            }
            
            // Timeouts utilis√©s
            document.getElementById('timeout-team1-display').textContent = 
                `${data.team1.name}: ${timeoutsCount.team1}/2`;
            document.getElementById('timeout-team2-display').textContent = 
                `${data.team2.name}: ${timeoutsCount.team2}/2`;
                
            // Chronos
            if (data.matchTimer) {
                document.getElementById('match-timer-display').textContent = formatTime(data.matchTimer.elapsed);
            }
            if (data.setTimers && data.setTimers[data.currentSet - 1]) {
                document.getElementById('set-timer-display').textContent = 
                    formatTime(data.setTimers[data.currentSet - 1].elapsed);
            }
        }
        
        // Formater le temps
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        
        // Mettre √† jour le bouton "D√©marrer le point" dynamiquement
        function updateStartRallyButton() {
            const btn = document.getElementById('start-rally-btn');
            if (!btn) return;
            
            const data = LCVBScoreboard.getScoreData();
            const currentSet = data.currentSet;
            const score1 = data.team1.score;
            const score2 = data.team2.score;
            
            // D√©terminer le texte du bouton
            let btnText = '‚ñ∂Ô∏è D√©marrer le point suivant';
            
            if (currentSet === 1 && score1 === 0 && score2 === 0 && !window.startingLineupValidated) {
                // Premier point du match
                btnText = 'üèê D√©marrer le match';
            } else if (score1 === 0 && score2 === 0) {
                // Premier point d'un nouveau set
                btnText = 'üèê D√©marrer le set';
            }
            
            btn.innerHTML = btnText;
            
            // Griser le bouton si le service n'est pas choisi
            if (!serviceTeam) {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
                btn.style.background = '#9ca3af';
            } else {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.style.background = ''; // Revenir au style par d√©faut
            }
        }
        
        // Enregistrer une action
        let actionsHistory = [];
        
        function recordAction(actionType, team) {
            const playerSelect = document.getElementById('active-player-select');
            const playerId = playerSelect ? playerSelect.value : null;
            
            const action = {
                type: actionType,
                team: team,
                player: playerId,
                timestamp: new Date().toISOString(),
                setNumber: LCVBScoreboard.getScoreData().currentSet
            };
            
            actionsHistory.push(action);
            console.log('Action enregistr√©e:', action);
            
            // Activer le bouton undo
            document.getElementById('undo-btn').disabled = false;
            
            // TODO: Enregistrer dans IndexedDB plus tard
            // Pour l'instant, on stocke juste localement
            localStorage.setItem('lcvb_actions_history', JSON.stringify(actionsHistory));
            
            // Feedback visuel
            showNotification(`‚úÖ ${actionType} enregistr√© !`);
        }
        
        // G√©rer les changements de joueurs
        function manageSubstitution() {
            // TODO: Interface modale pour s√©lectionner joueur sortant/entrant
            const team = prompt('√âquipe ? (1 ou 2)');
            if (!team) return;
            
            const playerOut = prompt('Num√©ro du joueur sortant :');
            const playerIn = prompt('Num√©ro du joueur entrant :');
            
            if (playerOut && playerIn) {
                recordAction('substitution', 'team' + team);
                showNotification(`üîÑ Changement: #${playerOut} ‚Üí #${playerIn}`);
            }
        }
        
        // G√©rer entr√©e/sortie lib√©ro
        function manageLibero() {
            const team = prompt('√âquipe ? (1 ou 2)');
            if (!team) return;
            
            const action = prompt('Entr√©e ou Sortie du lib√©ro ?');
            if (action) {
                recordAction('libero_' + action.toLowerCase(), 'team' + team);
                showNotification(`üîÑ Lib√©ro: ${action}`);
            }
        }
        
        // Appeler un timeout
        function callTimeout(team) {
            recordAction('timeout', team);
            showNotification(`‚è∏Ô∏è Timeout demand√© par ${team === 'team1' ? '√âquipe 1' : '√âquipe 2'}`);
        }
        
        // Afficher un carton
        function showCard() {
            const team = prompt('√âquipe ? (1 ou 2)');
            if (!team) return;
            
            const color = prompt('Couleur du carton ? (jaune/rouge)');
            if (color) {
                recordAction('card_' + color, 'team' + team);
                showNotification(`üü®üü• Carton ${color} pour √âquipe ${team}`);
            }
        }
        
        // Rotation manuelle
        function rotateTeam() {
            const team = prompt('Rotation pour quelle √©quipe ? (1 ou 2)');
            if (team) {
                recordAction('rotation', 'team' + team);
                showNotification(`üîÑ Rotation effectu√©e pour √âquipe ${team}`);
            }
        }
        
        // Annuler la derni√®re action
        function undoLastAction() {
            if (actionsHistory.length === 0) return;
            
            const lastAction = actionsHistory.pop();
            console.log('Action annul√©e:', lastAction);
            
            localStorage.setItem('lcvb_actions_history', JSON.stringify(actionsHistory));
            
            if (actionsHistory.length === 0) {
                document.getElementById('undo-btn').disabled = true;
            }
            
            showNotification('‚Ü©Ô∏è Derni√®re action annul√©e');
        }
        
        // Afficher l'historique
        function showHistory() {
            if (actionsHistory.length === 0) {
                alert('Aucune action enregistr√©e pour le moment.');
                return;
            }
            
            let historyText = 'üìã HISTORIQUE DES ACTIONS\n\n';
            actionsHistory.slice().reverse().forEach((action, index) => {
                historyText += `${actionsHistory.length - index}. [Set ${action.setNumber}] ${action.type} - ${action.team || ''}\n`;
            });
            
            alert(historyText);
        }
        
        // Rafra√Æchir la pr√©visualisation
        function refreshPreview() {
            const iframe = document.getElementById('preview-iframe');
            if (iframe) {
                iframe.src = iframe.src;
                showNotification('üîÑ Pr√©visualisation actualis√©e');
            }
        }
        
        // Ouvrir l'affichage en plein √©cran
        function openDisplayFullscreen() {
            window.open('display.html', 'LCVB_Display', 'width=1920,height=1080,fullscreen=yes');
        }
        
        // Notification toast
        function showNotification(message) {
            // Simple alert pour l'instant
            // TODO: Cr√©er un syst√®me de toast √©l√©gant
            console.log('üí¨ Notification:', message);
        }
        
        // R√©initialiser les chronos
        function resetMatchTimer() {
            LCVBScoreboard.resetMatchTimer();
            updateCompactDisplay();
            showNotification('‚è±Ô∏è Chronom√®tre du match r√©initialis√©');
        }
        
        function resetSetTimer() {
            LCVBScoreboard.resetSetTimer();
            updateCompactDisplay();
            showNotification('‚è±Ô∏è Chronom√®tre du set r√©initialis√©');
        }
        
        // Charger l'historique au d√©marrage
        const savedHistory = localStorage.getItem('lcvb_actions_history');
        if (savedHistory) {
            try {
                actionsHistory = JSON.parse(savedHistory);
                if (actionsHistory.length > 0) {
                    document.getElementById('undo-btn').disabled = false;
                }
            } catch (e) {
                console.error('Erreur chargement historique:', e);
            }
        }
        
        // ===== SYST√àME WORKFLOW PROFESSIONNEL =====
        // D√âCLARER TOUTES LES VARIABLES GLOBALES EN PREMIER (avant updateCompactDisplay)
        
        // √âtat du match
        // √âtat du service (qui sert actuellement ?)
        let serviceTeam = null; // 'team1' | 'team2' | null (d√©but de set)
        
        let courtComposition = {
            positions: {}, // {1: player, 2: player, ...} - num√©ros 1 √† 6
            libero: {
                enabled: true,       // Gestion automatique du lib√©ro activ√©e ?
                player: null,        // Le joueur lib√©ro
                onCourt: false,      // Est-il sur le terrain ?
                replacing: null      // Quel central il remplace actuellement
            }
        };
        
        // timeoutsCount est d√©clar√© plus haut (ligne 736) pour √™tre accessible par updateCompactDisplay
        
        // Variables pour le positionnement initial (globales pour √™tre accessibles depuis le HTML)
        window.isPositioningMode = true; // Mode positionnement actif au d√©marrage
        window.startingLineupValidated = false; // Le 6 de d√©part est-il valid√© ?
        
        // Afficher la banni√®re d'instruction au d√©marrage
        setTimeout(() => {
            updatePositioningInstructions();
        }, 500);
        
        let rallyData = {
            actions: [],
            currentStep: 1,
            actionType: null,
            selectedPlayer: null,
            rallyResult: null,
            attackMeta: null
        };
        
        let matchStats = {
            rallies: [],
            playerStats: {},
            summary: {}
        };

        const ATTACK_TYPES = [
            { key: 'power', label: 'Puissance', icon: '‚ö°' },
            { key: 'placement', label: 'Placement', icon: 'üéØ' },
            { key: 'tip', label: 'Feinte', icon: '‚ú®' }
        ];

        const ATTACK_TEMPOS = [
            { key: 'tempo1', label: '1er tempo', icon: 'üöÄ' },
            { key: 'tempo2', label: '2e tempo', icon: '‚ö°' },
            { key: 'tempo3', label: '3e tempo', icon: 'üåô' }
        ];

        let rotationTracker = {
            initialOrder: [],
            currentIndex: 1
        };
        
        // Initialiser l'interface compacte
        if (matchSetup) {
            loadPlayerSelector();
        }
        updateCompactDisplay();
        
        // Mettre √† jour toutes les 100ms
        setInterval(updateCompactDisplay, 100);
        
        // Charger la composition depuis le setup
        // ========================================
        //  POSITIONNEMENT PAR CLIC SUR LE TERRAIN
        // ========================================
        
        // Cliquer sur une position pour assigner un joueur
        // Variable pour tracker l'√©tat du positionnement
        window.setterPosition = null; // Position du passeur (1-6)
        window.setterPlayerId = null; // ID du passeur s√©lectionn√©
        
        function clickToAssignPlayer(position) {
            console.log(`üìç === CLIC SUR POSITION P${position} ===`);
            console.log(`  ‚Üí isPositioningMode: ${window.isPositioningMode}`);
            console.log(`  ‚Üí startingLineupValidated: ${window.startingLineupValidated}`);
            console.log(`  ‚Üí setterPosition: ${window.setterPosition}`);
            
            if (!window.isPositioningMode) {
                console.log(`  ‚ùå Mode positionnement d√©sactiv√©, clic ignor√©`);
                return;
            }
            
            const matchSetup = localStorage.getItem('lcvb_current_match');
            if (!matchSetup) {
                alert('‚ùå Aucun match configur√©.');
                return;
            }
            
            const data = JSON.parse(matchSetup);
            const presentPlayers = data.homeTeam.presentPlayers || [];
            console.log(`  ‚Üí Joueurs disponibles: ${presentPlayers.length}`, presentPlayers);
            
            // Cr√©er un overlay pour s√©lectionner un joueur
            const overlay = document.createElement('div');
            overlay.id = 'player-selection-overlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            const modal = document.createElement('div');
            modal.style.cssText = 'background: white; padding: 2rem; border-radius: 16px; max-width: 1000px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';
            
            // V√©rifier si on attend un passeur
            const needsSetter = !window.setterPosition;
            
            let html = '<h3 style="margin: 0 0 1rem 0; color: #1f2937; font-size: 1.5rem; text-align: center;">üèê S√©lectionner un joueur pour P' + position + '</h3>';
            
            // Afficher un message d'aide si on attend le passeur
            if (needsSetter) {
                html += '<div style="background: linear-gradient(135deg, #EC4899 0%, #8B5CF6 100%); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center; font-weight: 600;">üéØ S√©lectionnez d\'abord un PASSEUR (Passeur/Passeuse)</div>';
            }
            
            // Grouper les joueurs par poste
            const groupedPlayers = {
                'Passeur': [],
                'Pointu': [],
                'Central': [],
                'R√©ceptionneur': [],
                'Lib√©ro': []
            };
            
            presentPlayers.forEach(p => {
                if (p.position === 'Passeur' || p.position === 'Passeuse') {
                    groupedPlayers['Passeur'].push(p);
                } else if (p.position === 'Pointu') {
                    groupedPlayers['Pointu'].push(p);
                } else if (p.position === 'Central' || p.position === 'Centrale') {
                    groupedPlayers['Central'].push(p);
                } else if (p.position === 'R√©ceptionneur' || p.position === 'R√©ceptionneuse') {
                    groupedPlayers['R√©ceptionneur'].push(p);
                } else if (p.position === 'Lib√©ro') {
                    groupedPlayers['Lib√©ro'].push(p);
                }
            });
            
            // Afficher en colonnes par poste
            html += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem;">';
            
            const positionConfig = {
                'Passeur': { icon: 'üéØ', bg: '#dbeafe', border: '#3b82f6', text: '#1e40af' },
                'Pointu': { icon: '‚ö°', bg: '#fecaca', border: '#ef4444', text: '#991b1b' },
                'Central': { icon: 'üß±', bg: '#fed7aa', border: '#f97316', text: '#9a3412' },
                'R√©ceptionneur': { icon: 'üì•', bg: '#d1fae5', border: '#10b981', text: '#065f46' },
                'Lib√©ro': { icon: 'üõ°Ô∏è', bg: '#e9d5ff', border: '#a855f7', text: '#6b21a8' }
            };
            
            Object.keys(groupedPlayers).forEach(poste => {
                const players = groupedPlayers[poste];
                const config = positionConfig[poste];
                
                html += '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
                html += '<div style="background: ' + config.bg + '; color: ' + config.text + '; padding: 0.75rem; border-radius: 8px; text-align: center; font-weight: 700; border: 2px solid ' + config.border + '; font-size: 0.9rem;">' + config.icon + ' ' + poste + '</div>';
                
                players.forEach(p => {
                    const isAlreadyPlaced = Object.values(courtComposition.positions).some(player => player && player.id == p.id);
                    const placedAt = isAlreadyPlaced ? Object.keys(courtComposition.positions).find(k => courtComposition.positions[k] && courtComposition.positions[k].id == p.id) : null;
                    
                    html += '<button onclick="assignPlayerToPosition(' + position + ', ' + p.id + ')" style="padding: 0.75rem; background: white; border: 2px solid ' + config.border + '; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; font-size: 0.9rem;" onmouseover="this.style.background=\'' + config.bg + '\'; this.style.transform=\'scale(1.05)\'" onmouseout="this.style.background=\'white\'; this.style.transform=\'scale(1)\'">';
                    html += '<div style="font-weight: 700; color: ' + config.text + '; font-size: 1.1rem; margin-bottom: 0.25rem;">#' + p.number + '</div>';
                    html += '<div style="font-size: 0.75rem; color: #374151; line-height: 1.2;">' + p.firstName + '<br>' + p.lastName + '</div>';
                    if (isAlreadyPlaced) {
                        html += '<div style="margin-top: 0.25rem; font-size: 0.7rem; color: #6b7280; font-weight: 600;">üîÑ P' + placedAt + '</div>';
                    }
                    html += '</button>';
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            html += '<button onclick="closePlayerSelection()" style="margin-top: 1.5rem; width: 100%; padding: 0.75rem; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1rem;">‚ùå Annuler</button>';
            
            modal.innerHTML = html;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }
        
        // Assigner un joueur √† une position
        function assignPlayerToPosition(position, playerId) {
            console.log(`üîç === assignPlayerToPosition ===`);
            console.log(`  ‚Üí position: ${position} (type: ${typeof position})`);
            console.log(`  ‚Üí playerId: ${playerId} (type: ${typeof playerId})`);
            
            const matchSetup = JSON.parse(localStorage.getItem('lcvb_current_match'));
            const presentPlayers = matchSetup.homeTeam.presentPlayers || [];
            
            console.log(`  ‚Üí presentPlayers:`, presentPlayers.map(p => `#${p.number} (id: ${p.id}, type: ${typeof p.id})`).join(', '));
            
            // Utiliser == au lieu de === pour comparer ind√©pendamment du type (string vs number)
            const player = presentPlayers.find(p => p.id == playerId);
            
            if (player) {
                console.log(`  ‚úÖ Joueur trouv√©: #${player.number} ${player.firstName}`);
                
                // V√©rifier si le joueur est d√©j√† sur le terrain ailleurs
                for (let pos in courtComposition.positions) {
                    if (courtComposition.positions[pos] && courtComposition.positions[pos].id == playerId) {
                        // Lib√©rer l'ancien poste
                        delete courtComposition.positions[pos];
                        console.log(`üîÑ Joueur #${player.number} d√©plac√© de P${pos} vers P${position}`);
                    }
                }
                
                // Assigner √† la nouvelle position
                courtComposition.positions[position] = player;
                console.log(`‚úÖ Joueur assign√©:`, {position, player, courtComposition});
                
                // V√©rifier si c'est un passeur et mettre √† jour le sch√©ma
                if (player.position === 'Passeur' || player.position === 'Passeuse') {
                    window.setterPosition = position;
                    window.setterPlayerId = playerId;
                    updatePositioningInstructions();
                    showPlacementSchema(position);
                }
                
                updateCourtDisplay();
                closePlayerSelection();
                checkIfLineupComplete();
            } else {
                console.error(`‚ùå Joueur non trouv√© avec ID: ${playerId} (type: ${typeof playerId})`);
                console.error(`  ‚Üí IDs disponibles:`, presentPlayers.map(p => `${p.id} (${typeof p.id})`));
            }
        }
        
        // Fermer la s√©lection de joueur
        function closePlayerSelection() {
            const overlay = document.getElementById('player-selection-overlay');
            if (overlay) overlay.remove();
        }
        
        // V√©rifier si le 6 de d√©part est complet
        function checkIfLineupComplete() {
            const positionsCount = Object.keys(courtComposition.positions).length;
            const validateBtn = document.getElementById('validate-lineup-btn');
            const liberoBtn = document.getElementById('choose-libero-btn');
            
            if (positionsCount === 6) {
                if (liberoBtn) {
                    liberoBtn.style.display = 'block';
                    liberoBtn.disabled = false;
                    liberoBtn.style.opacity = '1';
                    liberoBtn.style.cursor = 'pointer';
                }
                if (validateBtn) {
                validateBtn.disabled = false;
                validateBtn.style.opacity = '1';
                validateBtn.style.cursor = 'pointer';
            }
            } else {
                if (liberoBtn) {
                    liberoBtn.style.display = 'none';
                    liberoBtn.disabled = true;
                    liberoBtn.style.opacity = '0.5';
                    liberoBtn.style.cursor = 'not-allowed';
                }
                if (validateBtn) {
                    validateBtn.disabled = true;
                    validateBtn.style.opacity = '0.5';
                    validateBtn.style.cursor = 'not-allowed';
                }
            }
        }
        
        // Choisir le lib√©ro titulaire (7√®me joueur)
        window.selectedStartingLibero = null;
        
        function chooseStartingLibero() {
            const matchSetup = localStorage.getItem('lcvb_current_match');
            if (!matchSetup) return;
            
            const data = JSON.parse(matchSetup);
            const presentPlayers = data.homeTeam.presentPlayers || [];
            
            // Filtrer uniquement les lib√©ros NON plac√©s sur le terrain
            const availableLiberos = presentPlayers.filter(p => {
                const isLibero = p.libero === true || p.position === 'Lib√©ro';
                const isOnCourt = Object.values(courtComposition.positions).some(player => player && player.id == p.id);
                return isLibero && !isOnCourt;
            });
            
            if (availableLiberos.length === 0) {
                alert('‚ùå Aucun lib√©ro disponible dans les joueurs pr√©sents (ou tous sont d√©j√† sur le terrain)');
                return;
            }
            
            // Cr√©er un modal pour s√©lectionner le lib√©ro
            const overlay = document.createElement('div');
            overlay.id = 'libero-selection-overlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            
            const modal = document.createElement('div');
            modal.style.cssText = 'background: white; padding: 2rem; border-radius: 16px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);';
            
            let html = '<h3 style="margin: 0 0 1rem 0; color: #6b21a8; font-size: 1.5rem; text-align: center;">üõ°Ô∏è Choisir le Lib√©ro titulaire</h3>';
            html += '<p style="text-align: center; color: #6b7280; margin-bottom: 1.5rem;">Le lib√©ro est le 7√®me joueur de d√©part. Il remplacera automatiquement les centraux en r√©ception.</p>';
            html += '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
            
            availableLiberos.forEach(p => {
                html += '<button onclick="selectStartingLibero(' + p.id + ', \'' + p.firstName + '\', \'' + p.lastName + '\', ' + p.number + ')" style="padding: 1rem; background: #f3e8ff; border: 2px solid #a855f7; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s;" onmouseover="this.style.background=\'#e9d5ff\'; this.style.transform=\'scale(1.05)\'" onmouseout="this.style.background=\'#f3e8ff\'; this.style.transform=\'scale(1)\'">';
                html += '<div style="font-weight: 700; color: #6b21a8; font-size: 1.2rem;">#' + p.number + ' ' + p.firstName + ' ' + p.lastName + '</div>';
                html += '<div style="font-size: 0.85rem; color: #6b7280; margin-top: 0.25rem;">' + p.position + '</div>';
                html += '</button>';
            });
            
            html += '</div>';
            html += '<button onclick="closeLiberoSelection()" style="margin-top: 1.5rem; width: 100%; padding: 0.75rem; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700;">‚ùå Annuler</button>';
            
            modal.innerHTML = html;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }
        
        function selectStartingLibero(id, firstName, lastName, number) {
            window.selectedStartingLibero = { id, firstName, lastName, number };
            
            // Afficher le lib√©ro s√©lectionn√©
            const display = document.getElementById('selected-libero-display');
            const info = document.getElementById('selected-libero-info');
            if (display && info) {
                display.style.display = 'block';
                info.innerHTML = '#' + number + ' ' + firstName + ' ' + lastName;
            }
            
            closeLiberoSelection();
            console.log('‚úÖ Lib√©ro titulaire s√©lectionn√©:', window.selectedStartingLibero);
        }
        
        function closeLiberoSelection() {
            const overlay = document.getElementById('libero-selection-overlay');
            if (overlay) overlay.remove();
        }
        
        // Mettre √† jour les instructions de positionnement
        function updatePositioningInstructions() {
            const banner = document.getElementById('positioning-instruction-banner');
            if (!banner) return;
            
            if (!window.setterPosition) {
                // Pas encore de passeur
                banner.innerHTML = "üéØ √âTAPE 1 : Placez d'abord le PASSEUR";
                banner.style.display = "block";
            } else {
                // Passeur plac√©
                banner.innerHTML = "‚úÖ Passeur en P" + window.setterPosition + " | üéØ √âTAPE 2 : Placez les autres joueurs selon le sch√©ma ci-dessous";
                banner.style.background = "linear-gradient(135deg, #10b981 0%, #3b82f6 100%)";
            }
        }
        
        // Afficher le sch√©ma de placement selon la position du passeur
        function showPlacementSchema(setterPos) {
            const schema = document.getElementById('placement-schema');
            const content = document.getElementById('placement-schema-content');
            if (!schema || !content) return;
            
            // Sch√©mas de placement selon la position du passeur
            const placements = {
                1: { 1: 'Passeur', 2: 'R4', 3: 'Central', 4: 'Pointu', 5: 'R6', 6: 'Central' },
                2: { 1: 'Central', 2: 'Passeur', 3: 'R4', 4: 'Central', 5: 'Pointu', 6: 'R6' },
                3: { 1: 'R6', 2: 'Central', 3: 'Passeur', 4: 'R4', 5: 'Central', 6: 'Pointu' },
                4: { 1: 'Pointu', 2: 'R6', 3: 'Central', 4: 'Passeur', 5: 'R4', 6: 'Central' },
                5: { 1: 'Central', 2: 'Pointu', 3: 'R6', 4: 'Central', 5: 'Passeur', 6: 'R4' },
                6: { 1: 'R4', 2: 'Central', 3: 'Pointu', 4: 'R6', 5: 'Central', 6: 'Passeur' }
            };
            
            const placement = placements[setterPos];
            if (!placement) return;
            
            // G√©n√©rer le HTML du sch√©ma FACE AU FILET (format terrain r√©el)
            let html = '';
            
            // FILET en haut
            html += '<div style="text-align: center; font-weight: 700; color: #ef4444; margin-bottom: 0.5rem; font-size: 0.9rem;">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ FILET ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>';
            
            // Ligne AVANT (P4-P3-P2)
            html += '<div style="display: flex; gap: 1rem; justify-content: center; width: 100%; max-width: 600px;">';
            [4, 3, 2].forEach(pos => {
                const role = placement[pos];
                let bgColor = '#e5e7eb';
                let textColor = '#1f2937';
                
                if (role === 'Passeur' || role === 'Passeuse') {
                    bgColor = '#dbeafe'; textColor = '#1e40af';
                } else if (role === 'Pointu') {
                    bgColor = '#fecaca'; textColor = '#991b1b';
                } else if (role === 'Central' || role === 'Centrale') {
                    bgColor = '#fed7aa'; textColor = '#9a3412';
                } else if (role.startsWith('R')) {
                    bgColor = '#d1fae5'; textColor = '#065f46';
                }
                
                html += '<div style="background: ' + bgColor + '; color: ' + textColor + '; padding: 1rem; border-radius: 10px; text-align: center; font-weight: 700; border: 3px solid ' + textColor + '; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">';
                html += '<div style="font-size: 1.3rem; margin-bottom: 0.25rem;">P' + pos + '</div>';
                html += '<div style="font-size: 0.85rem;">' + role + '</div>';
                html += '</div>';
            });
            html += '</div>';
            
            // Label "AVANT"
            html += '<div style="text-align: center; color: #6b7280; font-size: 0.75rem; font-weight: 600;">‚ñ≤ LIGNE AVANT ‚ñ≤</div>';
            
            // Ligne ARRI√àRE (P5-P6-P1)
            html += '<div style="display: flex; gap: 1rem; justify-content: center; width: 100%; max-width: 600px;">';
            [5, 6, 1].forEach(pos => {
                const role = placement[pos];
                let bgColor = '#e5e7eb';
                let textColor = '#1f2937';
                
                if (role === 'Passeur' || role === 'Passeuse') {
                    bgColor = '#dbeafe'; textColor = '#1e40af';
                } else if (role === 'Pointu') {
                    bgColor = '#fecaca'; textColor = '#991b1b';
                } else if (role === 'Central' || role === 'Centrale') {
                    bgColor = '#fed7aa'; textColor = '#9a3412';
                } else if (role.startsWith('R')) {
                    bgColor = '#d1fae5'; textColor = '#065f46';
                }
                
                html += '<div style="background: ' + bgColor + '; color: ' + textColor + '; padding: 1rem; border-radius: 10px; text-align: center; font-weight: 700; border: 3px solid ' + textColor + '; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">';
                html += '<div style="font-size: 1.3rem; margin-bottom: 0.25rem;">P' + pos + '</div>';
                html += '<div style="font-size: 0.85rem;">' + role + '</div>';
                html += '</div>';
            });
            html += '</div>';
            
            // Label "ARRI√àRE"
            html += '<div style="text-align: center; color: #6b7280; font-size: 0.75rem; font-weight: 600;">‚ñº LIGNE ARRI√àRE ‚ñº</div>';
            
            content.innerHTML = html;
            schema.style.display = 'block';
        }
        
        // Valider le 6 de d√©part
        function validateStartingLineup() {
            const positionsCount = Object.keys(courtComposition.positions).length;
            
            if (positionsCount !== 6) {
                alert('‚ùå Vous devez assigner les 6 positions avant de valider !');
                return;
            }
            
            console.log('‚úÖ 6 joueurs assign√©s, affichage du modal de configuration finale');
            
            // Afficher un modal pour choisir le service et le lib√©ro
            showFinalSetupModal();
        }
        
        function showFinalSetupModal() {
            const matchSetup = JSON.parse(localStorage.getItem('lcvb_current_match'));
            const presentPlayers = matchSetup.homeTeam.presentPlayers || [];
            
            // DEBUG : Afficher les valeurs disponibles
            console.log('üèê === showFinalSetupModal DEBUG ===');
            console.log('  ‚Üí matchSetup.homeTeam:', matchSetup.homeTeam);
            console.log('  ‚Üí clubName:', matchSetup?.homeTeam?.clubName);
            console.log('  ‚Üí name:', matchSetup?.homeTeam?.name);
            
            // Utiliser clubName pour afficher "Le Cr√®s Volleyball" au lieu de "Pr√©nationale Masculine"
            const homeTeamName = matchSetup?.homeTeam?.clubName || matchSetup?.homeTeam?.name || 'Notre √©quipe';
            const awayTeamName = matchSetup?.awayTeam?.name || '√âquipe adverse';
            
            console.log('  ‚Üí homeTeamName final:', homeTeamName);
            
            // Trouver les lib√©ros disponibles (joueurs avec libero: true ou position: 'Lib√©ro')
            const availableLiberos = presentPlayers.filter(p => 
                p.libero === true || 
                p.position === 'Lib√©ro' || 
                p.position === 'Libero' ||
                p.position.toLowerCase().includes('lib√©ro') ||
                p.position.toLowerCase().includes('libero')
            );
            
            console.log('üèê === S√©lection du lib√©ro ===');
            console.log(`  ‚Üí Joueurs pr√©sents: ${presentPlayers.length}`);
            console.log(`  ‚Üí Lib√©ros trouv√©s: ${availableLiberos.length}`, availableLiberos.map(p => `#${p.number} ${p.firstName} (libero: ${p.libero}, position: ${p.position})`));
            
            let liberosHtml = '';
            const selectedLiberoId = window.selectedStartingLibero ? String(window.selectedStartingLibero.id) : null;
            
            if (!selectedLiberoId) {
                liberosHtml += '<option value="" selected>-- S√©lectionnez un lib√©ro --</option>';
            }
            
            if (availableLiberos.length === 0) {
                liberosHtml += '<option value="" disabled>‚ö†Ô∏è Aucun lib√©ro trouv√© dans l\'√©quipe</option>';
                console.warn('‚ö†Ô∏è Aucun lib√©ro trouv√© ! V√©rifiez que vos joueurs ont "libero": true dans teams.json');
            } else {
                availableLiberos.forEach(p => {
                    const isSelected = selectedLiberoId && String(p.id) === selectedLiberoId;
                    liberosHtml += `<option value="${p.id}" ${isSelected ? 'selected' : ''}>#${p.number} ${p.firstName} ${p.lastName} (${p.position})</option>`;
                });
            }
            
            const shouldSelectNone = !selectedLiberoId && availableLiberos.length === 0;
            liberosHtml += `<option value="none" ${shouldSelectNone ? 'selected' : ''}>üö´ Match sans lib√©ro</option>`;
            
            const modal = document.createElement('div');
            modal.id = 'final-setup-modal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 10001; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: white; padding: 2.5rem; border-radius: 16px; max-width: 600px; width: 90%;">
                    <h2 style="margin: 0 0 2rem 0; color: #EC4899; text-align: center; font-size: 1.8rem;">
                        üèê Configuration finale du set
                    </h2>
                    
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: #1f2937;">1Ô∏è‚É£ Qui sert en premier ?</h3>
                        <div style="display: flex; gap: 1rem;">
                            <button onclick="selectService('team1')" id="service-btn-team1-modal" 
                                    style="flex: 1; padding: 1rem; background: #9ca3af; color: white; border: 2px solid #6b7280; border-radius: 8px; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: all 0.2s;">
                                ${homeTeamName}
                            </button>
                            <button onclick="selectService('team2')" id="service-btn-team2-modal" 
                                    style="flex: 1; padding: 1rem; background: #9ca3af; color: white; border: 2px solid #6b7280; border-radius: 8px; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: all 0.2s;">
                                ${awayTeamName}
                            </button>
                        </div>
                        <div id="service-selected" style="margin-top: 0.5rem; color: #10b981; font-weight: 600; text-align: center;"></div>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: #1f2937;">2Ô∏è‚É£ Lib√©ro (optionnel)</h3>
                        <select id="libero-select" style="width: 100%; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                            ${liberosHtml}
                        </select>
                        <div style="margin-top: 0.75rem; padding: 1rem; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 8px; font-size: 0.85rem; color: #1e40af; line-height: 1.5;">
                            <strong>‚ÑπÔ∏è Comment fonctionne le lib√©ro ?</strong><br>
                            <ul style="margin: 0.5rem 0 0 1rem; padding: 0;">
                                <li>Le lib√©ro remplace automatiquement les <strong>centraux</strong> quand ils passent en <strong>zone arri√®re</strong> (P1, P5, P6)</li>
                                <li>Il sort automatiquement quand le central revient en <strong>zone avant</strong> (P2, P3, P4)</li>
                                <li>Ces changements ne comptent pas comme des substitutions officielles</li>
                                <li>Si vous s√©lectionnez "Match sans lib√©ro", aucun changement automatique ne sera effectu√©</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="cancelFinalSetup()" style="flex: 1; padding: 1rem; background: #dc2626; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            ‚ùå Annuler
                        </button>
                        <button onclick="confirmFinalSetup()" style="flex: 2; padding: 1rem; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 1.1rem; cursor: pointer;">
                            ‚úÖ Valider et commencer !
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        window.selectedServiceTeam = null;
        
        function selectService(team) {
            window.selectedServiceTeam = team;
            const btn1 = document.getElementById('service-btn-team1-modal');
            const btn2 = document.getElementById('service-btn-team2-modal');
            const selectedDiv = document.getElementById('service-selected');
            
            if (team === 'team1') {
                // Notre √©quipe sert (vert)
                btn1.style.background = '#10b981';
                btn1.style.borderColor = '#065f46';
                btn1.style.transform = 'scale(1.05)';
                // Remettre l'autre en gris
                btn2.style.background = '#9ca3af';
                btn2.style.borderColor = '#6b7280';
                btn2.style.transform = 'scale(1)';
                selectedDiv.textContent = '‚úÖ Notre √©quipe sert en premier';
            } else {
                // √âquipe adverse sert (rouge)
                btn2.style.background = '#ef4444';
                btn2.style.borderColor = '#991b1b';
                btn2.style.transform = 'scale(1.05)';
                // Remettre l'autre en gris
                btn1.style.background = '#9ca3af';
                btn1.style.borderColor = '#6b7280';
                btn1.style.transform = 'scale(1)';
                selectedDiv.textContent = '‚úÖ √âquipe adverse sert en premier';
            }
            
            // Mettre √† jour le bouton "D√©marrer" (il ne sera plus gris√©)
            updateStartRallyButton();
        }
        
        function cancelFinalSetup() {
            const modal = document.getElementById('final-setup-modal');
            if (modal) modal.remove();
        }
        
        function confirmFinalSetup() {
            if (!window.selectedServiceTeam) {
                alert('‚ùå Veuillez s√©lectionner qui sert en premier !');
                return;
            }
            
            serviceTeam = window.selectedServiceTeam;
            
            // R√©cup√©rer le lib√©ro s√©lectionn√©
            const liberoSelect = document.getElementById('libero-select');
            const liberoId = liberoSelect.value;
            
            if (liberoId === 'none') {
                // Match sans lib√©ro - d√©sactiver la gestion automatique du lib√©ro
                courtComposition.libero.enabled = false;
                courtComposition.libero.player = null;
                courtComposition.libero.onCourt = false;
                courtComposition.libero.replacing = null;
                console.log('üö´ Match sans lib√©ro - Gestion automatique d√©sactiv√©e');
            } else if (liberoId && liberoId !== '') {
                // Lib√©ro s√©lectionn√© - activer la gestion automatique
                const matchSetup = JSON.parse(localStorage.getItem('lcvb_current_match'));
                const presentPlayers = matchSetup.homeTeam.presentPlayers || [];
                const liberoPlayer = presentPlayers.find(p => p.id == liberoId);
                
                if (liberoPlayer) {
                    courtComposition.libero.enabled = true;
                    courtComposition.libero.player = liberoPlayer;
                    courtComposition.libero.onCourt = false;
                    courtComposition.libero.replacing = null;
                    console.log('‚úÖ Lib√©ro s√©lectionn√©:', liberoPlayer);
                    console.log('‚úÖ Gestion automatique du lib√©ro activ√©e');
                }
            } else {
                // Aucun lib√©ro s√©lectionn√© - d√©sactiver par d√©faut
                courtComposition.libero.enabled = false;
                courtComposition.libero.player = null;
                courtComposition.libero.onCourt = false;
                courtComposition.libero.replacing = null;
                console.log('‚ö†Ô∏è Aucun lib√©ro s√©lectionn√© - Gestion automatique d√©sactiv√©e');
            }
            
            // Valider
            window.isPositioningMode = false;
            window.startingLineupValidated = true;
            
            // Cacher la banni√®re et le sch√©ma
            const banner = document.getElementById('positioning-instruction-banner');
            const schema = document.getElementById('placement-schema');
            if (banner) banner.style.display = 'none';
            if (schema) schema.style.display = 'none';
            
            console.log('‚úÖ === VALIDATION DU LINEUP ===');
            console.log('  ‚Üí window.isPositioningMode:', window.isPositioningMode);
            console.log('  ‚Üí window.startingLineupValidated:', window.startingLineupValidated);
            console.log('  ‚Üí courtComposition.libero.enabled:', courtComposition.libero.enabled);
            
            // Cacher le bouton de validation
            document.getElementById('validate-lineup-btn').style.display = 'none';
            
            // Fermer le modal
            cancelFinalSetup();
            
            // Mettre √† jour l'affichage
            updateCourtDisplay();
            updateServiceIndicator();
            updateStartRallyButton(); // ‚Üê Mettre √† jour le bouton "D√©marrer"
            
            // ‚úÖ APPELER LA GESTION DU LIB√âRO IMM√âDIATEMENT apr√®s validation
            console.log('üîÑ === V√©rification initiale du lib√©ro ===');
            manageLiberoAfterRotation();
            updateCourtDisplay(); // Rafra√Æchir l'affichage apr√®s changement lib√©ro
            
            // Pas de popup - Le match peut commencer directement
            console.log('‚úÖ Configuration finale:', {courtComposition, serviceTeam});
        }
        
        // ========================================
        //  FIN POSITIONNEMENT PAR CLIC
        // ========================================
        
        function loadCourtComposition() {
            console.log('üîç === D√âBUT loadCourtComposition() ===');
            console.log('  matchSetup:', matchSetup);
            
            if (!matchSetup) {
                console.error('‚ö†Ô∏è matchSetup est NULL ou undefined');
                alert('‚ö†Ô∏è ERREUR : Aucune donn√©e de match !\n\nVeuillez d\'abord configurer le match dans setup.html');
                return;
            }
            
            if (!matchSetup.homeTeam) {
                console.error('‚ö†Ô∏è matchSetup.homeTeam n\'existe pas', matchSetup);
                alert('‚ö†Ô∏è ERREUR : Donn√©es d\'√©quipe manquantes !');
                return;
            }
            
            console.log('  ‚Üí homeTeam:', matchSetup.homeTeam);
            console.log('  ‚Üí homeTeamPositions:', matchSetup.homeTeamPositions);
            console.log('  ‚Üí homeTeamLibero:', matchSetup.homeTeamLibero);
            console.log('  ‚Üí presentPlayers:', matchSetup.homeTeam.presentPlayers);
            
            // M√âTHODE 1 : homeTeamPositions (nouveau format)
            if (matchSetup.homeTeamPositions) {
                console.log('  ‚úÖ M√©thode 1 : homeTeamPositions trouv√©');
                
                if (!matchSetup.homeTeam.presentPlayers) {
                    console.error('  ‚ùå presentPlayers manquant !', matchSetup.homeTeam);
                    alert('‚ö†Ô∏è ERREUR : Liste des joueurs pr√©sents manquante !');
                    return;
                }
                
                for (let pos = 1; pos <= 6; pos++) {
                    const playerId = matchSetup.homeTeamPositions[`pos${pos}`];
                    console.log(`    P${pos}: playerId =`, playerId);
                    
                    if (playerId) {
                        const player = matchSetup.homeTeam.presentPlayers.find(p => p.id == playerId);
                        console.log(`    P${pos}: player =`, player);
                        
                        if (player) {
                            courtComposition.positions[pos] = player;
                        } else {
                            console.warn(`    ‚ö†Ô∏è P${pos}: Joueur avec ID ${playerId} non trouv√© !`);
                        }
                    }
                }
                
                // Charger le lib√©ro
                if (matchSetup.homeTeamLibero) {
                    const libero = matchSetup.homeTeam.presentPlayers.find(p => p.id == matchSetup.homeTeamLibero);
                    console.log('    Lib√©ro:', libero);
                    if (libero) {
                        courtComposition.libero.player = libero;
                        courtComposition.libero.onCourt = false;
                        courtComposition.libero.replacing = null;
                    }
                }
            }
            // M√âTHODE 2 : Fallback automatique
            else {
                console.log('  ‚ö†Ô∏è Fallback : homeTeamPositions absent, utilisation des premiers joueurs');
                const players = matchSetup.homeTeam.presentPlayers || matchSetup.homeTeam.allPlayers || matchSetup.homeTeam.players || [];
                console.log('  ‚Üí Joueurs disponibles:', players.length, players);
                
                if (players.length === 0) {
                    console.error('  ‚ùå Aucun joueur trouv√© !');
                    alert('‚ö†Ô∏è ERREUR : Aucun joueur disponible !\n\nV√©rifiez la configuration dans setup.html');
                    return;
                }
                
                for (let i = 0; i < Math.min(6, players.length); i++) {
                    courtComposition.positions[i + 1] = players[i];
                    console.log(`    P${i+1}: ${players[i].firstName} ${players[i].lastName} #${players[i].number}`);
                }
                
                // Trouver le lib√©ro
                const libero = players.find(p => p.libero || p.isLibero);
                if (libero) {
                    console.log('    Lib√©ro trouv√©:', libero);
                    courtComposition.libero.player = libero;
                    courtComposition.libero.onCourt = false;
                    courtComposition.libero.replacing = null;
                }
            }
            
            updateCourtDisplay();
            initializeRotationTracking();
            console.log('‚úÖ Composition finale:', courtComposition);
            console.log('=== FIN loadCourtComposition() ===\n');
        }

        function initializeRotationTracking() {
            rotationTracker.initialOrder = [];
            for (let pos = 1; pos <= 6; pos++) {
                const player = courtComposition.positions[pos];
                rotationTracker.initialOrder.push(player ? player.id : null);
            }
            rotationTracker.currentIndex = 1;
            console.log('üîÅ Rotation tracker initialis√©', rotationTracker);
        }
        
        // Afficher la composition sur le terrain
        function updateCourtDisplay() {
            document.getElementById('team-court-name').textContent = 
                matchSetup ? matchSetup.homeTeam.name : 'Notre √âquipe';
            
            // Afficher chaque position
            for (let pos = 1; pos <= 6; pos++) {
                const player = courtComposition.positions[pos];
                const posEl = document.getElementById(`court-pos-${pos}`);
                
                if (player && posEl) {
                    posEl.querySelector('.player-number-court').textContent = `#${player.number}`;
                    // Afficher nom + r√¥le (ex: "Pierre R. (Pointu)")
                    const playerPosition = player.position || '';
                    posEl.querySelector('.player-name-court').textContent = 
                        `${player.firstName} ${player.lastName.substring(0, 1)}. (${playerPosition})`;
                } else if (posEl) {
                    posEl.querySelector('.player-number-court').textContent = '-';
                    posEl.querySelector('.player-name-court').textContent = '-';
                }
            }
            
            // Afficher le lib√©ro
            const liberoEl = document.getElementById('libero-info');
            if (courtComposition.libero && courtComposition.libero.player) {
                const libero = courtComposition.libero.player;
                liberoEl.textContent = `#${libero.number} ${libero.firstName} ${libero.lastName}`;
                if (courtComposition.libero.onCourt) {
                    liberoEl.textContent += ' (sur le terrain)';
                }
            } else {
                liberoEl.textContent = 'Aucun';
            }
        }
        
        // D√©marrer une action
        // V√©rifier si on doit choisir qui sert (d√©but de set)
        function checkServiceChoice() {
            const data = LCVBScoreboard.getScoreData();
            
            // Si d√©but de set (score 0-0 et serviceTeam pas d√©fini)
            if (data.team1.score === 0 && data.team2.score === 0 && serviceTeam === null) {
                showServiceChoiceButtons();
                return true; // Bloque le workflow
            }
            return false;
        }
        
        // Afficher les boutons de choix de service
        function showServiceChoiceButtons() {
            const buttonsDiv = document.getElementById('service-choice-buttons');
            const team1Btn = document.getElementById('service-btn-team1');
            const team2Btn = document.getElementById('service-btn-team2');
            
            if (buttonsDiv) {
                // Mettre √† jour les noms d'√©quipe
                const data = LCVBScoreboard.getScoreData();
                const team1Name = matchSetup?.homeTeam?.name || data.team1.name || 'Notre √©quipe';
                const team2Name = matchSetup?.awayTeam?.name || data.team2.name || '√âquipe adverse';
                
                if (team1Btn) team1Btn.textContent = `Service ${team1Name}`;
                if (team2Btn) team2Btn.textContent = `Service ${team2Name}`;
                
                buttonsDiv.style.display = 'block';
            }
        }
        
        // Modal pour choisir qui sert
        function showServiceChoiceModal() {
            const existingModal = document.getElementById('service-choice-modal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'service-choice-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
            `;
            
            const data = LCVBScoreboard.getScoreData();
            const team1Name = matchSetup?.homeTeam?.name || data.team1.name || 'Notre √©quipe';
            const team2Name = matchSetup?.awayTeam?.name || data.team2.name || '√âquipe adverse';
            
            modal.innerHTML = `
                <div style="background: white; padding: 3rem; border-radius: 16px; text-align: center; max-width: 500px;">
                    <h2 style="margin: 0 0 1rem 0; color: #EC4899; font-size: 1.8rem;">üèê D√©but du Set ${data.currentSet}</h2>
                    <p style="font-size: 1.1rem; color: #1a1a1a; margin-bottom: 2rem;">
                        Quelle √©quipe sert en premier ?
                    </p>
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="setInitialService('team1')" style="flex: 1; padding: 1.5rem; background: #10b981; color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer;">
                            ‚úÖ ${team1Name}
                        </button>
                        <button onclick="setInitialService('team2')" style="flex: 1; padding: 1.5rem; background: #ef4444; color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer;">
                            ‚ùå ${team2Name}
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function setInitialService(team) {
            serviceTeam = team;
            
            // Masquer les boutons de choix de service
            const buttonsDiv = document.getElementById('service-choice-buttons');
            if (buttonsDiv) buttonsDiv.style.display = 'none';
            
            // Supprimer le modal si il existe encore (compatibilit√©)
            const modal = document.getElementById('service-choice-modal');
            if (modal) modal.remove();
            
            const teamName = team === 'team1' ? (matchSetup?.homeTeam?.name || 'Notre √©quipe') : (matchSetup?.awayTeam?.name || '√âquipe adverse');
            showNotification(`‚ö° ${teamName} sert en premier !`);
            
            // Mettre √† jour l'affichage
            updateServiceIndicator();
        }
        
        // Mettre √† jour l'indicateur de service
        function updateServiceIndicator() {
            const indicator = document.getElementById('service-indicator');
            if (!indicator) return;
            
            if (serviceTeam === 'team1') {
                indicator.style.display = 'block';
                indicator.textContent = '‚ö° AU SERVICE';
                indicator.style.background = '#10b981';
            } else if (serviceTeam === 'team2') {
                indicator.style.display = 'block';
                indicator.textContent = '‚ùå Adverse au service';
                indicator.style.background = '#ef4444';
            } else {
                indicator.style.display = 'none';
            }
        }
        
        // D√©marrer le workflow du point (automatique selon le service)
        function startRallyWorkflow() {
            // V√©rifier si on doit choisir qui sert au d√©but du set
            if (checkServiceChoice()) return;
            
            // Workflow selon qui sert
            if (serviceTeam === 'team1') {
                // ‚ö° ON SERT ‚Üí Service automatique du joueur en P1
                startOurServiceWorkflow();
            } else if (serviceTeam === 'team2') {
                // ‚ùå ILS SERVENT ‚Üí On r√©ceptionne
                startReceptionWorkflow();
            } else {
                alert('‚ö†Ô∏è Erreur : Service non d√©fini !');
            }
        }
        
        // Workflow : ON SERT
        function startOurServiceWorkflow() {
            rallyData = {
                actions: [],
                currentStep: 2,
                actionType: 'our_service',
                selectedPlayer: courtComposition.positions[1], // Serveur = P1
                rallyResult: null
            };
            
            // Aller directement √† l'√©tape 3 (qualit√© du service)
            document.getElementById('step-1').style.display = 'none';
            document.getElementById('step-2').style.display = 'none';
            document.getElementById('step-3').style.display = 'block';
            document.querySelector('.workflow-step-indicator').textContent = '√âtape 2/3';
            
            // ‚úÖ VIDER l'affichage du joueur s√©lectionn√© (pour coh√©rence)
            const selectedPlayerInfo = document.getElementById('selected-player-info');
            if (selectedPlayerInfo) {
                selectedPlayerInfo.innerHTML = '';
            }
            
            const serverP1 = courtComposition.positions[1];
            if (serverP1) {
                document.getElementById('step-3-title').textContent = `2Ô∏è‚É£ Service de #${serverP1.number} ${serverP1.firstName}`;
                document.querySelector('.workflow-instruction').textContent = 'Qualit√© du service ?';
                
                document.getElementById('step-3-buttons').innerHTML = `
                    <button class="btn-workflow success" onclick="serviceResult('ace')">‚≠ê ACE</button>
                    <button class="btn-workflow danger" onclick="serviceResult('fault')">‚ùå Faute</button>
                    <button class="btn-workflow" onclick="serviceResult('in')">‚úì En jeu</button>
                `;
            }
            
            updateActionSummary();
        }
        
        // Workflow : ILS SERVENT ‚Üí On r√©ceptionne
        function startReceptionWorkflow() {
            rallyData = {
                actions: [],
                currentStep: 2,
                actionType: 'receive',
                selectedPlayer: null,
                rallyResult: null
            };
            
            // Cacher √©tape 1, montrer √©tape 2
            document.getElementById('step-1').style.display = 'none';
            document.getElementById('step-2').style.display = 'block';
            document.querySelector('.workflow-step-indicator').textContent = '√âtape 1/3';
            
            document.getElementById('step-2-title').textContent = '1Ô∏è‚É£ Qui r√©ceptionne ?';
            document.querySelector('.workflow-instruction').textContent = 'Cliquez sur le joueur qui r√©ceptionne';
            
            // ‚úÖ VIDER l'affichage du joueur s√©lectionn√© (aucun joueur par d√©faut)
            const selectedPlayerInfo = document.getElementById('selected-player-info');
            if (selectedPlayerInfo) {
                selectedPlayerInfo.innerHTML = '';
            }
            
            updateActionSummary();
        }
        
        function startAction(type) {
            // Ancienne fonction - gard√©e pour compatibilit√©
            startRallyWorkflow();
        }
        
        // S√©lectionner un joueur sur le terrain
        function selectPlayerForAction(position) {
            console.log(`üéØ === selectPlayerForAction appel√©e ===`);
            console.log(`  ‚Üí Position: P${position}`);
            console.log(`  ‚Üí rallyData.currentStep: ${rallyData.currentStep}`);
            console.log(`  ‚Üí rallyData.actionType: ${rallyData.actionType}`);
            console.log(`  ‚Üí window.isPositioningMode: ${window.isPositioningMode}`);
            
            if (rallyData.currentStep !== 2) {
                console.log(`  ‚ùå √âtape incorrecte, return`);
                return;
            }
            
            const player = courtComposition.positions[position];
            if (!player) {
                alert('Aucun joueur √† cette position');
                return;
            }
            
            console.log(`  ‚úÖ Joueur s√©lectionn√©: #${player.number} ${player.firstName}`);
            rallyData.selectedPlayer = {position, player};
            
            // Afficher le joueur s√©lectionn√©
            document.getElementById('selected-player-info').innerHTML = 
                `<div style="padding:1rem; background:#dcfce7; border-radius:8px; margin-top:1rem;">
                    ‚úÖ <strong>#${player.number} ${player.firstName} ${player.lastName}</strong> (Poste P${position})
                </div>`;
            
            // Passer √† l'√©tape 3
            setTimeout(() => {
                rallyData.currentStep = 3;
                showStep3();
            }, 500);
        }
        
        // √âtape 3: R√©sultat de l'action
        function showStep3() {
            document.getElementById('step-2').style.display = 'none';
            document.getElementById('step-3').style.display = 'block';
            document.querySelector('.workflow-step-indicator').textContent = '√âtape 3/4';
            
            const buttonsHtml = rallyData.actionType === 'our_service' ?
                `<button class="btn-workflow success" onclick="serviceResult('ace')">üéØ ACE</button>
                 <button class="btn-workflow danger" onclick="serviceResult('fault')">‚ùå Faute</button>
                 <button class="btn-workflow" onclick="serviceResult('in')">‚úÖ En jeu</button>` :
                `<button class="btn-workflow success" onclick="receiveResult('perfect')">‚≠ê Parfaite</button>
                 <button class="btn-workflow warning" onclick="receiveResult('average')">üü° Moyenne</button>
                 <button class="btn-workflow danger" onclick="receiveResult('failed_end')">‚ùå Rat√©e (point fini)</button>
                 <button class="btn-workflow warning" onclick="receiveResult('failed_continue')">‚ö†Ô∏è Rat√©e (point continue)</button>`;
            
            document.getElementById('step-3-buttons').innerHTML = buttonsHtml;
            updateActionSummary();
        }
        
        // R√©sultat du service
        function serviceResult(result) {
            rallyData.actions.push({
                type: 'service',
                player: rallyData.selectedPlayer,
                result: result
            });
            
            if (result === 'ace') {
                // Point direct !
                endRally('us', 'ace');
            } else if (result === 'fault') {
                // Faute = point adverse
                endRally('them', 'service_fault');
            } else {
                // Service en jeu ‚Üí Directement "Leur attaque" (on ne suit pas leur r√©ception)
                showTheirAttackOptions();
            }
        }
        
        // Afficher les options de "Leur attaque" (apr√®s notre service "En jeu")
        function showTheirAttackOptions() {
            document.getElementById('step-1').style.display = 'none';
            document.getElementById('step-2').style.display = 'none';
            document.getElementById('step-3').style.display = 'none';
            document.getElementById('step-4').style.display = 'block';
            document.getElementById('step-4-title').textContent = 'üõ°Ô∏è Leur attaque';
            document.querySelector('.workflow-instruction').textContent = 'R√©sultat de leur attaque ?';
            
            document.getElementById('step-4-buttons').innerHTML = `
                <button class="btn-workflow danger" onclick="theirAttackResult('point')">‚ùå Point (eux)</button>
                <button class="btn-workflow success" onclick="theirAttackResult('blocked')">üõ°Ô∏è Bloqu√©e (nous)</button>
                <button class="btn-workflow success" onclick="theirAttackResult('out')">üì§ Out</button>
                <button class="btn-workflow" onclick="theirAttackResult('defended')">‚Ü©Ô∏è D√©fendue</button>
            `;
            
            updateActionSummary();
        }
        
        // R√©sultat de leur attaque
        function theirAttackResult(result) {
            rallyData.actions.push({
                type: 'their_attack',
                result: result
            });
            
            if (result === 'point') {
                endRally('them', 'opponent_attack_point');
            } else if (result === 'blocked') {
                endRally('us', 'block_point');
            } else if (result === 'out') {
                endRally('us', 'opponent_attack_out');
            } else if (result === 'defended') {
                // D√©fendue ‚Üí Notre contre-attaque sans popup
                showNotification('üí™ Leur attaque d√©fendue ! On contre-attaque.');
                askOurAttacker();
            }
        }
        
        // R√©sultat de la r√©ception
        function receiveResult(quality) {
            // Normaliser la qualit√© pour l'enregistrement
            const recordedQuality = quality === 'failed_end' || quality === 'failed_continue' ? 'failed' : quality;
            
            rallyData.actions.push({
                type: 'reception',
                player: rallyData.selectedPlayer,
                quality: recordedQuality
            });
            
            if (quality === 'failed_end') {
                // R√©ception rat√©e (point fini) = point adverse
                endRally('them', 'reception_failed');
            } else if (quality === 'failed_continue') {
                // R√©ception rat√©e (point continue) ‚Üí Notre attaque sans popup
                showNotification('‚ö†Ô∏è R√©ception rat√©e mais le point continue !');
                askOurAttacker();
            } else {
                // R√©ception r√©ussie (parfaite ou moyenne) ‚Üí On attaque !
                askOurAttacker();
            }
        }
        
        // Demander qui attaque (chez nous)
        function askOurAttacker() {
            document.getElementById('step-3').style.display = 'none';
            document.getElementById('step-4').style.display = 'block';
            document.getElementById('step-4-title').textContent = '4Ô∏è‚É£ Qui attaque ?';
            document.querySelector('.workflow-instruction').textContent = 'Cliquez sur le joueur qui attaque';
            document.querySelector('.workflow-step-indicator').textContent = '√âtape 4/4';
            
            document.getElementById('step-4-buttons').innerHTML = `
                <div style="padding: 1rem; background: #fef3c7; border-radius: 8px; color: #92400e; font-weight: 600; text-align: center; margin-bottom: 1rem;">
                    ‚òùÔ∏è Cliquez sur le joueur qui attaque sur le terrain
                </div>
            `;
            
            // Changer le mode pour accepter la s√©lection d'attaquant
            rallyData.currentStep = 4.1; // √âtat sp√©cial pour s√©lection attaquant
            rallyData.waitingForAttacker = true;
            
            updateActionSummary();
        }
        
        // Modifier selectPlayerForAction pour g√©rer la s√©lection de l'attaquant
        const originalSelectPlayerForAction = selectPlayerForAction;
        selectPlayerForAction = function(position) {
            console.log(`üîÑ === WRAPPER selectPlayerForAction ===`);
            console.log(`  ‚Üí Position: P${position}`);
            console.log(`  ‚Üí waitingForAttacker: ${rallyData.waitingForAttacker}`);
            console.log(`  ‚Üí currentStep: ${rallyData.currentStep}`);
            console.log(`  ‚Üí window.isPositioningMode: ${window.isPositioningMode}`);
            
            // Si on attend un attaquant
            if (rallyData.waitingForAttacker && rallyData.currentStep === 4.1) {
                console.log(`  ‚Üí Mode attaquant d√©tect√©`);
                const player = courtComposition.positions[position];
                if (!player) {
                    alert('Aucun joueur √† cette position');
                    return;
                }
                
                rallyData.selectedAttacker = {position, player};
                rallyData.waitingForAttacker = false;
                rallyData.attackMeta = rallyData.attackMeta || { type: 'power', tempo: 'tempo3' };
                renderAttackOptions();
                updateActionSummary();
                return;
            }
            
            // Sinon, comportement normal
            console.log(`  ‚Üí Appel de la fonction originale`);
            originalSelectPlayerForAction(position);
        };

        function renderAttackOptions() {
            const container = document.getElementById('step-4-buttons');
            if (!container) return;
            const attacker = rallyData.selectedAttacker;
            if (!attacker) return;

            const meta = rallyData.attackMeta || { type: 'power', tempo: 'tempo3' };

            const typeButtons = ATTACK_TYPES.map(item => {
                const isSelected = meta.type === item.key;
                const style = `
                    padding:0.45rem 0.85rem;
                    border-radius:999px;
                    border:2px solid ${isSelected ? '#10b981' : '#d1d5db'};
                    background:${isSelected ? '#ecfdf5' : '#f9fafb'};
                    color:${isSelected ? '#065f46' : '#374151'};
                    font-weight:600;
                    cursor:pointer;
                    transition:all 0.2s;
                `;
                return `<button style="${style}" onclick="setAttackType('${item.key}')">${item.icon} ${item.label}</button>`;
            }).join('');

            const tempoButtons = ATTACK_TEMPOS.map(item => {
                const isSelected = meta.tempo === item.key;
                const style = `
                    padding:0.45rem 0.85rem;
                    border-radius:999px;
                    border:2px solid ${isSelected ? '#2563eb' : '#d1d5db'};
                    background:${isSelected ? '#dbeafe' : '#f9fafb'};
                    color:${isSelected ? '#1e3a8a' : '#374151'};
                    font-weight:600;
                    cursor:pointer;
                    transition:all 0.2s;
                `;
                return `<button style="${style}" onclick="setAttackTempo('${item.key}')">${item.icon} ${item.label}</button>`;
            }).join('');

            const resultButtons = `
                    <button class="btn-workflow success" onclick="attackResult('point')">‚úÖ Point direct</button>
                    <button class="btn-workflow success" onclick="attackResult('block_out')">‚úÖ Bloc gagnant (block out)</button>
                    <button class="btn-workflow success" onclick="attackResult('second_touch')">‚ú® Seconde main (point passeur)</button>
                    <button class="btn-workflow danger" onclick="attackResult('blocked_in')">‚ùå Bloc perdant (bloc in)</button>
                    <button class="btn-workflow danger" onclick="attackResult('out')">‚ùå Attaque out</button>
                    <button class="btn-workflow danger" onclick="attackResult('net')">‚ùå Dans le filet</button>
                    <button class="btn-workflow warning" onclick="attackResult('defended')">‚Ü©Ô∏è D√©fendu (continue)</button>
                    <button class="btn-workflow warning" onclick="attackResult('unattackable_continue')">‚ö†Ô∏è Balle non attaquable (continue)</button>
                    <button class="btn-workflow danger" onclick="attackResult('unattackable_lost')">‚ùå Balle non attaquable (point perdu)</button>
                `;
                
            container.innerHTML = `
                <div style="padding: 1rem; background: #dcfce7; border-radius: 8px; margin-bottom: 1rem;">
                    ‚úÖ Attaquant : <strong>#${attacker.player.number} ${attacker.player.firstName} ${attacker.player.lastName}</strong>
                </div>
                <div style="margin-bottom:0.85rem;">
                    <div style="font-weight:600; color:#111827; margin-bottom:0.35rem;">üé≠ Type d'attaque</div>
                    <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">${typeButtons}</div>
                </div>
                <div style="margin-bottom:1rem;">
                    <div style="font-weight:600; color:#111827; margin-bottom:0.35rem;">‚ö° Tempo</div>
                    <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">${tempoButtons}</div>
                </div>
                <div style="display:grid; gap:0.5rem;">${resultButtons}</div>
            `;
        }

        function setAttackType(typeKey) {
            rallyData.attackMeta = rallyData.attackMeta || { type: 'power', tempo: 'tempo3' };
            rallyData.attackMeta.type = typeKey;
            renderAttackOptions();
        }

        function setAttackTempo(tempoKey) {
            rallyData.attackMeta = rallyData.attackMeta || { type: 'power', tempo: 'tempo3' };
            rallyData.attackMeta.tempo = tempoKey;
            renderAttackOptions();
        }
        
        // R√©sultat de notre attaque
        function attackResult(result) {
            const attackMeta = rallyData.attackMeta || { type: 'power', tempo: 'tempo3' };
            rallyData.actions.push({
                type: 'our_attack',
                player: rallyData.selectedAttacker,
                result: result,
                attackType: attackMeta.type,
                attackTempo: attackMeta.tempo
            });
            
            // Cas qui terminent le point
            if (result === 'point') {
                endRally('us', 'attack_point');
            } else if (result === 'block_out') {
                // Bloc gagnant (block out) ‚Üí Le bloc adverse envoie la balle dehors ‚Üí NOUS gagnons
                endRally('us', 'block_out');
            } else if (result === 'second_touch') {
                // ‚ú® Seconde main (point passeur) ‚Üí Point pour nous, attribu√© au passeur
                // On cherche le passeur dans l'√©quipe (position "Passeur")
                let setter = null;
                for (let pos = 1; pos <= 6; pos++) {
                    const player = courtComposition.positions[pos];
                    if (player && (player.position === 'Passeur' || player.position === 'Passeuse')) {
                        setter = {position: pos, player: player};
                        break;
                    }
                }
                
                if (setter) {
                    // Remplacer l'attaquant par le passeur dans la derni√®re action
                    rallyData.actions[rallyData.actions.length - 1].player = setter;
                    showNotification(`‚ú® Seconde main du passeur #${setter.player.number} ${setter.player.firstName} !`);
                } else {
                    showNotification('‚ú® Seconde main (point pour nous) !');
                }
                
                endRally('us', 'second_touch_point');
            } else if (result === 'blocked_in') {
                // Bloc perdant (bloc in) ‚Üí Le bloc adverse garde la balle ‚Üí EUX gagnent
                endRally('them', 'attack_blocked_in');
            } else if (result === 'out') {
                // Attaque out ‚Üí EUX gagnent
                endRally('them', 'attack_out');
            } else if (result === 'net') {
                // Dans le filet ‚Üí EUX gagnent
                endRally('them', 'attack_net');
            } else if (result === 'defended') {
                // D√©fendu ‚Üí Retour √† "Leur attaque" sans popup
                showNotification('üí™ Balle d√©fendue ! Retour en d√©fense.');
                
                // Garder les actions pr√©c√©dentes et passer √† "Leur attaque"
                showTheirAttackOptions();
            } else if (result === 'unattackable_continue') {
                // ‚ö†Ô∏è Balle non attaquable (continue) ‚Üí Retour √† "Leur attaque" sans popup
                showNotification('‚ö†Ô∏è Balle non attaquable ! La balle retourne chez eux.');
                
                // Garder les actions pr√©c√©dentes et passer √† "Leur attaque"
                showTheirAttackOptions();
            } else if (result === 'unattackable_lost') {
                // ‚ùå Balle non attaquable (point perdu) ‚Üí EUX gagnent
                endRally('them', 'unattackable_ball');
            }
        }
        
        // Terminer le point
        function endRally(winner, reason) {
            rallyData.rallyResult = {winner, reason};
            const scoreDataBefore = LCVBScoreboard.getScoreData();
            const scoreBefore = {
                team1: scoreDataBefore?.team1?.score ?? 0,
                team2: scoreDataBefore?.team2?.score ?? 0
            };
            const serviceBefore = serviceTeam;
            const rotationBefore = rotationTracker.currentIndex || 1;
            
            const weWon = (winner === 'us');
            const weHadService = (serviceTeam === 'team1');
            
            // 1. Mettre √† jour le score
            if (weWon) {
                changeScore('team1', 1);
            } else {
                changeScore('team2', 1);
            }
            
            // 2. G√©rer le changement de service + rotation
            if (weWon && !weHadService) {
                // ‚úÖ ON R√âCUP√àRE le service ‚Üí NOUS tournons
                console.log('üîÑ ON r√©cup√®re le service ‚Üí Rotation de notre √©quipe');
                serviceTeam = 'team1';
                rotateOurTeam();
                manageLiberoAfterRotation(); // G√©rer le lib√©ro apr√®s rotation
            } else if (!weWon && weHadService) {
                // ‚ùå ILS R√âCUP√àRENT le service ‚Üí EUX tournent (on simule juste l'√©tat)
                console.log('üîÑ ILS r√©cup√®rent le service');
                serviceTeam = 'team2';
                // On ne g√®re pas leur rotation visuellement
            }
            // Sinon : conservation du service ‚Üí PAS de rotation
            
            // ‚úÖ TOUJOURS v√©rifier le lib√©ro apr√®s chaque point (m√™me sans rotation)
            // Car le service peut changer (team1 ‚Üí team2) et donc la r√®gle P1 change
            manageLiberoAfterRotation();
            
            // 3. V√©rifier que le serveur n'est pas le lib√©ro
            if (serviceTeam === 'team1') {
                const serverP1 = courtComposition.positions[1];
                if (serverP1 && serverP1.isLibero) {
                    setTimeout(() => {
                        alert('‚ö†Ô∏è ATTENTION !\n\nLe lib√©ro ne peut pas servir !\nIl doit sortir avant le service.');
                    }, 500);
                }
            }
            
            // 4. Enregistrer les stats
            const scoreDataAfter = LCVBScoreboard.getScoreData();
            const scoreAfter = {
                team1: scoreDataAfter?.team1?.score ?? 0,
                team2: scoreDataAfter?.team2?.score ?? 0
            };

            rallyData.metadata = {
                serviceBefore,
                serviceAfter: serviceTeam,
                rotationBefore,
                rotationAfter: rotationTracker.currentIndex || rotationBefore,
                scoreBefore,
                scoreAfter
            };

            matchStats.rallies.push({
                ...rallyData,
                timestamp: new Date().toISOString(),
                setNumber: LCVBScoreboard.getScoreData().currentSet
            });
            
            console.log('üìä Point termin√©:', rallyData);
            
            // 5. Mettre √† jour l'indicateur de service
            updateServiceIndicator();
            
            // 6. R√©initialiser le workflow
            resetWorkflow();
            
            // 7. Mettre √† jour l'affichage du terrain
            updateCourtDisplay();
            
            // 8. Mettre √† jour l'historique du set en cours
            updateCurrentSetHistory();
            
            // 8.5. Mettre √† jour les statistiques du match
            updateMatchStats();
            
            // 9. Mettre √† jour le bouton "D√©marrer" (texte dynamique)
            updateStartRallyButton();
            
            // 10. Feedback
            showNotification(`${weWon ? '‚úÖ Point pour nous' : '‚ùå Point adverse'} (${reason})`);
        }
        
        // V√©rifier si on avait le service
        function weHadService() {
            // TODO: Tracker le service actuel
            // Pour l'instant, on suppose que si on a commenc√© par "our_service", on l'avait
            return rallyData.actionType === 'our_service';
        }
        
        // Rotation de notre √©quipe
        function rotateOurTeam() {
            console.log('üîÑ Rotation de notre √©quipe (sens horaire)');
            
            rotationTracker.currentIndex = (rotationTracker.currentIndex % 6) + 1;
            
            // Rotation horaire: P1‚ÜíP6‚ÜíP5‚ÜíP4‚ÜíP3‚ÜíP2‚ÜíP1
            const newPositions = {};
            newPositions[1] = courtComposition.positions[2];  // P2 devient P1 (serveur)
            newPositions[2] = courtComposition.positions[3];  // P3 devient P2
            newPositions[3] = courtComposition.positions[4];  // P4 devient P3
            newPositions[4] = courtComposition.positions[5];  // P5 devient P4
            newPositions[5] = courtComposition.positions[6];  // P6 devient P5
            newPositions[6] = courtComposition.positions[1];  // P1 devient P6
            
            courtComposition.positions = newPositions;
            
            console.log('‚úÖ Rotation effectu√©e', courtComposition.positions);
            console.log('üîÅ Index de rotation actuel:', rotationTracker.currentIndex);
            
            updateCourtDisplay();
            showNotification('üîÑ Rotation effectu√©e');
        }
        
        // G√©rer les entr√©es/sorties lib√©ro automatiques
        // Gestion automatique du lib√©ro apr√®s rotation
        // ‚úÖ R√àGLE : Le lib√©ro remplace N'IMPORTE QUEL central en P1/P5/P6 (SAUF P1 quand on sert)
        function manageLiberoAfterRotation() {
            if (!courtComposition.libero.enabled) {
                console.log('üö´ Gestion automatique du lib√©ro d√©sactiv√©e (match sans lib√©ro)');
                return;
            }
            
            if (!courtComposition.libero.player) {
                console.log('‚ÑπÔ∏è Pas de lib√©ro d√©fini');
                return;
            }
            
            console.log('üîç V√©rification lib√©ro apr√®s rotation...');
            console.log(`  ‚Üí serviceTeam: ${serviceTeam} (team1 = nous)`);
            
            // PRIORIT√â 1 : V√©rifier si le LIB√âRO est en position AVANT (P2, P3, P4) ‚Üí Il doit sortir IMM√âDIATEMENT
            for (let pos = 1; pos <= 6; pos++) {
                const player = courtComposition.positions[pos];
                if (!player) continue;
                
                if (player.isLibero && courtComposition.libero.onCourt) {
                    console.log(`  ‚Üí Lib√©ro #${player.number} en P${pos}`);
                    
                    // Le lib√©ro est en position AVANT ‚Üí SORTIE IMM√âDIATE
                    if ([2, 3, 4].includes(pos)) {
                        const centralReplaced = courtComposition.libero.replacing;
                        if (centralReplaced) {
                            console.log(`  ‚ùå Lib√©ro en P${pos} (AVANT) ‚Üí SORT imm√©diatement, #${centralReplaced.number} revient`);
                            
                            // Remettre le central √† la place du lib√©ro
                            courtComposition.positions[pos] = centralReplaced;
                            
                            courtComposition.libero.onCourt = false;
                            courtComposition.libero.replacing = null;
                            
                            showNotification(`üîÑ Lib√©ro sort, #${centralReplaced.number} revient en P${pos}`);
                            return;
                        }
                    }
                }
            }
            
            // PRIORIT√â 2 : Chercher N'IMPORTE QUEL Central en zone ARRI√àRE (P1, P5, P6)
            // ‚úÖ NOUVELLE R√àGLE : Le lib√©ro peut remplacer LES DEUX centraux dynamiquement
            for (let pos = 1; pos <= 6; pos++) {
                const player = courtComposition.positions[pos];
                if (!player) continue;
                
                // ‚úÖ CORRECTION : V√©rifier "Central" OU "Centrale" (masculin/f√©minin)
                const isCentral = player.position === 'Central' || player.position === 'Centrale';
                
                // Si c'est un Central en zone arri√®re
                if (isCentral && [1, 5, 6].includes(pos)) {
                    console.log(`  ‚Üí Central #${player.number} (${player.position}) en P${pos}`);
                    
                    // ‚ö†Ô∏è EXCEPTION : Si c'est P1 ET qu'on a le service ‚Üí PAS de lib√©ro (car le lib√©ro ne peut pas servir)
                    if (pos === 1 && serviceTeam === 'team1') {
                        console.log(`  ‚ö†Ô∏è Central #${player.number} en P1 mais ON SERT ‚Üí Lib√©ro NE PEUT PAS entrer (lib√©ro ne peut pas servir)`);
                        continue; // Passer au prochain central
                    }
                    
                    // Sinon, le lib√©ro entre pour ce central
                    if (!courtComposition.libero.onCourt) {
                        console.log(`  ‚úÖ Lib√©ro ENTRE pour #${player.number} en P${pos}`);
                        courtComposition.libero.onCourt = true;
                        courtComposition.libero.replacing = player;
                        
                        // Remplacer le central par le lib√©ro
                        const liberoPlayer = {...courtComposition.libero.player, isLibero: true};
                        courtComposition.positions[pos] = liberoPlayer;
                        
                        showNotification(`üîÑ Lib√©ro #${liberoPlayer.number} entre pour #${player.number} en P${pos}`);
                        return; // Une seule action √† la fois
                    }
                }
            }
            
            console.log('  ‚Üí Aucun changement de lib√©ro n√©cessaire');
        }
        
        // Annuler l'action en cours
        function cancelAction() {
            resetWorkflow();
        }
        
        // R√©initialiser le workflow
        function resetWorkflow() {
            rallyData = {
                actions: [],
                currentStep: 1,
                actionType: null,
                selectedPlayer: null,
                selectedAttacker: null,
                waitingForAttacker: false,
                rallyResult: null,
                attackMeta: null
            };
            
            // R√©afficher √©tape 1
            document.getElementById('step-1').style.display = 'block';
            document.getElementById('step-2').style.display = 'none';
            document.getElementById('step-3').style.display = 'none';
            document.getElementById('step-4').style.display = 'none';
            
            // ‚úÖ VIDER l'affichage du joueur s√©lectionn√© (correction du bug)
            const selectedPlayerInfo = document.getElementById('selected-player-info');
            if (selectedPlayerInfo) {
                selectedPlayerInfo.innerHTML = '';
            }
            
            document.querySelector('.workflow-step-indicator').textContent = '√âtape 1/4';
            document.querySelector('.workflow-instruction').textContent = 'Qui sert ? (ou qui re√ßoit le service adverse)';
            
            updateActionSummary();
        }
        
        // Mettre √† jour le r√©sum√© de l'action
        function updateActionSummary() {
            let summary = 'Aucune action en cours';
            
            if (rallyData.actions.length > 0) {
                summary = rallyData.actions.map(a => {
                    if (a.type === 'service') {
                        const player = a.player ? `#${a.player.player.number} ${a.player.player.firstName}` : '';
                        const result = a.result === 'ace' ? 'ACE ‚≠ê' : (a.result === 'fault' ? 'Faute ‚ùå' : 'En jeu ‚úì');
                        return `Service ${player} ‚Üí ${result}`;
                    } else if (a.type === 'reception') {
                        const player = a.player ? `#${a.player.player.number} ${a.player.player.firstName}` : '';
                        const quality = a.quality === 'perfect' ? 'Parfaite ‚≠ê' : (a.quality === 'average' ? 'Moyenne üü°' : 'Rat√©e ‚ùå');
                        return `R√©ception ${player} ‚Üí ${quality}`;
                    } else if (a.type === 'their_attack') {
                        const result = a.result === 'point' ? 'Point (eux) ‚ùå' : (a.result === 'blocked' ? 'Bloqu√©e ‚úì' : (a.result === 'out' ? 'Out ‚úì' : 'D√©fendue ‚úì'));
                        return `Leur attaque ‚Üí ${result}`;
                    } else if (a.type === 'our_attack') {
                        const player = a.player ? `#${a.player.player.number} ${a.player.player.firstName}` : '';
                        const result = a.result === 'point' ? 'Point ‚úì' : (a.result === 'block_out' ? 'Point (bloc out) ‚úì' : (a.result === 'blocked_in' ? 'Bloqu√©e ‚ùå' : (a.result === 'out' ? 'Out ‚ùå' : (a.result === 'net' ? 'Filet ‚ùå' : a.result))));
                        const typeLabel = ATTACK_TYPES.find(t => t.key === a.attackType)?.label;
                        const tempoLabel = ATTACK_TEMPOS.find(t => t.key === a.attackTempo)?.label;
                        const metaParts = [];
                        if (typeLabel) metaParts.push(typeLabel);
                        if (tempoLabel) metaParts.push(tempoLabel);
                        const metaSuffix = metaParts.length ? ` (${metaParts.join(' ‚Ä¢ ')})` : '';
                        return `Attaque ${player} ‚Üí ${result}${metaSuffix}`;
                    }
                    return a.type;
                }).join(' ‚Ä¢ ');
            }
            
            document.getElementById('action-summary-text').textContent = summary;
        }
        
        // Actions directes - Point direct (faute directe)
        function directPoint(team) {
            const teamName = team === 'us' ? (matchSetup?.homeTeam?.clubName || matchSetup?.homeTeam?.name || 'Nous') : (matchSetup?.awayTeam?.name || 'Eux');
            
            const weWon = (team === 'us');
            const weHadService = (serviceTeam === 'team1');
            
            // 1. Ajouter le point
            if (team === 'us') {
                changeScore('team1', 1);
                showNotification(`‚úÖ Point pour ${teamName} (Faute directe)`);
            } else {
                changeScore('team2', 1);
                showNotification(`‚ùå Point pour ${teamName} (Faute directe)`);
            }
            
            // 2. G√©rer le changement de service + rotation (EXACTEMENT comme endRally)
            if (weWon && !weHadService) {
                // ‚úÖ ON R√âCUP√àRE le service ‚Üí NOUS tournons
                console.log('üîÑ [Direct Point] ON r√©cup√®re le service ‚Üí Rotation de notre √©quipe');
                serviceTeam = 'team1';
                rotateOurTeam();
                manageLiberoAfterRotation(); // G√©rer le lib√©ro apr√®s rotation
            } else if (!weWon && weHadService) {
                // ‚ùå ILS R√âCUP√àRENT le service ‚Üí EUX tournent (on simule juste l'√©tat)
                console.log('üîÑ [Direct Point] ILS r√©cup√®rent le service');
                serviceTeam = 'team2';
                // On ne g√®re pas leur rotation visuellement
            }
            // Sinon : conservation du service ‚Üí PAS de rotation
            
            // ‚úÖ TOUJOURS v√©rifier le lib√©ro apr√®s chaque point (m√™me sans rotation)
            // Car le service peut changer (team1 ‚Üí team2) et donc la r√®gle P1 change
            manageLiberoAfterRotation();
            
            // 3. V√©rifier que le serveur n'est pas le lib√©ro
            if (serviceTeam === 'team1') {
                const serverP1 = courtComposition.positions[1];
                if (serverP1 && serverP1.isLibero) {
                    setTimeout(() => {
                        alert('‚ö†Ô∏è ATTENTION !\n\nLe lib√©ro ne peut pas servir !\nIl doit sortir avant le service.');
                    }, 500);
                }
            }
            
            // 4. Garder les actions du point en cours avant de r√©initialiser
            const actionsBeforeReset = [...rallyData.actions];
            
            matchStats.rallies.push({
                type: 'direct_point',
                winner: team,
                reason: 'Faute directe', // Toujours "Faute directe"
                actions: actionsBeforeReset,
                timestamp: new Date().toISOString(),
                setNumber: LCVBScoreboard.getScoreData().currentSet
            });
            
            // 5. Mettre √† jour l'indicateur de service
            updateServiceIndicator();
            
            // 6. Mettre √† jour l'affichage du terrain
            updateCourtDisplay();
            
            // 7. Mettre √† jour l'historique
            updateCurrentSetHistory();
            
            // 7.5. Mettre √† jour les statistiques du match
            updateMatchStats();
            
            // 8. Mettre √† jour le bouton "D√©marrer"
            updateStartRallyButton();
            
            // 9. R√©initialiser le workflow
            resetWorkflow();
            
            // 10. Feedback
            showNotification(`${weWon ? '‚úÖ Point pour nous' : '‚ùå Point adverse'} (Faute directe)`);
        }
        
        // timeoutsCount d√©clar√© en haut (ligne 1031) - pas de doublon
        let timeoutTimerInterval = null;
        
        function directCard() {
            // Cr√©er la modal pour les cartons
            const existingModal = document.getElementById('card-modal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'card-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const ourTeamName = matchSetup?.homeTeam?.name || 'Notre √©quipe';
            const theirTeamName = matchSetup?.awayTeam?.name || '√âquipe adverse';
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 16px; max-width: 500px; width: 100%;">
                    <h2 style="margin: 0 0 1rem 0; color: #f59e0b; text-align: center;">üü®üü• Carton</h2>
                    <p style="text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">
                        S√©lectionnez l'√©quipe et la couleur
                    </p>
                    
                    <h3 style="margin: 0 0 0.75rem 0; font-size: 1rem; color: #1a1a1a;">√âquipe :</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1.5rem;">
                        <button onclick="window.selectedCardTeam='us'; updateCardTeamSelection()" id="card-team-us" class="card-team-btn" style="padding: 1rem; background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            ${ourTeamName}
                        </button>
                        <button onclick="window.selectedCardTeam='them'; updateCardTeamSelection()" id="card-team-them" class="card-team-btn" style="padding: 1rem; background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            ${theirTeamName}
                        </button>
                    </div>
                    
                    <h3 style="margin: 0 0 0.75rem 0; font-size: 1rem; color: #1a1a1a;">Couleur :</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1.5rem;">
                        <button onclick="window.selectedCardColor='jaune'; updateCardColorSelection()" id="card-color-jaune" class="card-color-btn" style="padding: 1rem; background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            üü® Jaune
                        </button>
                        <button onclick="window.selectedCardColor='rouge'; updateCardColorSelection()" id="card-color-rouge" class="card-color-btn" style="padding: 1rem; background: #fee2e2; border: 2px solid #ef4444; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                            üü• Rouge
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 0.75rem;">
                        <button onclick="closeCardModal()" style="flex: 1; padding: 0.75rem; background: #64748b; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            ‚úñ Annuler
                        </button>
                        <button id="btn-validate-card" onclick="validateCard()" disabled style="flex: 1; padding: 0.75rem; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; opacity: 0.5;">
                            ‚úì Valider
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialiser les s√©lections
            window.selectedCardTeam = null;
            window.selectedCardColor = null;
        }
        
        function updateCardTeamSelection() {
            document.querySelectorAll('.card-team-btn').forEach(btn => {
                btn.style.background = '#f3f4f6';
                btn.style.borderColor = '#e5e7eb';
            });
            
            if (window.selectedCardTeam) {
                const btn = document.getElementById(`card-team-${window.selectedCardTeam}`);
                if (btn) {
                    btn.style.background = '#dbeafe';
                    btn.style.borderColor = '#3b82f6';
                }
            }
            
            checkCardValidation();
        }
        
        function updateCardColorSelection() {
            document.querySelectorAll('.card-color-btn').forEach(btn => {
                btn.style.transform = 'scale(1)';
            });
            
            if (window.selectedCardColor) {
                const btn = document.getElementById(`card-color-${window.selectedCardColor}`);
                if (btn) {
                    btn.style.transform = 'scale(1.05)';
                    btn.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                }
            }
            
            checkCardValidation();
        }
        
        function checkCardValidation() {
            const validateBtn = document.getElementById('btn-validate-card');
            if (validateBtn && window.selectedCardTeam && window.selectedCardColor) {
                validateBtn.disabled = false;
                validateBtn.style.opacity = '1';
            }
        }
        
        function validateCard() {
            if (!window.selectedCardTeam || !window.selectedCardColor) return;
            
            const team = window.selectedCardTeam;
            const color = window.selectedCardColor;
            const teamName = team === 'us' ? (matchSetup?.homeTeam?.name || 'Notre √©quipe') : (matchSetup?.awayTeam?.name || '√âquipe adverse');
            
            showNotification(`üü®üü• Carton ${color} pour ${teamName}`);
            
            if (color === 'rouge') {
                // Carton rouge = point + p√©nalit√© pour l'adversaire
                if (team === 'us') {
                    changeScore('team2', 1);
                } else {
                    changeScore('team1', 1);
                }
            }
            
            matchStats.rallies.push({
                type: 'card',
                team: team,
                color: color,
                timestamp: new Date().toISOString(),
                setNumber: LCVBScoreboard.getScoreData().currentSet
            });
            
            // Fermer la modal
            closeCardModal();
            
            // Mettre √† jour l'historique
            updateCurrentSetHistory();
        }
        
        function closeCardModal() {
            const modal = document.getElementById('card-modal');
            if (modal) modal.remove();
            window.selectedCardTeam = null;
            window.selectedCardColor = null;
        }
        
        function directTimeout() {
            // Cr√©er la modal pour s√©lectionner l'√©quipe
            const existingModal = document.getElementById('timeout-selection-modal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'timeout-selection-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const ourTeamName = matchSetup?.homeTeam?.name || 'Notre √©quipe';
            const theirTeamName = matchSetup?.awayTeam?.name || '√âquipe adverse';
            const ourTimeouts = timeoutsCount.team1 || 0;
            const theirTimeouts = timeoutsCount.team2 || 0;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 16px; max-width: 500px; width: 100%;">
                    <h2 style="margin: 0 0 1rem 0; color: #f59e0b; text-align: center;">‚è∏Ô∏è Timeout</h2>
                    <p style="text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">
                        Quelle √©quipe prend le timeout ?
                    </p>
                    
                    <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                        <button onclick="selectTimeoutTeam('team1')" class="timeout-team-btn" style="padding: 1.25rem; background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 1.1rem;">${ourTeamName}</span>
                            <span style="font-size: 0.85rem; color: #6b7280;">${ourTimeouts}/2 utilis√©s</span>
                        </button>
                        <button onclick="selectTimeoutTeam('team2')" class="timeout-team-btn" style="padding: 1.25rem; background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 1.1rem;">${theirTeamName}</span>
                            <span style="font-size: 0.85rem; color: #6b7280;">${theirTimeouts}/2 utilis√©s</span>
                        </button>
                    </div>
                    
                    <button onclick="closeTimeoutSelectionModal()" style="width: 100%; padding: 0.75rem; background: #64748b; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        ‚úñ Annuler
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Ajouter l'effet hover via CSS
            const style = document.createElement('style');
            style.textContent = `
                .timeout-team-btn:hover {
                    background: #e5e7eb !important;
                    border-color: #f59e0b !important;
                    transform: translateY(-2px);
                }
            `;
            document.head.appendChild(style);
        }
        
        function selectTimeoutTeam(team) {
            const teamName = team === 'team1' ? (matchSetup?.homeTeam?.name || 'Notre √©quipe') : (matchSetup?.awayTeam?.name || '√âquipe adverse');
            
            // V√©rifier le nombre de timeouts restants
            if (timeoutsCount[team] >= 2) {
                alert(`‚ùå ${teamName} a d√©j√† utilis√© ses 2 timeouts pour ce set !`);
                return;
            }
            
            timeoutsCount[team]++;
            
            // Fermer la modal de s√©lection
            closeTimeoutSelectionModal();
            
            // Cr√©er l'interface du timer
            showTimeoutTimer(team, teamName);
            
            matchStats.rallies.push({
                type: 'timeout',
                team: team,
                timestamp: new Date().toISOString(),
                setNumber: LCVBScoreboard.getScoreData().currentSet
            });
            
            // Mettre √† jour l'affichage
            updateCompactDisplay();
            updateCurrentSetHistory();
        }
        
        function closeTimeoutSelectionModal() {
            const modal = document.getElementById('timeout-selection-modal');
            if (modal) modal.remove();
        }
        
        function showTimeoutTimer(team, teamName) {
            // Cr√©er une modal pour le timer
            const existingModal = document.getElementById('timeout-modal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'timeout-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 3rem; border-radius: 16px; text-align: center; min-width: 400px;">
                    <h2 style="margin: 0 0 1rem 0; color: #EC4899;">‚è∏Ô∏è TIMEOUT</h2>
                    <h3 style="margin: 0 0 2rem 0; color: #1a1a1a;">${teamName}</h3>
                    <div style="font-size: 5rem; font-weight: 800; color: #EC4899; margin-bottom: 2rem;" id="timeout-seconds">30</div>
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
                        Timeouts restants : ${2 - timeoutsCount[team]}
                    </div>
                    <button onclick="closeTimeoutTimer()" style="padding: 0.75rem 2rem; background: #EC4899; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                        ‚úì Terminer le timeout
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // D√©marrer le compte √† rebours
            let secondsLeft = 30;
            timeoutTimerInterval = setInterval(() => {
                secondsLeft--;
                const display = document.getElementById('timeout-seconds');
                if (display) {
                    display.textContent = secondsLeft;
                    if (secondsLeft <= 5) {
                        display.style.color = '#ef4444';
                    }
                }
                
                if (secondsLeft <= 0) {
                    clearInterval(timeoutTimerInterval);
                    closeTimeoutTimer();
                }
            }, 1000);
        }
        
        function closeTimeoutTimer() {
            if (timeoutTimerInterval) {
                clearInterval(timeoutTimerInterval);
                timeoutTimerInterval = null;
            }
            
            const modal = document.getElementById('timeout-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // R√©initialiser les timeouts √† chaque nouveau set
        function resetTimeoutsForNewSet() {
            timeoutsCount = {
                team1: 0,
                team2: 0
            };
            console.log('‚è∏Ô∏è Compteurs de timeouts r√©initialis√©s pour le nouveau set');
        }
        
        function directSubstitution() {
            // Cr√©er une modal pour le changement
            const existingModal = document.getElementById('substitution-modal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'substitution-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                overflow-y: auto;
                padding: 2rem;
            `;
            
            // R√©cup√©rer les joueurs sur le terrain et sur le banc
            const onCourt = [];
            const onBench = [];
            
            if (matchSetup && matchSetup.homeTeam && matchSetup.homeTeam.presentPlayers) {
                matchSetup.homeTeam.presentPlayers.forEach(player => {
                    let isOnCourt = false;
                    for (let pos = 1; pos <= 6; pos++) {
                        if (courtComposition.positions[pos] && 
                            courtComposition.positions[pos].id === player.id) {
                            isOnCourt = true;
                            break;
                        }
                    }
                    if (isOnCourt) {
                        onCourt.push(player);
                    } else {
                        onBench.push(player);
                    }
                });
            }
            
            let courtHTML = '';
            for (let i = 0; i < onCourt.length; i++) {
                const p = onCourt[i];
                courtHTML += `
                    <button class="sub-player-btn" onclick="selectSubPlayer('court', ${p.id}, ${p.number})" data-sub-id="${p.id}">
                        <div style="font-size: 1.2rem; font-weight: 800;">#${p.number}</div>
                        <div style="font-size: 0.75rem;">${p.firstName} ${p.lastName}</div>
                        <div style="font-size: 0.65rem; color: #666;">${p.position}</div>
                    </button>
                `;
            }
            
            let benchHTML = '';
            for (let i = 0; i < onBench.length; i++) {
                const p = onBench[i];
                benchHTML += `
                    <button class="sub-player-btn" onclick="selectSubPlayer('bench', ${p.id}, ${p.number})" data-sub-id="${p.id}">
                        <div style="font-size: 1.2rem; font-weight: 800;">#${p.number}</div>
                        <div style="font-size: 0.75rem;">${p.firstName} ${p.lastName}</div>
                        <div style="font-size: 0.65rem; color: #666;">${p.position}</div>
                    </button>
                `;
            }
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 16px; max-width: 600px; width: 100%;">
                    <h2 style="margin: 0 0 1rem 0; color: #EC4899; text-align: center;">üîÑ Changement de joueurs</h2>
                    <p style="text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">
                        S√©lectionnez 2 joueurs √† √©changer (1 sur terrain + 1 sur banc)
                    </p>
                    
                    <div id="sub-selection-status" style="background: #fef3c7; padding: 0.75rem; border-radius: 8px; text-align: center; margin-bottom: 1rem; font-weight: 600; color: #92400e;">
                        S√©lectionnez le 1er joueur
                    </div>
                    
                    <h3 style="margin: 1rem 0 0.5rem 0; font-size: 1rem; color: #1a1a1a;">üèê Sur le terrain</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1.5rem;">
                        ${courtHTML || '<div style="padding: 1rem; text-align: center; color: #999; grid-column: 1/-1;">Aucun joueur</div>'}
                    </div>
                    
                    <h3 style="margin: 1rem 0 0.5rem 0; font-size: 1rem; color: #1a1a1a;">üí∫ Sur le banc</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1.5rem;">
                        ${benchHTML || '<div style="padding: 1rem; text-align: center; color: #999; grid-column: 1/-1;">Aucun joueur</div>'}
                    </div>
                    
                    <div style="display: flex; gap: 0.75rem;">
                        <button onclick="closeSubstitutionModal()" style="flex: 1; padding: 0.75rem; background: #64748b; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            ‚úñ Annuler
                        </button>
                        <button id="btn-validate-sub" onclick="validateSubstitution()" disabled style="flex: 1; padding: 0.75rem; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; opacity: 0.5;">
                            ‚úì Valider
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        let substitutionData = {
            player1: null,
            player2: null
        };
        
        function selectSubPlayer(zone, playerId, playerNumber) {
            if (!substitutionData.player1) {
                substitutionData.player1 = {zone, id: playerId, number: playerNumber};
                document.getElementById('sub-selection-status').innerHTML = 
                    `‚úÖ Joueur #${playerNumber} s√©lectionn√© ‚Üí S√©lectionnez le 2e joueur`;
                document.getElementById('sub-selection-status').style.background = '#dcfce7';
                document.getElementById('sub-selection-status').style.color = '#166534';
                
                // Marquer visuellement le joueur s√©lectionn√©
                document.querySelectorAll('.sub-player-btn').forEach(btn => {
                    if (btn.getAttribute('data-sub-id') == playerId) {
                        btn.style.background = '#10b981';
                        btn.style.color = 'white';
                    }
                });
            } else if (!substitutionData.player2) {
                if (substitutionData.player1.id === playerId) {
                    alert('‚ö†Ô∏è Vous avez d√©j√† s√©lectionn√© ce joueur !');
                    return;
                }
                if (substitutionData.player1.zone === zone) {
                    alert('‚ö†Ô∏è Vous devez s√©lectionner 1 joueur sur le terrain et 1 sur le banc !');
                    return;
                }
                
                substitutionData.player2 = {zone, id: playerId, number: playerNumber};
                document.getElementById('sub-selection-status').innerHTML = 
                    `‚úÖ √âchange : #${substitutionData.player1.number} ‚Üî #${substitutionData.player2.number}`;
                document.getElementById('sub-selection-status').style.background = '#dcfce7';
                
                // Marquer visuellement le 2e joueur
                document.querySelectorAll('.sub-player-btn').forEach(btn => {
                    if (btn.getAttribute('data-sub-id') == playerId) {
                        btn.style.background = '#10b981';
                        btn.style.color = 'white';
                    }
                });
                
                // Activer le bouton de validation
                document.getElementById('btn-validate-sub').disabled = false;
                document.getElementById('btn-validate-sub').style.opacity = '1';
            }
        }
        
        function validateSubstitution() {
            if (!substitutionData.player1 || !substitutionData.player2) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner 2 joueurs');
                return;
            }
            
            // Trouver la position du joueur sur le terrain
            let courtPosition = null;
            for (let pos = 1; pos <= 6; pos++) {
                const player = courtComposition.positions[pos];
                if (player && (player.id === substitutionData.player1.id || player.id === substitutionData.player2.id)) {
                    courtPosition = pos;
                    break;
                }
            }
            
            // Trouver les objets joueurs complets
            const player1Full = matchSetup.homeTeam.presentPlayers.find(p => p.id === substitutionData.player1.id);
            const player2Full = matchSetup.homeTeam.presentPlayers.find(p => p.id === substitutionData.player2.id);
            
            // Effectuer l'√©change
            if (courtPosition && player1Full && player2Full) {
                // Le joueur du terrain sort, celui du banc entre
                const playerEntering = substitutionData.player1.zone === 'bench' ? player1Full : player2Full;
                courtComposition.positions[courtPosition] = playerEntering;
                
                // Mettre √† jour l'affichage
                updateCourtDisplay();
                
                // Enregistrer dans l'historique
                const data = LCVBScoreboard.getScoreData();
                matchStats.rallies.push({
                    type: 'substitution',
                    out: substitutionData.player1.zone === 'court' ? substitutionData.player1.number : substitutionData.player2.number,
                    in: substitutionData.player1.zone === 'bench' ? substitutionData.player1.number : substitutionData.player2.number,
                    timestamp: new Date().toISOString(),
                    setNumber: data.currentSet
                });
                
                // Mettre √† jour l'historique
                updateCurrentSetHistory();
                
                showNotification(`üîÑ Changement : #${substitutionData.player1.number} ‚Üî #${substitutionData.player2.number}`);
            }
            
            closeSubstitutionModal();
        }
        
        function closeSubstitutionModal() {
            const modal = document.getElementById('substitution-modal');
            if (modal) {
                modal.remove();
            }
            substitutionData = {
                player1: null,
                player2: null
            };
        }
        
        // Annuler le dernier point
        function undoLastRally() {
            if (matchStats.rallies.length === 0) {
                alert('Aucun point √† annuler');
                return;
            }
            
            const lastRally = matchStats.rallies.pop();
            
            // Retirer le point
            if (lastRally.rallyResult && lastRally.rallyResult.winner === 'us') {
                changeScore('team1', -1);
            } else {
                changeScore('team2', -1);
            }
            
            showNotification('‚Ü©Ô∏è Dernier point annul√©');
        }
        
        // Basculer l'affichage de l'historique du set en cours
        function toggleSetHistory() {
            const historyList = document.getElementById('current-set-history-list');
            const toggleBtn = document.getElementById('toggle-set-history-btn');
            
            if (historyList.style.display === 'none') {
                historyList.style.display = 'block';
                toggleBtn.textContent = 'üëÅÔ∏è Masquer';
            } else {
                historyList.style.display = 'none';
                toggleBtn.textContent = 'üëÅÔ∏è Afficher';
            }
        }
        
        // Toggle statistiques du match
        function toggleMatchStats() {
            const teamStats = document.getElementById('team-stats-summary');
            const playerStats = document.getElementById('player-stats-section');
            const toggleBtn = document.getElementById('toggle-match-stats-btn');
            
            if (teamStats.style.display === 'none') {
                teamStats.style.display = 'block';
                playerStats.style.display = 'block';
                toggleBtn.textContent = 'üëÅÔ∏è Masquer';
            } else {
                teamStats.style.display = 'none';
                playerStats.style.display = 'none';
                toggleBtn.textContent = 'üëÅÔ∏è Afficher';
            }
        }
        
        // Calculer et afficher les statistiques du match
        function updateMatchStats() {
            const playerStats = {};
            const scoreboardData = LCVBScoreboard.getScoreData();
            const defaultSetNumber = scoreboardData?.currentSet ?? 1;
            const presentPlayers = matchSetup?.homeTeam?.presentPlayers || [];

            const extendedAttackTypes = [...ATTACK_TYPES.map(t => t.key), 'other'];
            const extendedAttackTempos = [...ATTACK_TEMPOS.map(t => t.key), 'other'];

            presentPlayers.forEach(p => {
                const attacksByType = {};
                extendedAttackTypes.forEach(key => {
                    attacksByType[key] = { total: 0, points: 0 };
                });
                const attacksByTempo = {};
                extendedAttackTempos.forEach(key => {
                    attacksByTempo[key] = { total: 0, points: 0 };
                });

                playerStats[p.id] = {
                    player: p,
                    services: { total: 0, aces: 0, faults: 0 },
                    receptions: { total: 0, perfect: 0, average: 0, failed: 0 },
                    attacks: { total: 0, points: 0, blocked: 0, out: 0, net: 0, byType: attacksByType, byTempo: attacksByTempo },
                    secondTouch: 0
                };
            });
            
            const createRotationStatsEntry = () => ({
                rallies: 0,
                pointsFor: 0,
                pointsAgainst: 0,
                servingRallies: 0,
                receivingRallies: 0,
                holds: 0,
                sideOuts: 0
            });

            const rotationStats = {};
            for (let i = 1; i <= 6; i++) {
                rotationStats[i] = createRotationStatsEntry();
            }

            const summary = {
                momentum: {
                    team1: { current: 0, max: 0, history: [] },
                    team2: { current: 0, max: 0, history: [] }
                },
                rotations: {
                    team1: { stats: rotationStats }
                }
            };

            let currentRunTeam1 = 0;
            let currentRunTeam2 = 0;
            let lastRunSetTeam1 = null;
            let lastRunSetTeam2 = null;

            const validAttackTypes = ATTACK_TYPES.map(t => t.key);
            const validAttackTempos = ATTACK_TEMPOS.map(t => t.key);

            matchStats.rallies.forEach(rally => {
                if (!rally || rally.type === 'substitution' || rally.type === 'card' || rally.type === 'timeout') {
                    return;
                }

                const winnerLabel = rally.rallyResult?.winner;
                const setNumber = rally.setNumber ?? defaultSetNumber;

                if (winnerLabel === 'us') {
                    if (currentRunTeam1 === 0) {
                        lastRunSetTeam1 = setNumber;
                    }
                    currentRunTeam1 += 1;
                    if (currentRunTeam1 > summary.momentum.team1.max) {
                        summary.momentum.team1.max = currentRunTeam1;
                    }
                    if (currentRunTeam2 > 0) {
                        summary.momentum.team2.history.push({ length: currentRunTeam2, set: lastRunSetTeam2 });
                        currentRunTeam2 = 0;
                        lastRunSetTeam2 = null;
                    }
                } else if (winnerLabel === 'them') {
                    if (currentRunTeam2 === 0) {
                        lastRunSetTeam2 = setNumber;
                    }
                    currentRunTeam2 += 1;
                    if (currentRunTeam2 > summary.momentum.team2.max) {
                        summary.momentum.team2.max = currentRunTeam2;
                    }
                    if (currentRunTeam1 > 0) {
                        summary.momentum.team1.history.push({ length: currentRunTeam1, set: lastRunSetTeam1 });
                        currentRunTeam1 = 0;
                        lastRunSetTeam1 = null;
                    }
                }

                const rotationBefore = rally.metadata?.rotationBefore ?? 1;
                const serviceBefore = rally.metadata?.serviceBefore ?? null;
                const rotationEntry = rotationStats[rotationBefore] || (rotationStats[rotationBefore] = createRotationStatsEntry());
                rotationEntry.rallies += 1;

                if (winnerLabel === 'us') {
                    rotationEntry.pointsFor += 1;
                } else if (winnerLabel === 'them') {
                    rotationEntry.pointsAgainst += 1;
                }

                if (serviceBefore === 'team1') {
                    rotationEntry.servingRallies += 1;
                    if (winnerLabel === 'us') {
                        rotationEntry.holds += 1;
                    }
                } else if (serviceBefore === 'team2') {
                    rotationEntry.receivingRallies += 1;
                    if (winnerLabel === 'us') {
                        rotationEntry.sideOuts += 1;
                    }
                }
                
                rally.actions?.forEach(action => {
                    const playerId = action.player?.player?.id;
                    if (!playerId || !playerStats[playerId]) return;
                    
                    const stats = playerStats[playerId];
                    
                    if (action.type === 'service') {
                        stats.services.total++;
                        if (action.result === 'ace' || action.quality === 'ace') stats.services.aces++;
                        if (action.result === 'fault' || action.quality === 'fault') stats.services.faults++;
                    }
                    
                    if (action.type === 'reception') {
                        stats.receptions.total++;
                        if (action.quality === 'perfect') stats.receptions.perfect++;
                        else if (action.quality === 'average') stats.receptions.average++;
                        else if (action.quality === 'failed') stats.receptions.failed++;
                    }
                    
                    if (action.type === 'our_attack') {
                        stats.attacks.total++;

                        if (action.result === 'second_touch') {
                            stats.secondTouch++;
                            return;
                        }

                        const attackTypeKey = validAttackTypes.includes(action.attackType) ? action.attackType : (action.attackType ? 'other' : 'power');
                        const tempoKey = validAttackTempos.includes(action.attackTempo) ? action.attackTempo : (action.attackTempo ? 'other' : 'tempo3');

                        if (!stats.attacks.byType[attackTypeKey]) {
                            stats.attacks.byType[attackTypeKey] = { total: 0, points: 0 };
                        }
                        if (!stats.attacks.byTempo[tempoKey]) {
                            stats.attacks.byTempo[tempoKey] = { total: 0, points: 0 };
                        }

                        stats.attacks.byType[attackTypeKey].total++;
                        stats.attacks.byTempo[tempoKey].total++;

                        if (action.result === 'point' || action.result === 'block_out') {
                            stats.attacks.points++;
                            stats.attacks.byType[attackTypeKey].points++;
                            stats.attacks.byTempo[tempoKey].points++;
                        } else if (action.result === 'blocked_in') {
                            stats.attacks.blocked++;
                        } else if (action.result === 'out') {
                            stats.attacks.out++;
                        } else if (action.result === 'net') {
                            stats.attacks.net++;
                        }
                    }
                });
            });
            
            if (currentRunTeam1 > 0) {
                summary.momentum.team1.history.push({ length: currentRunTeam1, set: lastRunSetTeam1 });
            }
            if (currentRunTeam2 > 0) {
                summary.momentum.team2.history.push({ length: currentRunTeam2, set: lastRunSetTeam2 });
            }
            summary.momentum.team1.current = currentRunTeam1;
            summary.momentum.team2.current = currentRunTeam2;

            matchStats.playerStats = playerStats;
            matchStats.summary = summary;

            updateTeamStats(playerStats);
            updatePlayerStatsCards(playerStats);
        }
        
        // Afficher les statistiques d'√©quipe globales
        function updateTeamStats(playerStats) {
            const teamTotals = {
                services: 0, aces: 0, serviceFaults: 0,
                receptions: 0, perfectReceptions: 0,
                attacks: 0, attackPoints: 0,
                secondTouch: 0
            };
            
            Object.values(playerStats).forEach(stats => {
                teamTotals.services += stats.services.total;
                teamTotals.aces += stats.services.aces;
                teamTotals.serviceFaults += stats.services.faults;
                teamTotals.receptions += stats.receptions.total;
                teamTotals.perfectReceptions += stats.receptions.perfect;
                teamTotals.attacks += stats.attacks.total;
                teamTotals.attackPoints += stats.attacks.points;
                teamTotals.secondTouch += stats.secondTouch;
            });
            
            const serviceRate = teamTotals.services > 0 ? ((teamTotals.services - teamTotals.serviceFaults) / teamTotals.services * 100).toFixed(1) : '0.0';
            const attackRate = teamTotals.attacks > 0 ? (teamTotals.attackPoints / teamTotals.attacks * 100).toFixed(1) : '0.0';
            const receptionRate = teamTotals.receptions > 0 ? (teamTotals.perfectReceptions / teamTotals.receptions * 100).toFixed(1) : '0.0';
            
            const cards = [];

            cards.push(`
                <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 2px solid #e5e7eb;">
                    <div style="font-weight: 700; color: #1f2937; margin-bottom: 0.25rem;">‚ö° Services</div>
                    <div style="color: #6b7280;">${teamTotals.services} (${teamTotals.aces} ACE)</div>
                    <div style="color: #10b981; font-weight: 600; margin-top: 0.25rem;">${serviceRate}% r√©ussite</div>
                </div>
            `);

            cards.push(`
                <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 2px solid #e5e7eb;">
                    <div style="font-weight: 700; color: #1f2937; margin-bottom: 0.25rem;">üì• R√©ceptions</div>
                    <div style="color: #6b7280;">${teamTotals.receptions} (${teamTotals.perfectReceptions} parfaites)</div>
                    <div style="color: #10b981; font-weight: 600; margin-top: 0.25rem;">${receptionRate}% parfaites</div>
                </div>
            `);

            cards.push(`
                <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 2px solid #e5e7eb;">
                    <div style="font-weight: 700; color: #1f2937; margin-bottom: 0.25rem;">üî• Attaques</div>
                    <div style="color: #6b7280;">${teamTotals.attacks} (${teamTotals.attackPoints} pts)</div>
                    <div style="color: #10b981; font-weight: 600; margin-top: 0.25rem;">${attackRate}% r√©ussite</div>
                </div>
            `);

            cards.push(`
                <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 2px solid #e5e7eb;">
                    <div style="font-weight: 700; color: #1f2937; margin-bottom: 0.25rem;">‚ú® Secondes mains</div>
                    <div style="color: #6b7280; font-size: 1.5rem; font-weight: 700;">${teamTotals.secondTouch}</div>
                </div>
            `);

            const momentumSummary = matchStats.summary?.momentum;
            if (momentumSummary) {
                const longest = momentumSummary.team1?.max ?? 0;
                const current = momentumSummary.team1?.current ?? 0;
                const opponentLongest = momentumSummary.team2?.max ?? 0;
                cards.push(`
                    <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 2px solid #e5e7eb;">
                        <div style="font-weight: 700; color: #1f2937; margin-bottom: 0.25rem;">üìà S√©ries</div>
                        <div style="color: #6b7280;">Plus longue s√©rie : <strong>${longest}</strong></div>
                        <div style="color: #6b7280;">S√©rie en cours : <strong>${current}</strong></div>
                        <div style="color: #9ca3af; margin-top: 0.25rem;">Adverse max : ${opponentLongest}</div>
                    </div>
                `);
            }

            const rotationSummary = matchStats.summary?.rotations?.team1?.stats;
            if (rotationSummary) {
                let bestRotation = null;
                Object.entries(rotationSummary).forEach(([rotation, stats]) => {
                    if (!stats || stats.rallies === 0) return;
                    const net = (stats.pointsFor ?? 0) - (stats.pointsAgainst ?? 0);
                    if (!bestRotation || net > bestRotation.net) {
                        bestRotation = { rotation, net, stats };
                    }
                });

                if (bestRotation) {
                    const { stats } = bestRotation;
                    const sideOutRate = stats.receivingRallies > 0 ? Math.round((stats.sideOuts / stats.receivingRallies) * 100) : 0;
                    const holdRate = stats.servingRallies > 0 ? Math.round((stats.holds / stats.servingRallies) * 100) : 0;
                    const netDisplay = bestRotation.net >= 0 ? `+${bestRotation.net}` : `${bestRotation.net}`;
                    cards.push(`
                        <div style="background: white; padding: 0.75rem; border-radius: 6px; border: 2px solid #e5e7eb;">
                            <div style="font-weight: 700; color: #1f2937; margin-bottom: 0.25rem;">üîÅ Rotation la plus efficace</div>
                            <div style="color: #6b7280;">Rotation R${bestRotation.rotation} : <strong>${netDisplay}</strong></div>
                            <div style="color: #10b981;">Hold service : ${holdRate}%</div>
                            <div style="color: #2563eb;">Side-out : ${sideOutRate}%</div>
                        </div>
                    `);
                }
            }

            document.getElementById('team-stats-content').innerHTML = cards.join('');
        }
        
        // Afficher les cards par joueur
        function updatePlayerStatsCards(playerStats) {
            const container = document.getElementById('player-stats-cards');
            const cards = [];
            
            // Trier par nombre de joueur
            const sortedPlayers = Object.values(playerStats).sort((a, b) => a.player.number - b.player.number);
            
            sortedPlayers.forEach(stats => {
                const p = stats.player;
                
                // D√©terminer la couleur selon le poste
                let positionColor = '#6b7280';
                let positionIcon = 'üë§';
                if (p.position === 'Passeur' || p.position === 'Passeuse') {
                    positionColor = '#3b82f6';
                    positionIcon = 'üéØ';
                } else if (p.position === 'Pointu') {
                    positionColor = '#ef4444';
                    positionIcon = '‚ö°';
                } else if (p.position === 'Central' || p.position === 'Centrale') {
                    positionColor = '#f59e0b';
                    positionIcon = 'üß±';
                } else if (p.position === 'R√©ceptionneur' || p.position === 'R√©ceptionneuse') {
                    positionColor = '#10b981';
                    positionIcon = 'üì•';
                } else if (p.position === 'Lib√©ro' || p.libero) {
                    positionColor = '#8b5cf6';
                    positionIcon = 'üõ°Ô∏è';
                }
                
                // Calculer les pourcentages
                const serviceRate = stats.services.total > 0 ? ((stats.services.total - stats.services.faults) / stats.services.total * 100).toFixed(0) : '-';
                const attackRate = stats.attacks.total > 0 ? (stats.attacks.points / stats.attacks.total * 100).toFixed(0) : '-';
                const receptionRate = stats.receptions.total > 0 ? (stats.receptions.perfect / stats.receptions.total * 100).toFixed(0) : '-';

                const typeDetails = [];
                if (stats.attacks?.byType) {
                    ATTACK_TYPES.forEach(item => {
                        const info = stats.attacks.byType[item.key];
                        if (info && info.total > 0) {
                            const pct = info.total > 0 ? Math.round((info.points / info.total) * 100) : 0;
                            typeDetails.push(`${item.icon} ${info.points}/${info.total} (${pct}%)`);
                        }
                    });
                    const otherInfo = stats.attacks.byType.other;
                    if (otherInfo && otherInfo.total > 0) {
                        const pct = otherInfo.total > 0 ? Math.round((otherInfo.points / otherInfo.total) * 100) : 0;
                        typeDetails.push(`üåÄ ${otherInfo.points}/${otherInfo.total} (${pct}%)`);
                    }
                }

                const tempoDetails = [];
                if (stats.attacks?.byTempo) {
                    ATTACK_TEMPOS.forEach(item => {
                        const info = stats.attacks.byTempo[item.key];
                        if (info && info.total > 0) {
                            const pct = info.total > 0 ? Math.round((info.points / info.total) * 100) : 0;
                            tempoDetails.push(`${item.icon} ${info.points}/${info.total} (${pct}%)`);
                        }
                    });
                    const otherTempo = stats.attacks.byTempo.other;
                    if (otherTempo && otherTempo.total > 0) {
                        const pct = otherTempo.total > 0 ? Math.round((otherTempo.points / otherTempo.total) * 100) : 0;
                        tempoDetails.push(`‚è±Ô∏è ${otherTempo.points}/${otherTempo.total} (${pct}%)`);
                    }
                }
                
                // Cr√©er la card
                const card = `
                    <div style="background: white; border: 2px solid ${positionColor}; border-radius: 12px; padding: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.08);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 2px solid #e5e7eb;">
                            <div>
                                <div style="font-size: 1.3rem; font-weight: 800; color: ${positionColor};">#${p.number} ${p.firstName}</div>
                                <div style="font-size: 0.85rem; color: #6b7280; font-weight: 600;">${positionIcon} ${p.position}</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; gap: 0.5rem; font-size: 0.8rem;">
                            ${stats.services.total > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 0.4rem; background: #f9fafb; border-radius: 6px;">
                                <span style="color: #6b7280;">‚ö° Services</span>
                                <span style="font-weight: 700; color: #1f2937;">${stats.services.total} <span style="color: #10b981; font-size: 0.7rem;">(${serviceRate}%)</span></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-left: 1.5rem;">
                                <span style="color: #9ca3af;">‚îî ACE</span>
                                <span style="font-weight: 700; color: #10b981;">${stats.services.aces}</span>
                            </div>
                            ` : ''}
                            
                            ${stats.receptions.total > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 0.4rem; background: #f9fafb; border-radius: 6px;">
                                <span style="color: #6b7280;">üì• R√©ceptions</span>
                                <span style="font-weight: 700; color: #1f2937;">${stats.receptions.total} <span style="color: #10b981; font-size: 0.7rem;">(${receptionRate}% ‚ú®)</span></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-left: 1.5rem;">
                                <span style="color: #9ca3af;">‚îî Parfaites</span>
                                <span style="font-weight: 700; color: #10b981;">${stats.receptions.perfect}</span>
                            </div>
                            ` : ''}
                            
                            ${stats.attacks.total > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 0.4rem; background: #f9fafb; border-radius: 6px;">
                                <span style="color: #6b7280;">üî• Attaques</span>
                                <span style="font-weight: 700; color: #1f2937;">${stats.attacks.total} <span style="color: #10b981; font-size: 0.7rem;">(${attackRate}%)</span></span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-left: 1.5rem;">
                                <span style="color: #9ca3af;">‚îî Points</span>
                                <span style="font-weight: 700; color: #10b981;">${stats.attacks.points}</span>
                            </div>
                            ${typeDetails.length ? `
                            <div style="padding-left: 1.5rem; color: #6b7280; font-size: 0.75rem; display: flex; flex-direction: column; gap: 0.25rem;">
                                ${typeDetails.map(t => `<span>${t}</span>`).join('')}
                            </div>
                            ` : ''}
                            ${tempoDetails.length ? `
                            <div style="padding-left: 1.5rem; color: #6b7280; font-size: 0.75rem; display: flex; flex-direction: column; gap: 0.25rem;">
                                ${tempoDetails.map(t => `<span>${t}</span>`).join('')}
                            </div>
                            ` : ''}
                            ` : ''}
                            
                            ${stats.secondTouch > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 0.4rem; background: #fef3c7; border-radius: 6px;">
                                <span style="color: #92400e;">‚ú® Secondes mains</span>
                                <span style="font-weight: 700; color: #92400e;">${stats.secondTouch}</span>
                            </div>
                            ` : ''}
                            
                            ${stats.services.total === 0 && stats.receptions.total === 0 && stats.attacks.total === 0 ? `
                            <div style="text-align: center; color: #9ca3af; padding: 1rem;">
                                Aucune action enregistr√©e
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                cards.push(card);
            });
            
            container.innerHTML = cards.join('');
        }
        
        // Supprimer une entr√©e de l'historique
        function deleteHistoryEntry(index) {
            const data = LCVBScoreboard.getScoreData();
            const currentSet = data.currentSet;
            
            // Filtrer les rallies du set en cours uniquement
            const currentSetRallies = matchStats.rallies.filter(r => r.setNumber === currentSet);
            
            if (index < 0 || index >= currentSetRallies.length) {
                alert('Erreur : entr√©e introuvable');
                return;
            }
            
            const rally = currentSetRallies[index];
            
            // Confirmation
            const confirmMsg = rally.type === 'substitution' ? 
                `Supprimer ce changement de joueur (#${rally.out} ‚Üî #${rally.in}) ?` :
                rally.type === 'card' ?
                `Supprimer ce carton ${rally.color} ?` :
                rally.type === 'timeout' ?
                `Supprimer ce timeout ?` :
                rally.type === 'direct_point' ?
                `Supprimer ce point direct (${rally.reason}) ?\n\n‚ö†Ô∏è Le score sera ajust√© automatiquement.` :
                `Supprimer ce point ?\n\n‚ö†Ô∏è Le score sera ajust√© automatiquement.`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // Trouver l'index r√©el dans matchStats.rallies
            const realIndex = matchStats.rallies.findIndex(r => r === rally);
            
            if (realIndex === -1) {
                alert('Erreur : impossible de trouver l\'entr√©e dans les statistiques');
                return;
            }
            
            // Retirer l'action de l'historique
            matchStats.rallies.splice(realIndex, 1);
            
            // Ajuster le score si n√©cessaire
            if (rally.type === 'direct_point') {
                // Point direct
                if (rally.winner === 'us') {
                    changeScore('team1', -1);
                } else {
                    changeScore('team2', -1);
                }
                showNotification('üóëÔ∏è Point direct supprim√© - Score ajust√©');
            } else if (rally.rallyResult) {
                // Point normal (workflow)
                if (rally.rallyResult.winner === 'us') {
                    changeScore('team1', -1);
                } else {
                    changeScore('team2', -1);
                }
                showNotification('üóëÔ∏è Point supprim√© - Score ajust√©');
            } else if (rally.type === 'card' && rally.color === 'rouge') {
                // Carton rouge : retirer le point accord√©
                if (rally.team === 'us') {
                    changeScore('team2', -1); // On avait donn√© un point √† l'adversaire
                } else {
                    changeScore('team1', -1);
                }
                showNotification('üóëÔ∏è Carton rouge supprim√© - Score ajust√©');
            } else if (rally.type === 'timeout') {
                // Timeout : rendre un timeout √† l'√©quipe
                if (timeoutsCount[rally.team] > 0) {
                    timeoutsCount[rally.team]--;
                }
                showNotification('üóëÔ∏è Timeout supprim√© - Compteur ajust√©');
                updateCompactDisplay();
            } else {
                showNotification('üóëÔ∏è Entr√©e supprim√©e');
            }
            
            // Mettre √† jour l'affichage
            updateCurrentSetHistory();
        }
        
        // Mettre √† jour l'historique du set en cours
        function updateCurrentSetHistory() {
            const data = LCVBScoreboard.getScoreData();
            const currentSet = data.currentSet;
            
            // Filtrer les rallies du set en cours uniquement
            const currentSetRallies = matchStats.rallies.filter(r => r.setNumber === currentSet);
            
            const historyList = document.getElementById('current-set-history-list');
            if (!historyList) return;
            
            if (currentSetRallies.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; color: #9ca3af; padding: 1rem;">
                        Aucun point enregistr√© pour ce set.
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
            
            let pointCounter = 0; // Compteur de points (sans compter les substitutions)
            
            currentSetRallies.forEach((rally, index) => {
                const timestamp = rally.timestamp ? new Date(rally.timestamp).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit', second: '2-digit'}) : '';
                
                // CAS 1: SUBSTITUTION (couleur orange - action hors workflow)
                if (rally.type === 'substitution') {
                    // Trouver les joueurs pour afficher nom + poste
                    const outPlayer = matchSetup?.homeTeam?.presentPlayers?.find(p => p.number === rally.out);
                    const inPlayer = matchSetup?.homeTeam?.presentPlayers?.find(p => p.number === rally.in);
                    
                    const outInfo = outPlayer ? `#${outPlayer.number} ${outPlayer.firstName} ${outPlayer.lastName} (${outPlayer.position})` : `#${rally.out}`;
                    const inInfo = inPlayer ? `#${inPlayer.number} ${inPlayer.firstName} ${inPlayer.lastName} (${inPlayer.position})` : `#${rally.in}`;
                    
                    html += `
                        <div style="padding: 1rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 0.5rem; position: relative;">
                            <div style="margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <strong style="color: #92400e; font-size: 1rem;">üîÑ Changement</strong>
                                    ${timestamp ? `<span style="color: #6b7280; margin-left: 0.5rem; font-size: 0.8rem;">${timestamp}</span>` : ''}
                                </div>
                                <button onclick="deleteHistoryEntry(${index})" style="padding: 0.25rem 0.5rem; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; font-weight: 600;">
                                    üóëÔ∏è Supprimer
                                </button>
                            </div>
                            <div style="font-size: 0.9rem; color: #1f2937; line-height: 1.6;">
                                <div><strong>${outInfo}</strong> sort</div>
                                <div style="margin-top: 0.25rem;"><strong>${inInfo}</strong> entre</div>
                            </div>
                        </div>
                    `;
                    return; // Passer √† l'it√©ration suivante
                }
                
                // CAS 1.5: POINT DIRECT (faute) - couleur orange (hors workflow)
                if (rally.type === 'direct_point') {
                    pointCounter++;
                    const pointNum = pointCounter;
                    const weWon = rally.winner === 'us';
                    const reasonText = rally.reason || 'Faute directe';
                    
                    // Couleur orange pour action hors workflow
                    const color = '#f59e0b';
                    const bgColor = '#fef3c7';
                    const icon = weWon ? '‚úÖ' : '‚ùå';
                    
                    html += `
                        <div style="padding: 1rem; background: ${bgColor}; border-left: 4px solid ${color}; border-radius: 8px; margin-bottom: 0.5rem;">
                            <div style="margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <strong style="color: #92400e; font-size: 1rem;">${icon} Point ${pointNum}</strong>
                                    ${timestamp ? `<span style="color: #6b7280; margin-left: 0.5rem; font-size: 0.8rem;">${timestamp}</span>` : ''}
                                </div>
                                <button onclick="deleteHistoryEntry(${index})" style="padding: 0.25rem 0.5rem; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; font-weight: 600;">
                                    üóëÔ∏è Supprimer
                                </button>
                            </div>
                            <div style="font-size: 0.9rem; color: #1f2937; line-height: 1.6;">
                                ${rally.actions && rally.actions.length > 0 ? '<div style="margin-bottom: 0.5rem; color: #666;">' + rally.actions.map(a => {
                                    if (a.type === 'service') {
                                        const p = a.player?.player || a.player;
                                        return `Service #${p?.number} ‚Üí ${a.result === 'ace' ? 'ACE' : a.result}`;
                                    } else if (a.type === 'reception') {
                                        const p = a.player?.player || a.player;
                                        return `R√©ception #${p?.number} ‚Üí ${a.quality}`;
                                    } else if (a.type === 'our_attack') {
                                        const p = a.player?.player || a.player;
                                        return `Attaque #${p?.number}`;
                                    }
                                    return '';
                                }).filter(x => x).join(' ‚Üí ') + '</div>' : ''}
                                <strong>${reasonText}</strong> ‚Üí Point pour <strong>${weWon ? 'Nous' : 'Eux'}</strong>
                            </div>
                        </div>
                    `;
                    return; // Passer √† l'it√©ration suivante
                }
                
                // CAS 1.6: CARTON (couleur orange - action hors workflow)
                if (rally.type === 'card') {
                    const teamName = rally.team === 'us' ? (matchSetup?.homeTeam?.name || 'Nous') : (matchSetup?.awayTeam?.name || 'Eux');
                    const cardIcon = rally.color === 'jaune' ? 'üü®' : 'üü•';
                    const cardText = rally.color === 'jaune' ? 'Carton Jaune' : 'Carton Rouge';
                    
                    html += `
                        <div style="padding: 1rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 0.5rem;">
                            <div style="margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <strong style="color: #92400e; font-size: 1rem;">${cardIcon} ${cardText}</strong>
                                    ${timestamp ? `<span style="color: #6b7280; margin-left: 0.5rem; font-size: 0.8rem;">${timestamp}</span>` : ''}
                                </div>
                                <button onclick="deleteHistoryEntry(${index})" style="padding: 0.25rem 0.5rem; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; font-weight: 600;">
                                    üóëÔ∏è Supprimer
                                </button>
                            </div>
                            <div style="font-size: 0.9rem; color: #1f2937;">
                                Pour <strong>${teamName}</strong>${rally.color === 'rouge' ? ' (Point accord√© √† l\'adversaire)' : ''}
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // CAS 1.7: TIMEOUT (couleur orange - action hors workflow)
                if (rally.type === 'timeout') {
                    const teamName = rally.team === 'team1' ? (matchSetup?.homeTeam?.name || 'Nous') : (matchSetup?.awayTeam?.name || 'Eux');
                    
                    html += `
                        <div style="padding: 1rem; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; margin-bottom: 0.5rem;">
                            <div style="margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                    <strong style="color: #92400e; font-size: 1rem;">‚è∏Ô∏è Timeout</strong>
                                    ${timestamp ? `<span style="color: #6b7280; margin-left: 0.5rem; font-size: 0.8rem;">${timestamp}</span>` : ''}
                                </div>
                                <button onclick="deleteHistoryEntry(${index})" style="padding: 0.25rem 0.5rem; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; font-weight: 600;">
                                    üóëÔ∏è Supprimer
                                </button>
                            </div>
                            <div style="font-size: 0.9rem; color: #1f2937;">
                                Pris par <strong>${teamName}</strong>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // CAS 2: POINT (rally normal)
                pointCounter++;
                const pointNum = pointCounter;
                const weWon = rally.rallyResult?.winner === 'us';
                const reason = rally.rallyResult?.reason || 'inconnu';
                
                // G√©n√©rer un r√©sum√© COMPLET de toutes les actions
                let actionSummary = '';
                if (rally.actions && rally.actions.length > 0) {
                    const actionParts = [];
                    
                    rally.actions.forEach(action => {
                        if (action.type === 'service' || action.type === 'our_service') {
                            const player = action.player?.player || action.player;
                            const resultText = action.result === 'ace' ? 'ACE ‚≠ê' : (action.result === 'fault' ? 'Faute ‚ùå' : 'En jeu');
                            actionParts.push(`Service #${player?.number || '?'} ${player?.firstName || ''} ‚Üí ${resultText}`);
                        } else if (action.type === 'reception') {
                            const player = action.player?.player || action.player;
                            const qualityText = action.quality === 'perfect' ? 'Parfaite ‚≠ê' : (action.quality === 'average' ? 'Moyenne üü°' : 'Rat√©e ‚ùå');
                            actionParts.push(`R√©ception #${player?.number || '?'} ${player?.firstName || ''} ‚Üí ${qualityText}`);
                        } else if (action.type === 'our_attack') {
                            const player = action.player?.player || action.player;
                            let resultText = '';
                            if (action.result === 'point') resultText = 'Point direct ‚úÖ';
                            else if (action.result === 'block_out') resultText = 'Bloc gagnant (block out) ‚úÖ';
                            else if (action.result === 'blocked_in') resultText = 'Bloc perdant (bloc in) ‚ùå';
                            else if (action.result === 'out') resultText = 'Out ‚ùå';
                            else if (action.result === 'net') resultText = 'Filet ‚ùå';
                            else if (action.result === 'defended') resultText = 'D√©fendu';
                            else resultText = action.result || '';
                            actionParts.push(`Attaque #${player?.number || '?'} ${player?.firstName || ''} ‚Üí ${resultText}`);
                        } else if (action.type === 'their_attack') {
                            const resultText = action.result === 'point' ? 'Point (eux) ‚ùå' : (action.result === 'blocked' ? 'Bloqu√©e ‚úÖ' : (action.result === 'out' ? 'Out ‚úÖ' : 'D√©fendue'));
                            actionParts.push(`Leur attaque ‚Üí ${resultText}`);
                        }
                    });
                    
                    actionSummary = actionParts.join(' ‚Üí ');
                }
                
                // Ajouter la conclusion
                const conclusionText = weWon ? `Point pour nous` : `Point pour eux`;
                if (actionSummary) {
                    actionSummary += ` ‚Üí <strong>${conclusionText}</strong>`;
                } else {
                    actionSummary = conclusionText;
                }
                
                const color = weWon ? '#10b981' : '#ef4444';
                const bgColor = weWon ? '#d1fae5' : '#fee2e2';
                const icon = weWon ? '‚úÖ' : '‚ùå';
                
                html += `
                    <div style="padding: 1rem; background: ${bgColor}; border-left: 4px solid ${color}; border-radius: 8px; margin-bottom: 0.5rem;">
                        <div style="margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                <strong style="color: ${color}; font-size: 1rem;">${icon} Point ${pointNum}</strong>
                                ${timestamp ? `<span style="color: #6b7280; margin-left: 0.5rem; font-size: 0.8rem;">${timestamp}</span>` : ''}
                            </div>
                            <button onclick="deleteHistoryEntry(${index})" style="padding: 0.25rem 0.5rem; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 0.75rem; cursor: pointer; font-weight: 600;">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                        <div style="font-size: 0.9rem; color: #1f2937; line-height: 1.6;">
                            ${actionSummary}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            historyList.innerHTML = html;
        }
        
        // Basculer l'affichage des statistiques des sets pr√©c√©dents
        function togglePreviousSetsStats() {
            const statsList = document.getElementById('previous-sets-stats-list');
            const toggleBtn = document.getElementById('toggle-previous-sets-btn');
            
            if (statsList.style.display === 'none') {
                statsList.style.display = 'block';
                toggleBtn.textContent = 'üëÅÔ∏è Masquer';
            } else {
                statsList.style.display = 'none';
                toggleBtn.textContent = 'üëÅÔ∏è Afficher';
            }
        }
        
        // Mettre √† jour les statistiques des sets pr√©c√©dents
        function updatePreviousSetsStats() {
            const data = LCVBScoreboard.getScoreData();
            const currentSet = data.currentSet;
            
            const setsSection = document.getElementById('previous-sets-stats-section');
            const statsList = document.getElementById('previous-sets-stats-list');
            
            if (!setsSection || !statsList) return;
            
            // Si on est toujours au set 1, masquer la section
            if (currentSet === 1) {
                setsSection.style.display = 'none';
                return;
            }
            
            // Afficher la section
            setsSection.style.display = 'block';
            
            // G√©n√©rer les statistiques pour chaque set pr√©c√©dent
            let html = '';
            
            for (let setNum = 1; setNum < currentSet; setNum++) {
                const setRallies = matchStats.rallies.filter(r => r.setNumber === setNum);
                const pointsWon = setRallies.filter(r => r.rallyResult?.winner === 'us').length;
                const pointsLost = setRallies.filter(r => r.rallyResult?.winner === 'them').length;
                
                // Calculer les stats
                const totalPoints = pointsWon + pointsLost;
                const services = setRallies.filter(r => r.actions?.some(a => a.type === 'service' || a.type === 'our_service')).length;
                const aces = setRallies.filter(r => r.actions?.some(a => (a.type === 'service' || a.type === 'our_service') && a.result === 'ace')).length;
                const attacks = setRallies.filter(r => r.actions?.some(a => a.type === 'our_attack')).length;
                const attacksWon = setRallies.filter(r => r.actions?.some(a => a.type === 'our_attack' && (a.result === 'point' || a.result === 'block_out'))).length;
                
                const winColor = pointsWon > pointsLost ? '#10b981' : '#ef4444';
                const winBg = pointsWon > pointsLost ? '#d1fae5' : '#fee2e2';
                const winText = pointsWon > pointsLost ? 'Gagn√©' : 'Perdu';
                
                html += `
                    <div style="padding: 1.5rem; background: ${winBg}; border-left: 4px solid ${winColor}; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0; color: ${winColor}; font-size: 1.1rem; font-weight: 700;">
                                Set ${setNum} - ${winText}
                            </h4>
                            <div style="font-size: 1.3rem; font-weight: 700; color: ${winColor};">
                                ${pointsWon} - ${pointsLost}
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; font-size: 0.85rem; color: #1f2937;">
                            <div style="background: white; padding: 0.5rem; border-radius: 4px;">
                                <strong>Total points :</strong> ${totalPoints}
                            </div>
                            <div style="background: white; padding: 0.5rem; border-radius: 4px;">
                                <strong>Services :</strong> ${services}
                            </div>
                            <div style="background: white; padding: 0.5rem; border-radius: 4px;">
                                <strong>Aces :</strong> ${aces}
                            </div>
                            <div style="background: white; padding: 0.5rem; border-radius: 4px;">
                                <strong>Attaques :</strong> ${attacksWon}/${attacks}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            if (html === '') {
                html = `<div style="text-align: center; color: #9ca3af; padding: 2rem;">Aucun set pr√©c√©dent.</div>`;
            }
            
            statsList.innerHTML = html;
        }
        
        // Afficher l'historique des points (TOUS les sets)
        function showRallyHistory() {
            if (matchStats.rallies.length === 0) {
                alert('Aucun point enregistr√© pour le moment');
                return;
            }
            
            // Cr√©er une modal pour l'historique
            const existingModal = document.getElementById('history-modal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'history-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                overflow-y: auto;
                padding: 2rem;
            `;
            
            let historyHTML = '';
            const reversedRallies = matchStats.rallies.slice().reverse();
            
            reversedRallies.forEach((rally, idx) => {
                const num = matchStats.rallies.length - idx;
                let rallyDesc = '';
                let pointColor = '#64748b';
                
                if (rally.type === 'direct_point') {
                    pointColor = rally.winner === 'us' ? '#10b981' : '#ef4444';
                    rallyDesc = `<strong>Point direct pour ${rally.winner === 'us' ? 'NOUS' : 'EUX'}</strong>`;
                } else if (rally.type === 'timeout') {
                    pointColor = '#f59e0b';
                    const teamName = rally.team === 'team1' ? (matchSetup?.homeTeam?.name || '√âquipe 1') : (matchSetup?.awayTeam?.name || '√âquipe 2');
                    rallyDesc = `‚è∏Ô∏è <strong>Timeout</strong> demand√© par ${teamName}`;
                } else if (rally.type === 'substitution') {
                    pointColor = '#8b5cf6';
                    rallyDesc = `üîÑ <strong>Changement</strong> : #${rally.out} sort ‚Üí #${rally.in} entre`;
                } else if (rally.type === 'card') {
                    pointColor = rally.color === 'rouge' ? '#ef4444' : '#f59e0b';
                    rallyDesc = `üü®üü• <strong>Carton ${rally.color}</strong> pour ${rally.team === 'us' ? 'NOUS' : 'EUX'}`;
                } else if (rally.actions && rally.actions.length > 0) {
                    // Rally avec workflow complet
                    pointColor = rally.rallyResult?.winner === 'us' ? '#10b981' : '#ef4444';
                    
                    const actionsList = rally.actions.map(a => {
                        if (a.type === 'service') {
                            const player = a.player ? `#${a.player.player.number} ${a.player.player.firstName}` : '';
                            const result = a.result === 'ace' ? 'ACE ‚≠ê' : (a.result === 'fault' ? 'Faute ‚ùå' : 'En jeu ‚úì');
                            return `Service ${player} ‚Üí ${result}`;
                        } else if (a.type === 'reception') {
                            const player = a.player ? `#${a.player.player.number} ${a.player.player.firstName}` : '';
                            const quality = a.quality === 'perfect' ? 'Parfaite ‚≠ê' : (a.quality === 'average' ? 'Moyenne üü°' : 'Rat√©e ‚ùå');
                            return `R√©ception ${player} ‚Üí ${quality}`;
                        } else if (a.type === 'their_attack') {
                            const result = a.result === 'point' ? 'Point (eux) ‚ùå' : (a.result === 'blocked' ? 'Bloqu√©e ‚úì' : (a.result === 'out' ? 'Out ‚úì' : 'D√©fendue ‚úì'));
                            return `Leur attaque ‚Üí ${result}`;
                        } else if (a.type === 'our_attack') {
                            const player = a.player ? `#${a.player.player.number} ${a.player.player.firstName}` : '';
                            const result = a.result === 'point' ? 'Point ‚úì' : (a.result === 'blocked' ? 'Bloqu√©e ‚ùå' : (a.result === 'out' ? 'Out ‚ùå' : 'D√©fendue'));
                            return `Attaque ${player} ‚Üí ${result}`;
                        }
                        return a.type;
                    }).join(' ‚Ä¢ ');
                    
                    const winner = rally.rallyResult?.winner === 'us' ? '‚úÖ NOUS' : '‚ùå EUX';
                    rallyDesc = `
                        <div style="margin-bottom: 0.25rem;">${actionsList}</div>
                        <div style="font-weight: 700; margin-top: 0.25rem;">‚Üí Point pour ${winner}</div>
                    `;
                }
                
                historyHTML += `
                    <div style="padding: 1rem; margin-bottom: 0.75rem; background: white; border-left: 4px solid ${pointColor}; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="font-weight: 800; color: ${pointColor}; font-size: 1.1rem;">Point #${num}</span>
                            <span style="font-size: 0.7rem; color: #999;">${new Date(rally.timestamp).toLocaleTimeString('fr-FR')}</span>
                        </div>
                        <div style="font-size: 0.85rem; color: #1a1a1a; line-height: 1.5;">
                            ${rallyDesc}
                        </div>
                    </div>
                `;
            });
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 16px; max-width: 700px; width: 100%; max-height: 80vh; overflow-y: auto;">
                    <h2 style="margin: 0 0 1.5rem 0; color: #EC4899; text-align: center; position: sticky; top: 0; background: white; padding-bottom: 1rem; border-bottom: 2px solid #fce7f3;">
                        üìã Historique des Actions
                    </h2>
                    <div>
                        ${historyHTML}
                    </div>
                    <button onclick="closeHistoryModal()" style="width: 100%; padding: 0.75rem; background: #EC4899; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 1rem;">
                        Fermer
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function closeHistoryModal() {
            const modal = document.getElementById('history-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Afficher les statistiques
        function showStatsSummary() {
            alert('üìä STATISTIQUES\n\nTODO: Affichage d√©taill√© des stats par joueur');
        }
        
        // Surcharger nextSet pour r√©initialiser les timeouts
        const originalNextSet = window.nextSet;
        window.nextSet = function() {
            if (originalNextSet) {
                originalNextSet();
            }
            resetTimeoutsForNewSet();
            
            // R√©initialiser le service (on redemandera au 1er point)
            serviceTeam = null;
            console.log('üîÑ Nouveau set ‚Üí Service r√©initialis√©');
            
            // R√©initialiser aussi la composition si n√©cessaire
            if (matchSetup) {
                loadCourtComposition();
            }
            
            // Mettre √† jour l'indicateur
            updateServiceIndicator();
        };
        
        // Initialiser le workflow
        if (matchSetup) {
            loadCourtComposition();
        }
        
        // Fin du syst√®me workflow

        // Fonction pour mettre √† jour l'affichage (ancienne version - conserv√©e pour compatibilit√©)
        function updateDisplay() {
            const data = LCVBScoreboard.getScoreData();
            
            // Mise √† jour des champs de noms
            document.getElementById('team1-name').value = data.team1.name;
            document.getElementById('team2-name').value = data.team2.name;
            
            // Mise √† jour des champs de niveaux
            document.getElementById('team1-niveau').value = data.team1.niveau || '';
            document.getElementById('team2-niveau').value = data.team2.niveau || '';
            
            // Mise √† jour du checkbox "Match amical" (commun)
            const matchAmical = document.getElementById('match-amical');
            if (matchAmical) {
                matchAmical.checked = data.matchAmical === true;
            }
            
            // Mise √† jour du s√©lecteur de template
            const templateSelector = document.getElementById('template-selector');
            if (templateSelector) {
                const template = data.template || 'actuel';
                templateSelector.value = template;
                
                // G√©rer l'affichage du panneau de couleurs personnalis√©es
                const customPanel = document.getElementById('custom-colors-panel');
                if (template === 'custom') {
                    customPanel.style.display = 'flex';
                    const colors = data.customColors || {};
                    document.getElementById('color-primary').value = colors.primary || '#E91E63';
                    document.getElementById('color-secondary').value = colors.secondary || '#FF69B4';
                    document.getElementById('color-background').value = colors.background || '#000000';
                    document.getElementById('color-background-secondary').value = colors.backgroundSecondary || '#0f0f0f';
                    document.getElementById('color-text').value = colors.text || '#FFFFFF';
                    document.getElementById('color-set-active').value = colors.setActive || '#E91E63';
                    applyCustomColors();
                    updateConfigSelect();
                } else {
                    customPanel.style.display = 'none';
                    // Appliquer le template
                    document.body.className = document.body.className.replace(/template-\w+/g, '');
                    document.body.classList.add(`template-${template}`);
                }
            }
            
            // Mettre √† jour le s√©lecteur de configurations
            updateConfigSelect();
            
            // Mise √† jour des champs de logos
            document.getElementById('team1-logo').value = data.team1.logo;
            document.getElementById('team2-logo').value = data.team2.logo;
            
            // Mise √† jour du bouton toggle logos
            const toggleLogosBtn = document.getElementById('toggle-logos-btn');
            if (toggleLogosBtn) {
                const showLogos = data.showLogos !== false;
                toggleLogosBtn.textContent = showLogos ? 'üñºÔ∏è Masquer Logos' : 'üñºÔ∏è Afficher Logos';
                toggleLogosBtn.classList.toggle('btn-toggle-logos-off', !showLogos);
            }
            
            // Mise √† jour des scores (v√©rifier que les inputs existent et ne sont pas en focus)
            const score1Input = document.getElementById('team1-score-input');
            const score2Input = document.getElementById('team2-score-input');
            if (score1Input && document.activeElement !== score1Input && score1Input.value != data.team1.score) {
                score1Input.value = data.team1.score;
            }
            if (score2Input && document.activeElement !== score2Input && score2Input.value != data.team2.score) {
                score2Input.value = data.team2.score;
            }
            
            // Mise √† jour du s√©lecteur de set
            document.getElementById('set-selector').value = data.currentSet;
            
            // Mise √† jour des informations du match
            const matchInfo = data.matchInfo || {};
            const matchDateInput = document.getElementById('match-date');
            const matchTimeInput = document.getElementById('match-time');
            const matchLocationInput = document.getElementById('match-location');
            const matchCompetitionInput = document.getElementById('match-competition');
            const matchRefereeInput = document.getElementById('match-referee');
            const matchNotesInput = document.getElementById('match-notes');
            
            if (matchDateInput) matchDateInput.value = matchInfo.date || '';
            if (matchTimeInput) matchTimeInput.value = matchInfo.time || '';
            if (matchLocationInput) matchLocationInput.value = matchInfo.location || '';
            if (matchCompetitionInput) matchCompetitionInput.value = matchInfo.competition || '';
            if (matchRefereeInput) matchRefereeInput.value = matchInfo.referee || '';
            if (matchNotesInput) matchNotesInput.value = matchInfo.notes || '';
            
            // Mise √† jour du bouton Undo (actif/inactif selon l'historique)
            const undoBtn = document.getElementById('btn-undo');
            if (undoBtn) {
                const hasHistory = data.history && data.history.length > 0 && data.historyIndex >= 0;
                undoBtn.disabled = !hasHistory;
                undoBtn.style.opacity = hasHistory ? '1' : '0.5';
                undoBtn.style.cursor = hasHistory ? 'pointer' : 'not-allowed';
            }
            
            // Mise √† jour des contr√¥les de sets
            updateSetsControls();
            
            // Mettre √† jour l'affichage des chronom√®tres
            updateTimersDisplay();
        }

        // Fonction pour mettre √† jour les contr√¥les de sets
        function updateSetsControls() {
            const data = LCVBScoreboard.getScoreData();
            const team1Controls = document.getElementById('team1-sets-controls');
            const team2Controls = document.getElementById('team2-sets-controls');
            
            team1Controls.innerHTML = '';
            team2Controls.innerHTML = '';
            
            for (let i = 0; i < data.maxSets; i++) {
                const setNum = i + 1;
                
                // Contr√¥les √©quipe 1
                const row1 = document.createElement('div');
                row1.className = 'sets-row';
                
                const label1 = document.createElement('span');
                label1.className = 'set-label';
                label1.textContent = `Set ${setNum} :`;
                
                const input1 = document.createElement('input');
                input1.type = 'number';
                input1.id = `team1-set${setNum}-input`;
                input1.className = 'set-input';
                input1.min = '0';
                input1.max = '99';
                input1.value = data.team1.sets[i] || 0;
                input1.addEventListener('change', () => setSetDirect('team1', i, input1.value));
                input1.addEventListener('input', () => validateSetInput(input1));
                
                const plus1 = document.createElement('button');
                plus1.className = 'btn btn-plus';
                plus1.style.cssText = 'padding: 10px 15px; font-size: 1em;';
                plus1.textContent = '+';
                plus1.onclick = () => changeSet('team1', i, 1);
                
                const minus1 = document.createElement('button');
                minus1.className = 'btn btn-minus';
                minus1.style.cssText = 'padding: 10px 15px; font-size: 1em;';
                minus1.textContent = '‚àí';
                minus1.onclick = () => changeSet('team1', i, -1);
                
                row1.appendChild(label1);
                row1.appendChild(input1);
                row1.appendChild(plus1);
                row1.appendChild(minus1);
                team1Controls.appendChild(row1);
                
                // Contr√¥les √©quipe 2
                const row2 = document.createElement('div');
                row2.className = 'sets-row';
                
                const label2 = document.createElement('span');
                label2.className = 'set-label';
                label2.textContent = `Set ${setNum} :`;
                
                const input2 = document.createElement('input');
                input2.type = 'number';
                input2.id = `team2-set${setNum}-input`;
                input2.className = 'set-input';
                input2.min = '0';
                input2.max = '99';
                input2.value = data.team2.sets[i] || 0;
                input2.addEventListener('change', () => setSetDirect('team2', i, input2.value));
                input2.addEventListener('input', () => validateSetInput(input2));
                
                const plus2 = document.createElement('button');
                plus2.className = 'btn btn-plus';
                plus2.style.cssText = 'padding: 10px 15px; font-size: 1em;';
                plus2.textContent = '+';
                plus2.onclick = () => changeSet('team2', i, 1);
                
                const minus2 = document.createElement('button');
                minus2.className = 'btn btn-minus';
                minus2.style.cssText = 'padding: 10px 15px; font-size: 1em;';
                minus2.textContent = '‚àí';
                minus2.onclick = () => changeSet('team2', i, -1);
                
                row2.appendChild(label2);
                row2.appendChild(input2);
                row2.appendChild(plus2);
                row2.appendChild(minus2);
                team2Controls.appendChild(row2);
            }
        }

        // Fonction pour changer le score avec les boutons +/-
        function changeScore(team, delta) {
            LCVBScoreboard.updateScore(team, delta);
            updateDisplay();
        }
        
        // Fonction pour d√©finir le score directement via input
        function setScoreDirect(team, value) {
            const score = parseInt(value) || 0;
            const data = LCVBScoreboard.getScoreData();
            const oldData = JSON.parse(JSON.stringify(data)); // Sauvegarder l'√©tat avant
            const oldScore = data[team].score;
            const newScore = Math.max(0, Math.min(999, score));
            
            // V√©rifier si c'est le premier point du match
            const wasFirstPointOfMatch = data.team1.score === 0 && data.team2.score === 0 && newScore > 0 && oldScore === 0;
            
            // V√©rifier si c'est le premier point du set actuel
            const currentSetIndex = data.currentSet - 1;
            const setScore1 = data.team1.sets[currentSetIndex] || 0;
            const setScore2 = data.team2.sets[currentSetIndex] || 0;
            const wasFirstPointOfSet = (setScore1 === 0 && setScore2 === 0 && 
                                         data.team1.score === 0 && data.team2.score === 0 && 
                                         newScore > 0 && oldScore === 0);
            
            data[team].score = newScore;
            
            // Initialiser les timers si n√©cessaire
            if (!data.timers) {
                data.timers = {
                    match: { startTime: null, pausedTime: 0, isRunning: false, isPaused: false },
                    sets: Array(5).fill(null).map(() => ({ startTime: null, pausedTime: 0, isRunning: false, isPaused: false }))
                };
            }
            
            // D√©marrer automatiquement le chronom√®tre du match au premier point du match
            if (wasFirstPointOfMatch && !data.timers.match.isRunning) {
                data.timers.match.startTime = Date.now();
                data.timers.match.isRunning = true;
                data.timers.match.isPaused = false;
                data.timers.match.pausedTime = 0;
            }
            
            // D√©marrer automatiquement le chronom√®tre du set au premier point du set
            if (wasFirstPointOfSet && currentSetIndex >= 0 && currentSetIndex < 5) {
                const timer = data.timers.sets[currentSetIndex];
                if (!timer.isRunning) {
                    timer.startTime = Date.now();
                    timer.isRunning = true;
                    timer.isPaused = false;
                    timer.pausedTime = 0;
                }
            }
            
            // Ajouter √† l'historique
            LCVBScoreboard.addToHistory('setScoreDirect', oldData, data, { team: team, score: score });
            
            LCVBScoreboard.saveScoreData(data);
            updateDisplay();
        }
        
        // Validation de l'input de score
        function validateScoreInput(input) {
            let value = parseInt(input.value);
            if (isNaN(value) || value < 0) {
                value = 0;
            }
            if (value > 999) {
                value = 999;
            }
            input.value = value;
        }

        // Fonction pour r√©initialiser le score d'une √©quipe
        function resetScore(team) {
            const data = LCVBScoreboard.getScoreData();
            data[team].score = 0;
            LCVBScoreboard.saveScoreData(data);
            updateDisplay();
        }

        // Fonction pour changer le set avec les boutons +/-
        function changeSet(team, setIndex, delta) {
            LCVBScoreboard.updateSet(team, setIndex, delta);
            // Mettre √† jour l'input directement pour feedback imm√©diat
            const data = LCVBScoreboard.getScoreData();
            const input = document.getElementById(`${team}-set${setIndex + 1}-input`);
            if (input && document.activeElement !== input) {
                input.value = data[team].sets[setIndex] || 0;
            }
            updateDisplay();
        }
        
        // Fonction pour d√©finir le set directement via input
        function setSetDirect(team, setIndex, value) {
            const score = parseInt(value) || 0;
            const data = LCVBScoreboard.getScoreData();
            const oldData = JSON.parse(JSON.stringify(data)); // Sauvegarder l'√©tat avant
            data[team].sets[setIndex] = Math.max(0, Math.min(99, score));
            
            // Ajouter √† l'historique
            LCVBScoreboard.addToHistory('setSetDirect', oldData, data, { team: team, setIndex: setIndex, score: score });
            
            LCVBScoreboard.saveScoreData(data);
            updateDisplay();
        }
        
        // Validation de l'input de set
        function validateSetInput(input) {
            let value = parseInt(input.value);
            if (isNaN(value) || value < 0) {
                value = 0;
            }
            if (value > 99) {
                value = 99;
            }
            input.value = value;
        }

        // Fonction pour changer le set actuel
        function changeCurrentSet() {
            const setNum = parseInt(document.getElementById('set-selector').value);
            const data = LCVBScoreboard.getScoreData();
            
            // Sauvegarder les scores du set actuel avant de changer
            const currentSetIndex = data.currentSet - 1;
            data.team1.sets[currentSetIndex] = data.team1.score;
            data.team2.sets[currentSetIndex] = data.team2.score;
            LCVBScoreboard.saveScoreData(data);
            
            // Charger les scores du nouveau set si disponible
            const newSetIndex = setNum - 1;
            if (data.team1.sets[newSetIndex] > 0 || data.team2.sets[newSetIndex] > 0) {
                // Le set a d√©j√† √©t√© jou√©, on charge les scores sauvegard√©s
                data.team1.score = data.team1.sets[newSetIndex];
                data.team2.score = data.team2.sets[newSetIndex];
            } else {
                // Nouveau set, on r√©initialise
                data.team1.score = 0;
                data.team2.score = 0;
            }
            
            LCVBScoreboard.changeSet(setNum);
            updateDisplay();
        }

        // Fonction pour passer au set suivant
        function nextSet() {
            const data = LCVBScoreboard.getScoreData();
            const currentSet = data.currentSet;
            const newSet = currentSet + 1;
            
            LCVBScoreboard.nextSet();
            updateDisplay();
            
            // R√©initialiser l'historique du set en cours (qui sera vide pour le nouveau set)
            updateCurrentSetHistory();
            
            // Mettre √† jour les statistiques des sets pr√©c√©dents
            updatePreviousSetsStats();
            
            // R√©initialiser le positionnement et afficher la modal pour le nouveau set
            localStorage.removeItem('lcvb_current_positioning');
            setTimeout(() => {
                if (typeof showPositioningModal === 'function') {
                    showPositioningModal(newSet);
                }
            }, 300);
        }

        // Fonction pour annuler la derni√®re action
        function undoAction() {
            const result = LCVBScoreboard.undoLastAction();
            if (result) {
                updateDisplay();
            } else {
                alert('Aucune action √† annuler');
            }
        }

        // Fonction pour r√©initialiser tout
        function resetEverything() {
            if (confirm('‚ö†Ô∏è ATTENTION !\n\nCela va r√©initialiser TOUT le match :\n- Scores\n- Historique\n- Positionnement des joueurs\n- Lib√©ro\n- Service\n\n√ätes-vous s√ªr ?')) {
                // R√©initialiser le scoreboard
                LCVBScoreboard.resetAll();
                
                // R√©initialiser les variables globales
                serviceTeam = null;
                window.isPositioningMode = true;
                window.startingLineupValidated = false;
                window.selectedServiceTeam = null;
                
                // R√©initialiser la composition du terrain
                courtComposition = {
                    positions: {},
                    libero: {
                        player: null,
                        onCourt: false,
                        replacing: null
                    }
                };
                
                // R√©initialiser les statistiques
                matchStats = {
                    rallies: []
                };
                
                // R√©initialiser les timeouts
                timeoutsCount = {
                    team1: 0,
                    team2: 0
                };
                
                // R√©afficher le bouton de validation
                const validateBtn = document.getElementById('validate-lineup-btn');
                if (validateBtn) {
                    validateBtn.style.display = 'block';
                    validateBtn.disabled = true;
                    validateBtn.style.background = '#9ca3af';
                }
                
                // Masquer les boutons de service
                const buttonsDiv = document.getElementById('service-choice-buttons');
                if (buttonsDiv) buttonsDiv.style.display = 'none';
                
                // Mettre √† jour l'affichage
                updateCourtDisplay();
                updateServiceIndicator();
                updateCompactDisplay();
                updateCurrentSetHistory();
                updatePreviousSetsStats();
                
                alert('‚úÖ Match r√©initialis√© !\n\nVous pouvez maintenant :\n1. Cliquer sur les positions P1-P6 pour assigner les joueurs\n2. Valider le 6 de d√©part\n3. Choisir le service et le lib√©ro');
                
                console.log('‚úÖ Match compl√®tement r√©initialis√©');
            }
        }
        
        // Fonction pour toggle l'affichage des logos
        function toggleLogos() {
            LCVBScoreboard.toggleShowLogos();
            updateDisplay();
        }
        
        // Fonction pour mettre √† jour le flag "Match amical" (commun)
        function updateMatchAmicalCommon(isAmical) {
            LCVBScoreboard.updateMatchAmicalCommon(isAmical);
            updateDisplay();
        }

        // Fonction pour mettre √† jour les informations du match
        function updateMatchInfo(field, value) {
            LCVBScoreboard.updateMatchInfo(field, value);
            updateDisplay();
        }

        // Fonction pour afficher la modal de partage r√©seaux sociaux
        function showSocialShare() {
            const modal = document.getElementById('social-modal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        // Fonction pour fermer la modal
        function closeSocialModal() {
            const modal = document.getElementById('social-modal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        // Fermer la modal en cliquant en dehors
        window.onclick = function(event) {
            const modal = document.getElementById('social-modal');
            if (event.target === modal) {
                closeSocialModal();
            }
        }

        // Fonction pour changer le mode (template ou custom)
        function changeTemplateMode(mode) {
            const data = LCVBScoreboard.getScoreData();
            data.template = mode;
            LCVBScoreboard.saveScoreData(data);
            
            // Afficher/masquer le panneau de couleurs personnalis√©es
            const customPanel = document.getElementById('custom-colors-panel');
            if (mode === 'custom') {
                customPanel.classList.add('active');
                // Charger toutes les couleurs actuelles
                const colors = data.customColors || {};
                document.getElementById('color-primary').value = colors.primary || '#E91E63';
                document.getElementById('color-secondary').value = colors.secondary || '#FF69B4';
                document.getElementById('color-background').value = colors.background || '#000000';
                document.getElementById('color-background-secondary').value = colors.backgroundSecondary || '#0f0f0f';
                document.getElementById('color-text').value = colors.text || '#FFFFFF';
                document.getElementById('color-set-active').value = colors.setActive || '#E91E63';
                applyCustomColors();
                updateConfigSelect();
            } else {
                customPanel.classList.remove('active');
                // Appliquer le template √† la page courante
                document.body.className = document.body.className.replace(/template-\w+/g, '');
                document.body.classList.add(`template-${mode}`);
                // Si c'est le template PRO, pas besoin d'appliquer ici car c'est g√©r√© dans index.html
            }
        }

        // Fonction pour mettre √† jour les couleurs personnalis√©es
        function updateCustomColor(type, color) {
            const data = LCVBScoreboard.getScoreData();
            if (!data.customColors) {
                data.customColors = {
                    primary: '#E91E63',
                    secondary: '#FF69B4',
                    background: '#000000',
                    backgroundSecondary: '#0f0f0f',
                    text: '#FFFFFF',
                    setActive: '#E91E63'
                };
            }
            data.customColors[type] = color;
            data.template = 'custom';
            LCVBScoreboard.saveScoreData(data);
            applyCustomColors();
        }

        // Fonction pour appliquer les couleurs personnalis√©es
        function applyCustomColors() {
            const data = LCVBScoreboard.getScoreData();
            if (data.template !== 'custom' || !data.customColors) return;
            
            const colors = data.customColors;
            const primary = colors.primary || '#E91E63';
            const secondary = colors.secondary || '#FF69B4';
            const background = colors.background || '#000000';
            const backgroundSecondary = colors.backgroundSecondary || '#0f0f0f';
            const text = colors.text || '#FFFFFF';
            const setActive = colors.setActive || '#E91E63';
            
            // Convertir hex en RGB
            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '233, 30, 99';
            }
            
            const primaryRgb = hexToRgb(primary);
            const backgroundRgb = hexToRgb(background);
            const backgroundSecondaryRgb = hexToRgb(backgroundSecondary);
            
            // Appliquer le template custom et d√©finir les variables CSS
            document.body.className = document.body.className.replace(/template-\w+/g, '');
            document.body.classList.add('template-custom');
            
            // D√©finir toutes les variables CSS dynamiquement
            document.documentElement.style.setProperty('--template-primary', primary);
            document.documentElement.style.setProperty('--template-primary-light', secondary);
            document.documentElement.style.setProperty('--template-primary-rgb', primaryRgb);
            document.documentElement.style.setProperty('--template-border', primary);
            document.documentElement.style.setProperty('--template-accent', primary);
            document.documentElement.style.setProperty('--template-bg', background);
            document.documentElement.style.setProperty('--template-bg-gradient', `linear-gradient(180deg, ${background} 0%, ${backgroundSecondary} 100%)`);
            document.documentElement.style.setProperty('--template-text', text);
            
            // Variable pour les sets actifs (utilis√©e dans .set-badge.active)
            const style = document.createElement('style');
            style.id = 'custom-colors-style';
            if (document.getElementById('custom-colors-style')) {
                document.getElementById('custom-colors-style').remove();
            }
            style.textContent = `
                body.template-custom .set-badge.active,
                body.template-custom .set-badge.won {
                    background: ${setActive};
                    border-color: ${setActive};
                }
            `;
            document.head.appendChild(style);
        }

        // Fonction pour sauvegarder la configuration actuelle
        function saveConfig() {
            const nameInput = document.getElementById('config-name-input');
            const configName = nameInput.value.trim();
            
            if (!configName) {
                alert('Veuillez entrer un nom pour la configuration');
                return;
            }
            
            const data = LCVBScoreboard.getScoreData();
            if (!data.savedConfigs) {
                data.savedConfigs = {};
            }
            
            // Sauvegarder la configuration actuelle
            data.savedConfigs[configName] = {
                customColors: JSON.parse(JSON.stringify(data.customColors || {})),
                template: 'custom',
                savedAt: new Date().toISOString()
            };
            
            LCVBScoreboard.saveScoreData(data);
            nameInput.value = '';
            updateConfigSelect();
            alert(`Configuration "${configName}" sauvegard√©e avec succ√®s !`);
        }

        // Fonction pour charger une configuration sauvegard√©e
        function loadConfig(configName) {
            if (!configName) return;
            
            const data = LCVBScoreboard.getScoreData();
            if (!data.savedConfigs || !data.savedConfigs[configName]) {
                alert('Configuration introuvable');
                return;
            }
            
            const config = data.savedConfigs[configName];
            data.customColors = JSON.parse(JSON.stringify(config.customColors));
            data.template = 'custom';
            LCVBScoreboard.saveScoreData(data);
            
            // Mettre √† jour les inputs
            document.getElementById('color-primary').value = data.customColors.primary || '#E91E63';
            document.getElementById('color-secondary').value = data.customColors.secondary || '#FF69B4';
            document.getElementById('color-background').value = data.customColors.background || '#000000';
            document.getElementById('color-background-secondary').value = data.customColors.backgroundSecondary || '#0f0f0f';
            document.getElementById('color-text').value = data.customColors.text || '#FFFFFF';
            document.getElementById('color-set-active').value = data.customColors.setActive || '#E91E63';
            
            applyCustomColors();
            updateDisplay();
        }

        // Fonction pour supprimer la configuration actuellement s√©lectionn√©e
        function deleteCurrentConfig() {
            const select = document.getElementById('load-config-select');
            const configName = select.value;
            
            if (!configName) {
                alert('Aucune configuration s√©lectionn√©e');
                return;
            }
            
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer la configuration "${configName}" ?`)) {
                return;
            }
            
            const data = LCVBScoreboard.getScoreData();
            if (data.savedConfigs && data.savedConfigs[configName]) {
                delete data.savedConfigs[configName];
                LCVBScoreboard.saveScoreData(data);
                updateConfigSelect();
                select.value = '';
                alert(`Configuration "${configName}" supprim√©e`);
            }
        }

        // Fonction pour mettre √† jour le s√©lecteur de configurations
        function updateConfigSelect() {
            const select = document.getElementById('load-config-select');
            const data = LCVBScoreboard.getScoreData();
            const savedConfigs = data.savedConfigs || {};
            
            // Garder l'option par d√©faut
            const defaultOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            select.appendChild(defaultOption);
            
            // Ajouter toutes les configurations sauvegard√©es
            Object.keys(savedConfigs).sort().forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }

        // Fonction pour changer le template (ancienne fonction, gard√©e pour compatibilit√©)
        function changeTemplate(templateName) {
            changeTemplateMode(templateName);
        }
        
        // √âcouter les changements des champs de nom
        document.getElementById('team1-name').addEventListener('input', function() {
            LCVBScoreboard.updateTeamName('team1', this.value);
        });

        document.getElementById('team2-name').addEventListener('input', function() {
            LCVBScoreboard.updateTeamName('team2', this.value);
        });
        
        // √âcouter les changements des champs de niveau (select)
        document.getElementById('team1-niveau').addEventListener('change', function() {
            LCVBScoreboard.updateTeamNiveau('team1', this.value);
        });

        document.getElementById('team2-niveau').addEventListener('change', function() {
            LCVBScoreboard.updateTeamNiveau('team2', this.value);
        });

        // Fonction pour g√©rer la s√©lection de fichier logo
        function handleLogoFileSelect(team, fileInput) {
            const file = fileInput.files[0];
            if (file) {
                // Cr√©er une URL locale pour l'image
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Utiliser l'URL du fichier pour l'affichage imm√©diat
                    const logoPath = `logos/${file.name}`;
                    const logoInput = document.getElementById(`${team}-logo`);
                    
                    // Mettre √† jour le champ texte
                    logoInput.value = logoPath;
                    
                    // Sauvegarder dans localStorage
                    LCVBScoreboard.updateTeamLogo(team, logoPath);
                    
                    // Note: Pour que √ßa fonctionne vraiment, vous devez copier le fichier 
                    // dans le dossier logos manuellement ou utiliser un serveur local
                    alert(`Logo s√©lectionn√©: ${file.name}\n\nPour que le logo s'affiche correctement, copiez le fichier dans le dossier "logos/" et renommez-le si n√©cessaire.\n\nChemin sugg√©r√©: logos/${file.name}`);
                };
                reader.readAsDataURL(file);
            }
        }
        
        // √âcouter les changements des champs de logo (saisie manuelle)
        document.getElementById('team1-logo').addEventListener('input', function() {
            LCVBScoreboard.updateTeamLogo('team1', this.value);
        });

        document.getElementById('team2-logo').addEventListener('input', function() {
            LCVBScoreboard.updateTeamLogo('team2', this.value);
        });

        // Fonction pour r√©initialiser le chronom√®tre du set actuel
        function resetCurrentSetTimer() {
            const data = LCVBScoreboard.getScoreData();
            const currentSetIndex = data.currentSet - 1;
            LCVBScoreboard.resetSetTimer(currentSetIndex);
            updateTimersDisplay(); // Mettre √† jour l'affichage imm√©diatement
        }

        // Fonction pour mettre √† jour l'affichage des chronom√®tres
        function updateTimersDisplay() {
            // Chronom√®tre du match
            const matchElapsed = LCVBScoreboard.getMatchElapsedTime();
            const matchTimeFormatted = LCVBScoreboard.formatMatchTime(matchElapsed);
            const matchTimerDisplay = document.getElementById('match-timer-display');
            if (matchTimerDisplay) {
                matchTimerDisplay.textContent = matchTimeFormatted;
            }

            // Chronom√®tre du set actuel
            const data = LCVBScoreboard.getScoreData();
            const currentSetIndex = data.currentSet - 1;
            const setElapsed = LCVBScoreboard.getSetElapsedTime(currentSetIndex);
            const setTimeFormatted = LCVBScoreboard.formatSetTime(setElapsed);
            const setTimerDisplay = document.getElementById('set-timer-display');
            const currentSetNumber = document.getElementById('current-set-number');
            
            if (setTimerDisplay) {
                setTimerDisplay.textContent = setTimeFormatted;
            }
            if (currentSetNumber) {
                currentSetNumber.textContent = data.currentSet;
            }
        }

        // Mise √† jour initiale
        updateDisplay();
        updateTimersDisplay();

        // Mettre √† jour les chronom√®tres toutes les secondes
        setInterval(() => {
            updateTimersDisplay();
        }, 1000);

        // Surveiller les changements localStorage (pour synchronisation multi-fen√™tres)
        let lastControlHash = '';
        setInterval(() => {
            const currentHash = JSON.stringify(LCVBScoreboard.getScoreData());
            if (currentHash !== lastControlHash) {
                lastControlHash = currentHash;
                updateDisplay();
            }
        }, 100);
        
        // Pour les changements depuis une autre fen√™tre/onglet
        window.addEventListener('storage', (e) => {
            if (e.key === 'lcvb_score') {
                lastControlHash = '';
                updateDisplay();
            }
        });

        function clearStartingLineup() {
            // R√©initialiser la composition du terrain
            courtComposition.positions = {
                1: null,
                2: null,
                3: null,
                4: null,
                5: null,
                6: null
            };
            courtComposition.libero = {
                player: null,
                onCourt: false,
                replacing: null,
                enabled: false
            };
            updateCourtDisplay();
            
            // R√©initialiser les variables globales
            window.setterPosition = null;
            window.setterPlayerId = null;
            window.selectedStartingLibero = null;
            window.isPositioningMode = true;
            window.startingLineupValidated = false;
            
            // R√©initialiser l'affichage du lib√©ro s√©lectionn√©
            const display = document.getElementById('selected-libero-display');
            const info = document.getElementById('selected-libero-info');
            if (display) {
                display.style.display = 'none';
            }
            if (info) {
                info.innerHTML = '';
            }
            
            // R√©initialiser les boutons
            const validateBtn = document.getElementById('validate-lineup-btn');
            const liberoBtn = document.getElementById('choose-libero-btn');
            if (validateBtn) {
                validateBtn.disabled = true;
                validateBtn.style.opacity = '0.5';
                validateBtn.style.cursor = 'not-allowed';
            }
            if (liberoBtn) {
                liberoBtn.disabled = true;
                liberoBtn.style.opacity = '0.5';
                liberoBtn.style.cursor = 'not-allowed';
                liberoBtn.style.display = 'none';
            }
            
            updatePositioningInstructions();
            showNotification('üéØ Terrain vid√©. Recommencez votre placement.', 'info');
        }

        // Choisir le lib√©ro titulaire (7√®me joueur)
        window.selectedStartingLibero = null;
    </script>

    <!-- Bloc script supprim√© - Fonctions d√©plac√©es dans le script principal pour acc√®s aux variables -->

    <!-- Modal pour le partage r√©seaux sociaux -->
    <div id="social-modal" class="social-modal">
        <div class="social-modal-content">
            <div class="social-modal-header">
                <h2>üì± Publier sur les r√©seaux sociaux</h2>
                <span class="social-close" onclick="closeSocialModal()">&times;</span>
            </div>
            
            <div class="social-platforms">
                <!-- Instagram -->
                <div class="social-platform">
                    <h3>üì∑ Instagram</h3>
                    <p><strong>Stories :</strong></p>
                    <p>1. Lancez votre live sur Instagram</p>
                    <p>2. Utilisez l'option "Ajouter √† votre story" pendant le live</p>
                    <p>3. Le live sera visible dans vos stories pendant 24h</p>
                    <a href="https://help.instagram.com/196801932981584" target="_blank" class="social-link-btn">Guide Instagram</a>
                </div>

                <!-- Facebook -->
                <div class="social-platform">
                    <h3>üë• Facebook</h3>
                    <p><strong>Live / Stories :</strong></p>
                    <p>1. Cr√©ez une publication "Live"</p>
                    <p>2. Partagez le live directement depuis OBS</p>
                    <p>3. Utilisez Facebook Live Producer pour la diffusion</p>
                    <a href="https://www.facebook.com/live/producer" target="_blank" class="social-link-btn">Facebook Live Producer</a>
                </div>

                <!-- TikTok -->
                <div class="social-platform">
                    <h3>üéµ TikTok</h3>
                    <p><strong>Live Streaming :</strong></p>
                    <p>1. Ouvrez TikTok et cr√©ez un Live</p>
                    <p>2. Utilisez un outil de streaming (OBS avec plugin)</p>
                    <p>3. Configurez la cl√© de stream dans OBS</p>
                    <a href="https://support.tiktok.com/fr/using-tiktok/starting-out-with-live" target="_blank" class="social-link-btn">Guide TikTok Live</a>
                </div>

                <!-- YouTube -->
                <div class="social-platform">
                    <h3>‚ñ∂Ô∏è YouTube</h3>
                    <p><strong>Streaming :</strong></p>
                    <p>1. Cr√©ez un live event sur YouTube Studio</p>
                    <p>2. R√©cup√©rez la cl√© de stream</p>
                    <p>3. Configurez OBS avec cette cl√©</p>
                    <a href="https://studio.youtube.com" target="_blank" class="social-link-btn">YouTube Studio</a>
                </div>
            </div>

            <div class="social-guide">
                <h3>üéØ Multi-diffusion (simultan√©e sur plusieurs plateformes)</h3>
                <p>Pour diffuser en simultan√© sur plusieurs plateformes, vous pouvez utiliser :</p>
                <ul>
                    <li><strong>Restream.io</strong> : Service de multi-diffusion professionnel</li>
                    <li><strong>OBS avec plugins</strong> : RTMP vers plusieurs destinations</li>
                    <li><strong>Streamlabs</strong> : Solution tout-en-un pour le streaming</li>
                    <li><strong>XSplit</strong> : Alternative √† OBS avec multi-diffusion</li>
                </ul>
                <a href="https://restream.io" target="_blank" class="social-link-btn">Essayer Restream.io</a>
            </div>

            <div class="social-guide" style="margin-top: 20px;">
                <h3>üí° Conseils pour le partage</h3>
                <ul>
                    <li>Ajoutez des hashtags pertinents (#volley #sport #live)</li>
                    <li>Planifiez vos lives √† l'avance pour informer votre audience</li>
                    <li>Interagissez avec les commentaires pendant le live</li>
                    <li>Partagez le replay apr√®s le match</li>
                    <li>Utilisez des vignettes attrayantes pour annoncer le live</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>


