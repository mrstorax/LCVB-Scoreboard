<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, initial-scale=1.0">
    <title>LCVB Scoreboard - Affichage</title>
    <link rel="stylesheet" href="style.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: transparent;
        }
        body.template-pro {
            width: 400px;
            height: 110px;
        }
        body:not(.template-pro) {
            width: 1920px;
            height: 120px;
        }
    </style>
</head>
<body>
    <!-- Layout standard (templates actuel, neutre, sobre, custom) -->
    <div class="scoreboard-banner" id="scoreboard-standard">
        <!-- Équipe 1 -->
        <div class="team-banner team-left">
            <div class="team-logo-wrapper" id="team1-logo-wrapper">
                <img id="team1-logo" class="team-logo-img" src="logos/logo-lcvb.png" alt="Logo Équipe 1" onerror="this.style.display='none'">
            </div>
            <div class="team-name-wrapper">
                <div class="team-name" id="team1-name">Le Crès Volley-Ball</div>
                <div class="team-niveau" id="team1-niveau"></div>
            </div>
            <div class="sets-wrapper" id="team1-sets">
                <!-- Les sets seront générés dynamiquement -->
            </div>
            <div class="score-wrapper">
                <div class="team-score" id="team1-score">0</div>
            </div>
        </div>

        <!-- Séparateur central -->
        <div class="banner-separator">
            <div class="set-indicator" id="current-set">SET 1</div>
        </div>

        <!-- Équipe 2 (ordre inversé pour effet miroir) -->
        <div class="team-banner team-right">
            <div class="score-wrapper">
                <div class="team-score" id="team2-score">0</div>
            </div>
            <div class="sets-wrapper" id="team2-sets">
                <!-- Les sets seront générés dynamiquement -->
            </div>
            <div class="team-name-logo-wrapper">
                <div class="team-name-wrapper">
                    <div class="team-name" id="team2-name">Équipe 2</div>
                    <div class="team-niveau" id="team2-niveau"></div>
                </div>
                <div class="team-logo-wrapper" id="team2-logo-wrapper">
                    <img id="team2-logo" class="team-logo-img" src="logos/logo-equipe2.png" alt="Logo Équipe 2" onerror="this.style.display='none'">
                </div>
            </div>
        </div>
    </div>

    <!-- Layout PRO (structure en 3 colonnes) -->
    <div class="scoreboard-pro" id="scoreboard-pro" style="display: none;">
        <!-- Colonne gauche : Logo Championnat/Ligue -->
        <div class="pro-left-section">
            <div class="pro-logo-container" id="pro-league-logo">
                <img id="pro-club-logo" class="pro-club-logo-img" src="logo-club/logo-club.png" alt="Logo Club" onerror="this.src='logo-club/logo-club.PNG'; this.onerror=function(){this.src='logos/Logo LCVB.PNG'; this.onerror=function(){this.style.display='none';};};" style="display: block;">
            </div>
        </div>

        <!-- Colonne centrale : Informations Match -->
        <div class="pro-center-section">
            <div class="pro-header" id="pro-match-type"></div>
            <div class="pro-teams-container">
                <div class="pro-team-row" id="pro-team1-row">
                    <div class="pro-team-logo-circle" id="pro-team1-logo-circle">
                        <img id="pro-team1-logo" class="pro-team-logo-img" src="logos/image.png" alt="Logo Équipe 1" style="display: block;">
                    </div>
                    <div class="pro-team-info">
                        <div class="pro-team-name" id="pro-team1-name">Le Crès Volley-Ball</div>
                        <div class="pro-team-meta" id="pro-team1-meta"></div>
                    </div>
                </div>
                <div class="pro-team-row" id="pro-team2-row">
                    <div class="pro-team-logo-circle" id="pro-team2-logo-circle">
                        <img id="pro-team2-logo" class="pro-team-logo-img" src="logos/7DB5E809-440A-4BFF-81C5-01C7339BFB6E.PNG.jpg" alt="Logo Équipe 2" style="display: block;">
                    </div>
                    <div class="pro-team-info">
                        <div class="pro-team-name" id="pro-team2-name">Équipe 2</div>
                        <div class="pro-team-meta" id="pro-team2-meta"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Colonne droite : Scores -->
        <div class="pro-right-section">
            <div class="pro-scores-header">
                <div class="pro-score-header-item">SET</div>
                <div class="pro-score-header-item">SCORE</div>
            </div>
            <div class="pro-scores-content">
                <div class="pro-score-column">
                    <div class="pro-score-value" id="pro-team1-set">0</div>
                    <div class="pro-score-divider"></div>
                    <div class="pro-score-value" id="pro-team2-set">0</div>
                </div>
                <div class="pro-score-column">
                    <div class="pro-score-value" id="pro-team1-score">0</div>
                    <div class="pro-score-divider"></div>
                    <div class="pro-score-value" id="pro-team2-score">0</div>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Initialisation
        LCVBScoreboard.initScoreData();
        
        // Appliquer le template au chargement
        const initialData = LCVBScoreboard.getScoreData();
        const template = initialData.template || 'actuel';
        
        // Afficher/masquer les layouts selon le template initial
        const standardLayout = document.getElementById('scoreboard-standard');
        const proLayout = document.getElementById('scoreboard-pro');
        
        if (template === 'pro') {
            if (standardLayout) standardLayout.style.display = 'none';
            if (proLayout) proLayout.style.display = 'flex';
            document.body.classList.add('template-pro');
            updateProLayout(initialData);
        } else {
            if (standardLayout) standardLayout.style.display = 'flex';
            if (proLayout) proLayout.style.display = 'none';
        }
        
        if (template === 'custom' && initialData.customColors) {
            const colors = initialData.customColors;
            const primary = colors.primary || '#E91E63';
            const secondary = colors.secondary || '#FF69B4';
            const background = colors.background || '#000000';
            const backgroundSecondary = colors.backgroundSecondary || '#0f0f0f';
            const text = colors.text || '#FFFFFF';
            const setActive = colors.setActive || '#E91E63';
            
            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '233, 30, 99';
            }
            
            const primaryRgb = hexToRgb(primary);
            document.body.classList.add('template-custom');
            document.documentElement.style.setProperty('--template-primary', primary);
            document.documentElement.style.setProperty('--template-primary-light', secondary);
            document.documentElement.style.setProperty('--template-primary-rgb', primaryRgb);
            document.documentElement.style.setProperty('--template-border', primary);
            document.documentElement.style.setProperty('--template-accent', primary);
            document.documentElement.style.setProperty('--template-bg', background);
            document.documentElement.style.setProperty('--template-bg-gradient', `linear-gradient(180deg, ${background} 0%, ${backgroundSecondary} 100%)`);
            document.documentElement.style.setProperty('--template-text', text);
            
            // Style pour les sets actifs
            const styleEl = document.createElement('style');
            styleEl.id = 'custom-colors-style';
            styleEl.textContent = `
                body.template-custom .set-badge.active,
                body.template-custom .set-badge.won {
                    background: ${setActive};
                    border-color: ${setActive};
                }
            `;
            document.head.appendChild(styleEl);
        } else {
            document.body.classList.add(`template-${template}`);
        }
        
        // Variables pour suivre les changements
        let lastDataHash = '';
        let lastUpdateTime = 0;
        let lastVersion = 0;
        let lastSaveCount = 0;
        let lastUniqueId = '';

        // Fonction pour mettre à jour l'affichage
        function updateDisplay() {
            const data = LCVBScoreboard.getScoreData();
            
            // Appliquer le template ou les couleurs personnalisées
            const template = data.template || 'actuel';
            document.body.className = document.body.className.replace(/template-\w+/g, '');
            
            // Afficher/masquer les layouts selon le template
            const standardLayout = document.getElementById('scoreboard-standard');
            const proLayout = document.getElementById('scoreboard-pro');
            
            if (template === 'pro') {
                if (standardLayout) standardLayout.style.display = 'none';
                if (proLayout) proLayout.style.display = 'flex';
                document.body.classList.add('template-pro');
                updateProLayout(data);
            } else {
                if (standardLayout) standardLayout.style.display = 'flex';
                if (proLayout) proLayout.style.display = 'none';
            }
            
            if (template === 'custom' && data.customColors) {
                // Appliquer toutes les couleurs personnalisées
                const colors = data.customColors;
                const primary = colors.primary || '#E91E63';
                const secondary = colors.secondary || '#FF69B4';
                const background = colors.background || '#000000';
                const backgroundSecondary = colors.backgroundSecondary || '#0f0f0f';
                const text = colors.text || '#FFFFFF';
                const setActive = colors.setActive || '#E91E63';
                
                // Convertir hex en RGB
                function hexToRgb(hex) {
                    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                    return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '233, 30, 99';
                }
                
                const primaryRgb = hexToRgb(primary);
                document.body.classList.add('template-custom');
                document.documentElement.style.setProperty('--template-primary', primary);
                document.documentElement.style.setProperty('--template-primary-light', secondary);
                document.documentElement.style.setProperty('--template-primary-rgb', primaryRgb);
                document.documentElement.style.setProperty('--template-border', primary);
                document.documentElement.style.setProperty('--template-accent', primary);
                document.documentElement.style.setProperty('--template-bg', background);
                document.documentElement.style.setProperty('--template-bg-gradient', `linear-gradient(180deg, ${background} 0%, ${backgroundSecondary} 100%)`);
                document.documentElement.style.setProperty('--template-text', text);
                
                // Style pour les sets actifs
                let styleEl = document.getElementById('custom-colors-style');
                if (styleEl) styleEl.remove();
                styleEl = document.createElement('style');
                styleEl.id = 'custom-colors-style';
                styleEl.textContent = `
                    body.template-custom .set-badge.active,
                    body.template-custom .set-badge.won {
                        background: ${setActive};
                        border-color: ${setActive};
                    }
                `;
                document.head.appendChild(styleEl);
            } else {
                document.body.classList.add(`template-${template}`);
            }
            
            // Vérifier plusieurs indicateurs de changement
            const currentUpdateTime = data.lastUpdate || 0;
            const currentVersion = data.version || 0;
            const currentSaveCount = data._saveCount || 0;
            const currentUniqueId = data._uniqueId || '';
            const dataHash = JSON.stringify(data);
            
            // Vérifier TOUS les indicateurs (plus fiable pour OBS)
            const hasChanged = (
                currentUpdateTime !== lastUpdateTime || 
                currentVersion !== lastVersion || 
                currentSaveCount !== lastSaveCount ||
                currentUniqueId !== lastUniqueId ||
                dataHash !== lastDataHash
            );
            
            if (!hasChanged) {
                return; // Pas de changement
            }
            
            // Mettre à jour tous les trackers
            lastUpdateTime = currentUpdateTime;
            lastVersion = currentVersion;
            lastSaveCount = currentSaveCount;
            lastUniqueId = currentUniqueId;
            lastDataHash = dataHash;
            
            // Mise à jour des noms d'équipes
            document.getElementById('team1-name').textContent = data.team1.name.toUpperCase();
            document.getElementById('team2-name').textContent = data.team2.name.toUpperCase();
            
            // Mise à jour des niveaux (sans "Match amical" car c'est dans le header PRO maintenant)
            const niveau1 = document.getElementById('team1-niveau');
            const niveau2 = document.getElementById('team2-niveau');
            if (niveau1) {
                if (data.team1.niveau && data.team1.niveau.trim() !== '') {
                    niveau1.textContent = data.team1.niveau.toUpperCase();
                    niveau1.style.display = 'block';
                } else {
                    niveau1.style.display = 'none';
                }
            }
            if (niveau2) {
                if (data.team2.niveau && data.team2.niveau.trim() !== '') {
                    niveau2.textContent = data.team2.niveau.toUpperCase();
                    niveau2.style.display = 'block';
                } else {
                    niveau2.style.display = 'none';
                }
            }
            
            // Mise à jour de l'affichage des logos
            const showLogos = data.showLogos !== false; // true par défaut
            const logoWrapper1 = document.getElementById('team1-logo-wrapper');
            const logoWrapper2 = document.getElementById('team2-logo-wrapper');
            if (logoWrapper1) {
                logoWrapper1.style.display = showLogos ? 'flex' : 'none';
            }
            if (logoWrapper2) {
                logoWrapper2.style.display = showLogos ? 'flex' : 'none';
            }
            
            // Mise à jour des logos
            const logo1 = document.getElementById('team1-logo');
            const logo2 = document.getElementById('team2-logo');
            const currentSrc1 = logo1.src.substring(logo1.src.lastIndexOf('/') + 1);
            const currentSrc2 = logo2.src.substring(logo2.src.lastIndexOf('/') + 1);
            const newSrc1 = data.team1.logo.substring(data.team1.logo.lastIndexOf('/') + 1);
            const newSrc2 = data.team2.logo.substring(data.team2.logo.lastIndexOf('/') + 1);
            
            if (currentSrc1 !== newSrc1) {
                logo1.src = data.team1.logo;
            }
            if (currentSrc2 !== newSrc2) {
                logo2.src = data.team2.logo;
            }
            
            // Mise à jour des scores
            document.getElementById('team1-score').textContent = data.team1.score;
            document.getElementById('team2-score').textContent = data.team2.score;
            
            // Mise à jour du set actuel
            document.getElementById('current-set').textContent = `SET ${data.currentSet}`;
            
            // Si template PRO, mettre à jour aussi le layout PRO
            if (template === 'pro') {
                updateProLayout(data);
            }
            
            // Mise à jour des sets
            const sets1Container = document.getElementById('team1-sets');
            const sets2Container = document.getElementById('team2-sets');
            
            sets1Container.innerHTML = '';
            sets2Container.innerHTML = '';
            
            for (let i = 0; i < data.maxSets; i++) {
                const set1 = document.createElement('div');
                const set2 = document.createElement('div');
                set1.className = 'set-badge';
                set2.className = 'set-badge';
                
                // Si c'est le set actuel, on affiche le score actuel
                if (i === data.currentSet - 1) {
                    set1.textContent = data.team1.score;
                    set2.textContent = data.team2.score;
                    set1.classList.add('active');
                    set2.classList.add('active');
                } else {
                    // Pour les sets précédents, on affiche le score final
                    const score1 = data.team1.sets[i] || 0;
                    const score2 = data.team2.sets[i] || 0;
                    set1.textContent = score1 || '-';
                    set2.textContent = score2 || '-';
                    
                    // Si le set est terminé, on le marque comme gagné/perdu
                    if (score1 > 0 || score2 > 0) {
                        if (score1 > score2) {
                            set1.classList.add('won');
                            set2.classList.add('lost');
                        } else if (score2 > score1) {
                            set1.classList.add('lost');
                            set2.classList.add('won');
                        }
                    }
                }
                
                sets1Container.appendChild(set1);
                sets2Container.appendChild(set2);
            }
        }

        // Fonction pour mettre à jour le layout PRO
        function updateProLayout(data) {
            // Mettre à jour les noms des équipes
            const proTeam1Name = document.getElementById('pro-team1-name');
            const proTeam2Name = document.getElementById('pro-team2-name');
            if (proTeam1Name) proTeam1Name.textContent = data.team1.name.toUpperCase();
            if (proTeam2Name) proTeam2Name.textContent = data.team2.name.toUpperCase();
            
            // Mettre à jour le header avec "Match du (date)" ou "Match amical du (date)"
            const proMatchType = document.getElementById('pro-match-type');
            if (proMatchType) {
                const matchInfo = data.matchInfo || {};
                let dateStr = '';
                
                // Utiliser la date du match si disponible, sinon date du jour
                if (matchInfo.date) {
                    const matchDate = new Date(matchInfo.date + 'T00:00:00');
                    const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                    const months = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];
                    const dayName = days[matchDate.getDay()];
                    const day = matchDate.getDate();
                    const monthName = months[matchDate.getMonth()];
                    const year = matchDate.getFullYear();
                    dateStr = `${dayName} ${day} ${monthName} ${year}`;
                } else {
                    // Date du jour par défaut
                    const today = new Date();
                    const days = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                    const months = ['janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'];
                    const dayName = days[today.getDay()];
                    const day = today.getDate();
                    const monthName = months[today.getMonth()];
                    const year = today.getFullYear();
                    dateStr = `${dayName} ${day} ${monthName} ${year}`;
                }
                
                // Construire le texte selon si c'est un match amical ou non
                const isMatchAmical = data.matchAmical === true;
                const matchText = isMatchAmical ? 'Match amical du' : 'Match du';
                
                // Ajouter la compétition si disponible
                let headerText = `${matchText} ${dateStr}`;
                if (matchInfo.competition && matchInfo.competition.trim() !== '') {
                    headerText = `${matchInfo.competition.toUpperCase()} - ${headerText}`;
                }
                
                proMatchType.textContent = headerText;
                proMatchType.style.display = 'flex';
            }
            
            // Afficher les niveaux des équipes sous leurs noms
            const proTeam1Meta = document.getElementById('pro-team1-meta');
            const proTeam2Meta = document.getElementById('pro-team2-meta');
            
            if (proTeam1Meta) {
                if (data.team1.niveau && data.team1.niveau.trim() !== '') {
                    proTeam1Meta.textContent = data.team1.niveau.toUpperCase();
                    proTeam1Meta.style.display = 'block';
                } else {
                    proTeam1Meta.style.display = 'none';
                }
            }
            
            if (proTeam2Meta) {
                if (data.team2.niveau && data.team2.niveau.trim() !== '') {
                    proTeam2Meta.textContent = data.team2.niveau.toUpperCase();
                    proTeam2Meta.style.display = 'block';
                } else {
                    proTeam2Meta.style.display = 'none';
                }
            }
            
            // Gestion de l'affichage des logos selon showLogos
            const showLogos = data.showLogos !== false; // true par défaut
            const proTeam1Logo = document.getElementById('pro-team1-logo');
            const proTeam2Logo = document.getElementById('pro-team2-logo');
            const proTeam1LogoCircle = document.getElementById('pro-team1-logo-circle');
            const proTeam2LogoCircle = document.getElementById('pro-team2-logo-circle');
            
            // Masquer/afficher les cercles de logos selon showLogos
            if (proTeam1LogoCircle) {
                proTeam1LogoCircle.style.display = showLogos ? 'flex' : 'none';
            }
            if (proTeam2LogoCircle) {
                proTeam2LogoCircle.style.display = showLogos ? 'flex' : 'none';
            }
            
            // Mettre à jour les logos des équipes (seulement si showLogos est true)
            if (showLogos) {
                if (proTeam1Logo && data.team1.logo) {
                    proTeam1Logo.src = data.team1.logo + '?t=' + Date.now(); // Cache busting
                    proTeam1Logo.onerror = function() {
                        this.style.display = 'none';
                        if (proTeam1LogoCircle) proTeam1LogoCircle.style.display = 'none';
                    };
                    proTeam1Logo.onload = function() {
                        this.style.display = 'block';
                        if (proTeam1LogoCircle) proTeam1LogoCircle.style.display = 'flex';
                    };
                    proTeam1Logo.style.display = 'block';
                    if (proTeam1LogoCircle) proTeam1LogoCircle.style.display = 'flex';
                }
                
                if (proTeam2Logo && data.team2.logo) {
                    proTeam2Logo.src = data.team2.logo + '?t=' + Date.now(); // Cache busting
                    proTeam2Logo.onerror = function() {
                        this.style.display = 'none';
                        if (proTeam2LogoCircle) proTeam2LogoCircle.style.display = 'none';
                    };
                    proTeam2Logo.onload = function() {
                        this.style.display = 'block';
                        if (proTeam2LogoCircle) proTeam2LogoCircle.style.display = 'flex';
                    };
                    proTeam2Logo.style.display = 'block';
                    if (proTeam2LogoCircle) proTeam2LogoCircle.style.display = 'flex';
                }
            } else {
                // Masquer les logos si showLogos est false
                if (proTeam1Logo) proTeam1Logo.style.display = 'none';
                if (proTeam2Logo) proTeam2Logo.style.display = 'none';
            }
            
            // Mettre à jour les scores (SCORE column)
            const proTeam1Score = document.getElementById('pro-team1-score');
            const proTeam2Score = document.getElementById('pro-team2-score');
            if (proTeam1Score) proTeam1Score.textContent = data.team1.score;
            if (proTeam2Score) proTeam2Score.textContent = data.team2.score;
            
            // Mettre à jour les sets gagnés (SET column)
            // Compter les sets gagnés pour chaque équipe
            let team1SetsWon = 0;
            let team2SetsWon = 0;
            for (let i = 0; i < data.maxSets; i++) {
                const score1 = data.team1.sets[i] || 0;
                const score2 = data.team2.sets[i] || 0;
                if (score1 > 0 || score2 > 0) {
                    if (score1 > score2) {
                        team1SetsWon++;
                    } else if (score2 > score1) {
                        team2SetsWon++;
                    }
                }
            }
            
            const proTeam1Set = document.getElementById('pro-team1-set');
            const proTeam2Set = document.getElementById('pro-team2-set');
            if (proTeam1Set) proTeam1Set.textContent = team1SetsWon;
            if (proTeam2Set) proTeam2Set.textContent = team2SetsWon;
        }

        // Écouter les changements
        function handleScoreChange() {
            updateDisplay();
        }

        // NOUVELLE MÉTHODE : Lire depuis le serveur local (si disponible) ou fichier JSON
        let fileData = null;
        async function loadScoreDataFromFile() {
            try {
                // Essayer d'abord le serveur local (localhost)
                let url = 'data/score-data.json';
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    url = '/data/score-data.json'; // Serveur local
                }
                
                const response = await fetch(url + '?t=' + Date.now());
                if (response.ok) {
                    fileData = await response.json();
                    window.scoreDataFromFile = fileData;
                    // Si le fichier est plus récent que localStorage, utiliser le fichier
                    const localData = LCVBScoreboard.getScoreData();
                    if (fileData.lastUpdate > (localData.lastUpdate || 0)) {
                        // Mettre à jour localStorage depuis le fichier
                        localStorage.setItem('lcvb_score', JSON.stringify(fileData));
                        lastDataHash = ''; // Force la mise à jour
                    }
                }
            } catch(e) {
                // Ignore si le fichier n'existe pas ou erreur de lecture
            }
        }
        
        // Charger le fichier JSON périodiquement
        loadScoreDataFromFile(); // Chargement initial
        setInterval(loadScoreDataFromFile, 300); // Recharger toutes les 300ms (plus rapide avec serveur)

        // Mise à jour initiale
        updateDisplay();

        // Surveiller les changements de localStorage
        // Polling très fréquent pour OBS Browser Source (toutes les 33ms = ~30 FPS)
        setInterval(() => {
            try {
                const data = LCVBScoreboard.getScoreData();
                const currentUpdateTime = data.lastUpdate || 0;
                const currentVersion = data.version || 0;
                const currentSaveCount = data._saveCount || 0;
                
                // TOUJOURS comparer le hash complet (plus fiable pour OBS)
                const currentHash = JSON.stringify(data);
                const hasChanged = (
                    currentUpdateTime !== lastUpdateTime || 
                    currentVersion !== lastVersion || 
                    currentSaveCount !== lastSaveCount ||
                    currentHash !== lastDataHash
                );
                
                if (hasChanged) {
                    updateDisplay();
                }
            } catch(e) {
                console.error('Erreur lors de la mise à jour:', e);
                // En cas d'erreur, forcer quand même une mise à jour
                updateDisplay();
            }
        }, 33); // ~30 FPS pour réactivité maximale dans OBS
        
        // Pour les changements depuis une autre fenêtre/onglet (événement storage)
        window.addEventListener('storage', (e) => {
            if (e.key === 'lcvb_score') {
                // Réinitialiser tous les trackers pour forcer la mise à jour
                lastDataHash = '';
                lastUpdateTime = 0;
                lastVersion = 0;
                lastSaveCount = 0;
                lastUniqueId = '';
                updateDisplay();
            }
        });
        
        // Écouter les événements personnalisés (si disponibles dans le même contexte)
        window.addEventListener('lcvb_score_update', (e) => {
            if (e.detail) {
                // Réinitialiser tous les trackers pour forcer la mise à jour
                lastDataHash = '';
                lastUpdateTime = 0;
                lastVersion = 0;
                lastSaveCount = 0;
                lastUniqueId = '';
                updateDisplay();
            }
        });
        
        // Fallback : forcer une vérification complète périodiquement
        // (très utile pour OBS qui peut avoir des problèmes de synchronisation localStorage)
        setInterval(() => {
            // TOUJOURS forcer une vérification complète pour OBS
            const data = LCVBScoreboard.getScoreData();
            const currentHash = JSON.stringify(data);
            // Si le hash a changé, mettre à jour même si les trackers n'ont pas changé
            if (currentHash !== lastDataHash) {
                lastDataHash = '';
                updateDisplay();
            }
        }, 200); // Vérification complète toutes les 200ms (plus agressif pour OBS)
    </script>
</body>
</html>
